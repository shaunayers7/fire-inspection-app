import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from "firebase/app";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "firebase/firestore";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";

const DEVICE_TYPES = ["Manual Pull", "Heat Detector", "Smoke Detector", "Horn/Strobe", "Bell", "Flow Switch", "Tamper"];
const PROTECTED_SECTIONS = ['checklist', 'control', 'devices', 'battery', 'lights'];

const getNewBuildingTemplate = (name = "New Building") => ({
  id: `b-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
  name: name,
  details: {
    buildingName: name, address: "", city: "", panelLocation: "",
    manufacturer: "", panelModel: "", serialNumber: "", softwareVersion: "",
    dateManufactured: "", lastServiceDate: ""
  },
  sections: [
    { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
    { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
    { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
    { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
    { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false }
  ],
  data: {
    checklist: Array(5).fill(0).map((_, i) => ({ id: `ck${i}-${Date.now()}`, label: `Checklist Item ${i + 1}`, status: 'pending', note: '', photo: null, fixed: false })),
    control: Array(7).fill(0).map((_, i) => ({ id: `c${i}-${Date.now()}`, label: `Control Point ${i + 1}`, status: 'pending', note: '', photo: null, fixed: false })),
    devices: Array(28).fill(0).map((_, i) => ({ id: `d${i}-${Date.now()}`, deviceNo: (i + 1).toString(), label: `Device ${i + 1}`, type: 'Smoke Detector', status: 'pending', note: '', photo: null, fixed: false })),
    battery: Array(7).fill(0).map((_, i) => ({ id: `b${i}-${Date.now()}`, label: `Battery Metric ${i + 1}`, status: 'pending', note: '', photo: null, fixed: false })),
    lights: Array(5).fill(0).map((_, i) => ({ id: `e${i}-${Date.now()}`, label: `Emergency Light ${i + 1}`, status: 'pending', note: '', photo: null, fixed: false })),
    customDeficiencies: []
  }
});

const Modal = ({ title, children, onConfirm, onCancel, confirmText = "Confirm", cancelText = "Cancel", isDanger = false, hideButtons = false }) => (
  <div className="fixed inset-0 z-[200] flex items-center justify-center p-6">
    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onCancel}></div>
    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 overflow-hidden">
      <div className="p-6">
        <h3 className="text-lg font-black uppercase text-gray-800 mb-4">{title}</h3>
        {children}
        {!hideButtons && (
          <div className="flex gap-3 mt-6">
            <button onClick={onCancel} className="flex-1 py-3 px-4 bg-gray-100 text-gray-500 font-bold rounded-xl text-xs uppercase tracking-widest">{cancelText}</button>
            <button onClick={onConfirm} className={`flex-1 py-3 px-4 ${isDanger ? 'bg-red-500' : 'bg-blue-600'} text-white font-bold rounded-xl text-xs uppercase tracking-widest`}>{confirmText}</button>
          </div>
        )}
      </div>
    </div>
  </div>
);

const TriStateButton = ({ status, onToggle }) => {
  const handleClick = (e) => {
    e.stopPropagation();
    if (status === 'pending') onToggle('passed');
    else if (status === 'passed') onToggle('failed');
    else onToggle('pending');
  };
  const baseClass = "w-10 h-10 rounded-xl flex items-center justify-center shadow-sm shrink-0 transition-all active:scale-95";
  if (status === 'passed') return <button onClick={handleClick} className={`${baseClass} bg-green-500 text-white font-bold`}>✓</button>;
  if (status === 'failed') return <button onClick={handleClick} className={`${baseClass} bg-red-500 text-white font-bold`}>✕</button>;
  return <button onClick={handleClick} className={`${baseClass} bg-gray-200 text-gray-400`}>○</button>;
};

const InspectionRow = ({ item, index, onUpdateMeta, onDelete, isDevice = false, isDeficiencyView = false, onTriggerModal }) => {
  const [localDraft, setLocalDraft] = useState(null);
  const [isEditingNote, setIsEditingNote] = useState(false);
  const fileInputRef = useRef(null);

  const startEdit = () => setLocalDraft({ ...item });
  const saveEdit = () => { onUpdateMeta(localDraft); setLocalDraft(null); };
  const cancelEdit = () => {
    onTriggerModal({
      title: "Discard Changes?",
      onConfirm: () => setLocalDraft(null)
    });
  };
  const activeItem = localDraft || item;

  return (
    <div className={`bg-white border-b border-gray-100 p-4 ${item.fixed && isDeficiencyView ? 'bg-green-50/20' : ''}`}>
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 space-y-2">
          <div className="flex items-start gap-2">
            <span className="text-[10px] font-black text-gray-300 mt-1">{index}.</span>
            <div className="flex-1 space-y-1">
              <input
                value={activeItem.label}
                onFocus={startEdit}
                onChange={(e) => setLocalDraft({ ...activeItem, label: e.target.value })}
                className={`w-full text-sm font-bold bg-transparent border-b transition-colors ${localDraft ? 'border-blue-400 bg-blue-50' : 'border-transparent'} ${item.fixed && isDeficiencyView ? 'line-through text-gray-400' : 'text-gray-800'}`}
              />
              {isDevice && (
                <div className="flex gap-2">
                  <input value={activeItem.deviceNo} onFocus={startEdit} onChange={(e) => setLocalDraft({ ...activeItem, deviceNo: e.target.value })} className="w-12 bg-gray-100 rounded px-1 text-[10px] font-black" />
                  <select value={activeItem.type} onFocus={startEdit} onChange={(e) => setLocalDraft({ ...activeItem, type: e.target.value })} className="text-[10px] font-bold text-gray-400 uppercase bg-gray-50 px-1 rounded">
                    {DEVICE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>
              )}
            </div>
          </div>

          {localDraft ? (
            <div className="flex gap-2 pl-6">
              <button onClick={saveEdit} className="text-[10px] bg-blue-600 text-white px-3 py-1 rounded font-bold uppercase">Save</button>
              <button onClick={cancelEdit} className="text-[10px] bg-gray-100 text-gray-400 px-3 py-1 rounded font-bold uppercase">Cancel</button>
            </div>
          ) : (
            <div className="flex flex-wrap gap-4 pl-6 text-[10px] font-bold text-gray-400 uppercase">
              <button onClick={() => setIsEditingNote(!isEditingNote)}>Note</button>
              <button onClick={() => fileInputRef.current.click()}>Media</button>
              {isDeficiencyView && (
                <div className="flex items-center gap-1">
                  <input
                    type="checkbox"
                    checked={item.fixed || false}
                    onChange={(e) => onUpdateMeta({ fixed: e.target.checked, dateFixed: e.target.checked ? new Date().toLocaleDateString() : null })}
                  />
                  <span className={item.fixed ? "text-green-600" : "text-orange-500"}>Fixed?</span>
                </div>
              )}
              {onDelete && <button onClick={() => onTriggerModal({ title: "Delete Item?", isDanger: true, onConfirm: onDelete })} className="text-red-300 ml-auto">Delete</button>}
              <input type="file" ref={fileInputRef} className="hidden" accept="image/*,video/*" onChange={(e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => onUpdateMeta({ photo: reader.result, mediaType: file.type.startsWith('video') ? 'video' : 'image' });
                  reader.readAsDataURL(file);
                }
              }} />
            </div>
          )}
          {(isEditingNote || item.note) && (
            <textarea value={item.note} onChange={(e) => onUpdateMeta({ note: e.target.value })} className="w-full mt-2 p-2 text-xs bg-gray-50 rounded border border-gray-100" placeholder="Notes..." />
          )}
        </div>
        {!isDeficiencyView && <TriStateButton status={item.status} onToggle={(s) => onUpdateMeta({ status: s, fixed: false })} />}
      </div>
    </div>
  );
};

export default function App() {
  const [view, setView] = useState('year-select');
  const [selectedYear, setSelectedYear] = useState(2025);
  const [selectedBuildingId, setSelectedBuildingId] = useState(null);
  const [expandedSections, setExpandedSections] = useState({});
  const [activeModal, setActiveModal] = useState(null);
  const [yearInputValue, setYearInputValue] = useState("");
  const [user, setUser] = useState(null);
  const [isSyncing, setIsSyncing] = useState(false);
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  const [yearData, setYearData] = useState(() => {
    const saved = localStorage.getItem('fire_inspect_cloud_v4');
    return saved ? JSON.parse(saved) : { 2025: [] };
  });

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'fire-inspect-app-v4';
  const firebaseConfig = JSON.parse(__firebase_config);

  useEffect(() => {
    const handleStatus = () => setIsOnline(navigator.onLine);
    window.addEventListener('online', handleStatus);
    window.addEventListener('offline', handleStatus);
    return () => {
      window.removeEventListener('online', handleStatus);
      window.removeEventListener('offline', handleStatus);
    };
  }, []);

  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubAuth = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) {
        // Correct path following RULE 1: /artifacts/{appId}/public/data/{collectionName}/{docId}
        const syncDoc = doc(db, 'artifacts', appId, 'public', 'data', 'reports', 'master-report');
        const unsubSnap = onSnapshot(syncDoc, (snapshot) => {
          if (snapshot.exists()) {
            const cloudData = snapshot.data().years;
            setYearData(prev => {
              const merged = { ...prev, ...cloudData };
              localStorage.setItem('fire_inspect_cloud_v4', JSON.stringify(merged));
              return merged;
            });
          }
        }, (err) => console.error("Sync Error", err));
        return () => unsubSnap();
      }
    });
    return () => unsubAuth();
  }, [appId]);

  const saveAll = useCallback(async (newData) => {
    setYearData(newData);
    localStorage.setItem('fire_inspect_cloud_v4', JSON.stringify(newData));

    if (user && isOnline) {
      setIsSyncing(true);
      try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Correct path following RULE 1
        const syncDoc = doc(db, 'artifacts', appId, 'public', 'data', 'reports', 'master-report');
        await setDoc(syncDoc, { 
          years: newData, 
          lastUpdated: Date.now(), 
          updatedBy: user.uid 
        }, { merge: true });
      } catch (e) {
        console.error("Cloud push failed", e);
      } finally {
        setIsSyncing(false);
      }
    }
  }, [user, isOnline, appId]);

  const activeBuilding = (yearData[selectedYear] || []).find(b => b.id === selectedBuildingId);

  const getBuildingStatus = (building) => {
    let pending = 0;
    let unfixed = 0;
    let totalDefs = 0;
    Object.keys(building.data).forEach(key => {
      if (Array.isArray(building.data[key])) {
        building.data[key].forEach(item => {
          if (item.status === 'pending') pending++;
          if (item.status === 'failed') {
            totalDefs++;
            if (!item.fixed) unfixed++;
          }
        });
      }
    });
    if (pending === 0 && unfixed === 0) return { text: 'Complete', class: 'text-green-500' };
    if (pending === 0) return { text: `Inspected ${totalDefs}`, class: 'text-blue-500' };
    return { text: 'In Progress', class: 'text-orange-400' };
  };

  const updateItem = (sect, id, meta) => {
    const newData = {
      ...yearData,
      [selectedYear]: yearData[selectedYear].map(b => b.id === selectedBuildingId ? {
        ...b, data: { ...b.data, [sect]: b.data[sect].map(i => i.id === id ? { ...i, ...meta } : i) }
      } : b)
    };
    saveAll(newData);
  };

  if (view === 'year-select') return (
    <div className="p-4 space-y-4 bg-[#F2F2F7] min-h-screen">
      <div className="flex justify-between items-center">
        <h1 className="text-xl font-black uppercase tracking-tighter text-gray-800">Annual Inspections</h1>
        <div className="flex items-center gap-2">
          <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`}></div>
          <span className="text-[10px] font-bold uppercase text-gray-400">{isSyncing ? 'Syncing...' : (isOnline ? 'Online' : 'Offline')}</span>
        </div>
      </div>
      {Object.keys(yearData).sort().reverse().map(year => (
        <div key={year} onClick={() => { setSelectedYear(year); setView('building-select'); }} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:bg-gray-50">
          <span className="font-bold text-lg text-gray-700">Year {year}</span>
          <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">{yearData[year].length} Buildings</span>
        </div>
      ))}
      <button onClick={() => setActiveModal({ type: 'input', title: 'Add New Year', onConfirm: (val) => { if (val && !yearData[val]) saveAll({ ...yearData, [val]: [] }); setActiveModal(null); } })} className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add Year</button>
      {activeModal?.type === 'input' && (
        <Modal title={activeModal.title} onCancel={() => setActiveModal(null)} onConfirm={() => activeModal.onConfirm(yearInputValue)}>
          <input type="number" autoFocus value={yearInputValue} onChange={(e) => setYearInputValue(e.target.value)} className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl text-center text-xl font-bold" />
        </Modal>
      )}
    </div>
  );

  if (view === 'building-select') return (
    <div className="p-4 space-y-4 bg-[#F2F2F7] min-h-screen">
      <div className="flex items-center gap-2">
        <button onClick={() => setView('year-select')} className="text-blue-600 font-bold p-1">←</button>
        <h1 className="text-xl font-black uppercase">Buildings {selectedYear}</h1>
      </div>
      {yearData[selectedYear].map(b => {
        const status = getBuildingStatus(b);
        return (
          <div key={b.id} onClick={() => { setSelectedBuildingId(b.id); setView('form'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer">
            <div>
              <h3 className="font-bold text-gray-800">{b.name}</h3>
              <span className={`text-[10px] font-black uppercase tracking-wide ${status.class}`}>{status.text}</span>
            </div>
            <button onClick={(e) => { e.stopPropagation(); setActiveModal({ type: 'confirm', title: 'Delete Building?', isDanger: true, onConfirm: () => { const newData = { ...yearData, [selectedYear]: yearData[selectedYear].filter(x => x.id !== b.id) }; saveAll(newData); setActiveModal(null); } }); }} className="text-red-200 p-2 text-xl">✕</button>
          </div>
        );
      })}
      <button onClick={() => { const newData = { ...yearData, [selectedYear]: [...yearData[selectedYear], getNewBuildingTemplate(`New Building ${yearData[selectedYear].length + 1}`)] }; saveAll(newData); }} className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add Building</button>
      {activeModal?.type === 'confirm' && <Modal title={activeModal.title} isDanger={activeModal.isDanger} onCancel={() => setActiveModal(null)} onConfirm={activeModal.onConfirm} />}
    </div>
  );

  const allDeficiencies = [];
  if (activeBuilding) {
    activeBuilding.sections.forEach(s => {
      activeBuilding.data[s.id].forEach(i => { if (i.status === 'failed') allDeficiencies.push({ ...i, section: s.id }); });
    });
  }

  return (
    <div className="pb-44 bg-[#F2F2F7] min-h-screen">
      <div className="bg-white p-4 sticky top-0 border-b flex justify-between items-center z-50">
        <button onClick={() => setView('building-select')} className="text-blue-600 font-bold px-2 py-1">← Save</button>
        <h2 className="font-black uppercase text-xs tracking-tight text-gray-600 truncate max-w-[40%]">{activeBuilding.name}</h2>
        <div className="flex items-center gap-2">
          {isSyncing && <div className="w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>}
          <button className="bg-gray-50 p-2 rounded-lg text-blue-600 font-black text-[10px] uppercase border">Export</button>
        </div>
      </div>

      <div className="p-4 space-y-3">
        {/* Section 1: Details */}
        <div className="rounded-xl border bg-white overflow-hidden shadow-sm">
          <button onClick={() => setExpandedSections(p => ({ ...p, details: !p.details }))} className="w-full bg-blue-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
            <span>1. Building Details</span>
            <span>{expandedSections['details'] ? '−' : '+'}</span>
          </button>
          {expandedSections['details'] && (
            <div className="p-4 grid grid-cols-1 gap-4">
              {Object.keys(activeBuilding.details).map(k => (
                <div key={k} className="space-y-1">
                  <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest">{k.replace(/([A-Z])/g, ' $1')}</label>
                  <input value={activeBuilding.details[k]} onChange={(e) => {
                    const newData = { ...yearData };
                    const b = newData[selectedYear].find(x => x.id === selectedBuildingId);
                    b.details[k] = e.target.value;
                    if (k === 'buildingName') b.name = e.target.value;
                    saveAll(newData);
                  }} className="w-full border-b border-gray-100 py-1 font-semibold text-gray-700 focus:border-blue-500" />
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Dynamic Sections */}
        {activeBuilding.sections.map((s, idx) => (
          <div key={s.id} className="rounded-xl border bg-white overflow-hidden shadow-sm">
            <div className={`w-full ${s.color} text-white p-3 flex justify-between items-center`}>
              <button onClick={() => setExpandedSections(p => ({ ...p, [s.id]: !p[s.id] }))} className="flex-1 text-left font-bold text-xs uppercase">
                {idx + 2}. {s.title}
              </button>
              <button onClick={() => setExpandedSections(p => ({ ...p, [s.id]: !p[s.id] }))}>{expandedSections[s.id] ? '−' : '+'}</button>
            </div>
            {expandedSections[s.id] && (
              <div>
                {activeBuilding.data[s.id]?.map((item, i) => (
                  <InspectionRow key={item.id} index={i + 1} item={item} isDevice={s.isDev} onUpdateMeta={(m) => updateItem(s.id, item.id, m)} onTriggerModal={setActiveModal} onDelete={() => {
                    const newData = { ...yearData };
                    const b = newData[selectedYear].find(x => x.id === selectedBuildingId);
                    b.data[s.id] = b.data[s.id].filter(x => x.id !== item.id);
                    saveAll(newData);
                    setActiveModal(null);
                  }} />
                ))}
                <button onClick={() => {
                  const newData = { ...yearData };
                  const b = newData[selectedYear].find(x => x.id === selectedBuildingId);
                  b.data[s.id].push({ id: Date.now(), label: "New Item", status: "pending", note: "", photo: null, fixed: false });
                  saveAll(newData);
                }} className="w-full p-3 text-[10px] font-black text-gray-300 uppercase">+ Add Item</button>
              </div>
            )}
          </div>
        ))}

        {/* Deficiency Section */}
        <div className="rounded-xl border border-red-200 bg-white overflow-hidden shadow-sm">
          <button onClick={() => setExpandedSections(p => ({ ...p, defs: !p.defs }))} className="w-full bg-red-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
            <span>{activeBuilding.sections.length + 2}. Deficiencies</span>
            <span className="bg-white/20 px-2 rounded-md text-[10px]">{allDeficiencies.length + (activeBuilding.data.customDeficiencies?.length || 0)}</span>
          </button>
          {expandedSections['defs'] && (
            <div>
              {allDeficiencies.map((item, i) => (
                <InspectionRow key={item.id} index={i + 1} item={item} isDeficiencyView onUpdateMeta={(m) => updateItem(item.section, item.id, m)} onTriggerModal={setActiveModal} />
              ))}
              {(activeBuilding.data.customDeficiencies || []).map((item, i) => (
                <InspectionRow key={item.id} index={allDeficiencies.length + i + 1} item={item} isDeficiencyView onTriggerModal={setActiveModal} onUpdateMeta={(m) => {
                  const newData = { ...yearData };
                  const b = newData[selectedYear].find(x => x.id === selectedBuildingId);
                  b.data.customDeficiencies = b.data.customDeficiencies.map(x => x.id === item.id ? { ...x, ...m } : x);
                  saveAll(newData);
                }} onDelete={() => {
                  const newData = { ...yearData };
                  const b = newData[selectedYear].find(x => x.id === selectedBuildingId);
                  b.data.customDeficiencies = b.data.customDeficiencies.filter(x => x.id !== item.id);
                  saveAll(newData);
                  setActiveModal(null);
                }} />
              ))}
              <button onClick={() => {
                const newData = { ...yearData };
                const b = newData[selectedYear].find(x => x.id === selectedBuildingId);
                if (!b.data.customDeficiencies) b.data.customDeficiencies = [];
                b.data.customDeficiencies.push({ id: Date.now(), label: "Deficiency", status: "failed", note: "", photo: null, fixed: false });
                saveAll(newData);
              }} className="w-full p-3 text-[10px] font-black text-red-200 uppercase">+ Add Deficiency</button>
            </div>
          )}
        </div>
      </div>

      <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t flex flex-col gap-2 z-50">
        <button onClick={() => setView('building-select')} className="w-full bg-green-500 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg">Save & Exit</button>
      </div>

      {activeModal && <Modal title={activeModal.title} isDanger={activeModal.isDanger} onCancel={() => setActiveModal(null)} onConfirm={activeModal.onConfirm} />}
    </div>
  );
}
