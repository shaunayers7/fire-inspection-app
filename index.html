<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover, shrink-to-fit=no">
    
    <!-- Force viewport scale immediately -->
    <script>
        (function() {
            // Force reset viewport scale on load
            function resetViewport() {
                const viewport = document.querySelector('meta[name=viewport]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover, shrink-to-fit=no');
                }
                // Force zoom to 1
                if (document.body) {
                    document.body.style.zoom = 1;
                }
            }
            
            // Run immediately
            resetViewport();
            
            // Run on DOMContentLoaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', resetViewport);
            }
            
            // Run on page show (handles back/forward cache)
            window.addEventListener('pageshow', resetViewport);
            
            // Reset on orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(resetViewport, 100);
            });
            
            // Reset on resize
            window.addEventListener('resize', function() {
                resetViewport();
            });
        })();
    </script>
    
    <title>Fire Inspection App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Annual fire alarm and emergency light inspection management system">
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fire Inspect">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Cache Control: Prevent aggressive caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        
        window.FirebaseSDK = { 
            initializeApp, 
            getFirestore, 
            doc, 
            setDoc,
            getDoc,
            deleteDoc,
            collection, 
            getDocs, 
            addDoc,
            serverTimestamp,
            onSnapshot,
            query,
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut,
            updateProfile
        };
    </script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration for fire-inspection-app
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyBTKxOrANuORfE4H8AiHECc-Ty46Hqrk9g",
            authDomain: "fire-inspection-app-9c13f.firebaseapp.com",
            projectId: "fire-inspection-app-9c13f",
            storageBucket: "fire-inspection-app-9c13f.firebasestorage.app",
            messagingSenderId: "423281715493",
            appId: "1:423281715493:web:f1e66ea9f9f9fb980b92cc"
        });
        
        // Optional: Set a custom app ID (defaults to 'fire-inspect-default')
        // window.__app_id = 'my-custom-app-id';
    </script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F2F2F7; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            user-select: none;
            /* iOS smooth scrolling */
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        /* Prevent zoom on all elements */
        *, *::before, *::after {
            touch-action: manipulation !important;
        }
        
        /* Dark Mode Styles */
        body.dark-mode { background-color: #1a1a1a; }
        .dark-mode .bg-white { background-color: #2d2d2d !important; }
        .dark-mode .bg-gray-100 { background-color: #1a1a1a !important; }
        .dark-mode .bg-gray-50 { background-color: #2a2a2a !important; }
        .dark-mode .text-gray-800 { color: #e0e0e0 !important; }
        .dark-mode .text-gray-700 { color: #d0d0d0 !important; }
        .dark-mode .text-gray-600 { color: #b0b0b0 !important; }
        .dark-mode .text-gray-500 { color: #909090 !important; }
        .dark-mode .text-gray-400 { color: #707070 !important; }
        .dark-mode .text-gray-300 { color: #606060 !important; }
        .dark-mode .border-gray-100 { border-color: #3a3a3a !important; }
        .dark-mode .border-gray-200 { border-color: #4a4a4a !important; }
        .dark-mode input, .dark-mode select, .dark-mode textarea { 
            background-color: #2a2a2a !important; 
            color: #e0e0e0 !important;
            border-color: #4a4a4a !important;
        }
        .dark-mode input:focus, .dark-mode select:focus, .dark-mode textarea:focus { 
            background-color: #333 !important; 
        }
        
        #root {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* iOS momentum scrolling for all scrollable areas */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        input, select, textarea { 
            font-size: 16px !important; 
            user-select: text;
            -webkit-user-select: text;
        }
        @media (min-width: 640px) {
            input, select, textarea { font-size: 14px !important; }
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            background-color: #F9FAFB;
        }
        
        /* Long-press Drag Animations - only block touch when actively dragging */
        .draggable-item {
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation; /* Prevent zoom while allowing drag */
        }
        .is-dragging {
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            z-index: 99;
            opacity: 0.9;
            touch-action: none; /* Only block touch when actively dragging */
        }
        .drag-placeholder {
            border: 2px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 0.75rem;
        }
        
        /* Pull-to-Refresh iOS Style */
        .pull-to-refresh-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-60px);
            transition: transform 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .pull-to-refresh-indicator.visible {
            transform: translateY(0);
        }
        
        .pull-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Prevent zoom on iOS Safari and Brave Mobile -->
    <script>
        // Aggressive zoom prevention for mobile browsers
        (function() {
            // Force zoom to 1 on the document
            function forceZoomReset() {
                if (document.body) {
                    document.body.style.zoom = 1;
                }
                if (document.documentElement) {
                    document.documentElement.style.zoom = 1;
                }
                
                // Also check visual viewport API (modern browsers)
                if (window.visualViewport) {
                    const scale = window.visualViewport.scale;
                    if (scale !== 1) {
                        // Force a viewport reset
                        const viewport = document.querySelector('meta[name=viewport]');
                        if (viewport) {
                            const content = viewport.getAttribute('content');
                            viewport.setAttribute('content', 'width=1px');
                            setTimeout(() => viewport.setAttribute('content', content), 1);
                        }
                    }
                }
            }
            
            // Run on various events
            window.addEventListener('load', forceZoomReset);
            window.addEventListener('resize', forceZoomReset);
            
            // Monitor visualViewport for scale changes
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', forceZoomReset);
                window.visualViewport.addEventListener('scroll', forceZoomReset);
            }
        })();
        
        // Prevent pinch-to-zoom
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
            document.body.style.zoom = 1;
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
            document.body.style.zoom = 1;
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
            document.body.style.zoom = 1;
        });
        
        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Additional prevention for wheel zoom (desktop/trackpad)
        document.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Prevent zoom via keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=')) {
                e.preventDefault();
            }
        });
    </script>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // App version for cache busting - UPDATE THIS WHEN YOU MAKE CHANGES!
        const APP_VERSION = '2.5.1'; // Updated: Feb 15, 2026 - Mobile responsive fixes (iPhone/iPad overflow fix)
        const VERSION_CHECK_KEY = 'fire_inspection_app_version';
        const THEME_KEY = 'fire_inspection_theme';
        const DRAFT_KEY = 'fire_inspection_drafts';
        
        const DEVICE_TYPES = ["Manual Pull", "Heat Detector", "Smoke Detector", "Horn/Strobe", "Bell", "Flow Switch", "Tamper"];
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'fire-inspect-default';

        // Permanent Core Sections IDs
        const PROTECTED_SECTIONS = ['inspectionDetails', 'checklist', 'control', 'devices', 'battery', 'lights'];

        const getNewBuildingTemplate = (name = "New Building", address = "", city = "", initialStatus = 'pending') => ({
            id: `b-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: name,
            lastSynced: null,
            inspectionDetails: {
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD format
                time: new Date().toTimeString().split(' ')[0].substring(0, 5), // HH:MM format
                inspector: ""
            },
            details: {
                buildingName: name, address: address, city: city, panelLocation: "",
                manufacturer: "", panelModel: "", serialNumber: "", softwareVersion: "",
                dateManufactured: "", lastServiceDate: ""
            },
            sections: [
                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false }
            ],
            data: {
                checklist: [
                    { id: `ck0-${Date.now()}`, label: 'Building occupants informed of test', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `ck1-${Date.now()}`, label: 'Time established to test signal devices', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `ck2-${Date.now()}`, label: 'Access to locked doors', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `ck3-${Date.now()}`, label: 'Alternate plan made to alert of actual fire', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `ck4-${Date.now()}`, label: 'System placed on test with monitoring', status: initialStatus, note: '', photo: null, fixed: false }
                ],
                control: [
                    { id: `c0-${Date.now()}`, label: 'Power on indicator', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c1-${Date.now()}`, label: 'Common trouble indicator', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c2-${Date.now()}`, label: 'Common trouble signal', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c3-${Date.now()}`, label: 'A/C power failure trouble', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c4-${Date.now()}`, label: 'Ground detection lamp', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c5-${Date.now()}`, label: 'Ground detection signal', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c6-${Date.now()}`, label: 'General alarm', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c7-${Date.now()}`, label: 'Alarm silence', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c8-${Date.now()}`, label: 'Alarm silence lamp', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c9-${Date.now()}`, label: 'Alarm silence inhibit', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c10-${Date.now()}`, label: 'Alarm initiation individually circuit tested', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c11-${Date.now()}`, label: 'Alarm lamp operation', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c12-${Date.now()}`, label: 'Alarm lamp designation checked', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c13-${Date.now()}`, label: 'All audible alarm signals operated on A/C', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c14-${Date.now()}`, label: 'Glass and doors clean', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c15-${Date.now()}`, label: 'Panel condition and keys', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `c16-${Date.now()}`, label: 'Signal check with salt lake', status: initialStatus, note: '', photo: null, fixed: false }
                ],
                devices: Array(28).fill(0).map((_, i) => ({ id: `d${i}-${Date.now()}`, deviceNo: (i+1).toString(), label: `Device ${i+1}`, type: 'Smoke Detector', status: initialStatus, note: '', photo: null, fixed: false })),
                battery: [
                    { id: `b0-${Date.now()}`, label: 'Battery AC on', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b1-${Date.now()}`, label: 'Battery AC off', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b2-${Date.now()}`, label: 'Battery under load', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b3-${Date.now()}`, label: 'Battery clean tight terminals', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b4-${Date.now()}`, label: 'Battery type', status: initialStatus, note: '', photo: null, fixed: false }
                ],
                lights: Array(5).fill(0).map((_, i) => ({ id: `e${i}-${Date.now()}`, label: `Emergency Light ${i+1}`, status: initialStatus, note: '', photo: null, fixed: false })),
                customDeficiencies: []
            }
        });

        // --- HOOK: Long Press Drag & Drop ---
        const useDragAndDrop = (items, onReorder) => {
            const [draggingId, setDraggingId] = useState(null);
            const timerRef = useRef(null);
            const touchStartPos = useRef({ x: 0, y: 0 });
            const hasMoved = useRef(false);
            
            const onTouchStart = (id) => (e) => {
                // Record start position
                touchStartPos.current = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY
                };
                hasMoved.current = false;
                
                // Start long-press timer (1.5 seconds)
                timerRef.current = setTimeout(() => {
                    // Only activate drag if user hasn't scrolled
                    if (!hasMoved.current) {
                        setDraggingId(id);
                        if (window.navigator.vibrate) window.navigator.vibrate(50);
                    }
                }, 1500);
            };

            const onTouchMove = (id) => (e) => {
                // Check if user is scrolling (moved more than 10px)
                if (!draggingId && timerRef.current) {
                    const deltaX = Math.abs(e.touches[0].clientX - touchStartPos.current.x);
                    const deltaY = Math.abs(e.touches[0].clientY - touchStartPos.current.y);
                    
                    if (deltaY > 10 || deltaX > 10) {
                        // User is scrolling, cancel drag
                        hasMoved.current = true;
                        clearTimeout(timerRef.current);
                        timerRef.current = null;
                        return;
                    }
                }
                
                // If actively dragging, handle reorder
                if (draggingId) {
                    e.preventDefault(); // Only prevent default when actively dragging
                    const touch = e.touches[0];
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    const targetId = element?.closest('[data-drag-id]')?.getAttribute('data-drag-id');
                    
                    if (targetId && targetId !== draggingId) {
                        const fromIndex = items.findIndex(i => i.id === draggingId);
                        const toIndex = items.findIndex(i => i.id === targetId);
                        if (fromIndex !== -1 && toIndex !== -1) {
                            onReorder(fromIndex, toIndex);
                        }
                    }
                }
            };

            const onTouchEnd = () => {
                if (timerRef.current) clearTimeout(timerRef.current);
                timerRef.current = null;
                setDraggingId(null);
                hasMoved.current = false;
            };

            return { draggingId, onTouchStart, onTouchEnd, onTouchMove };
        };

        const Modal = ({ title, children, onConfirm, onCancel, confirmText = "Confirm", cancelText = "Cancel", isDanger = false, hideButtons = false }) => {
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [keyboardHeight, setKeyboardHeight] = React.useState(0);
            const modalRef = React.useRef(null);
            
            // Lock body scroll when modal is open and preserve scroll position
            React.useEffect(() => {
                const scrollY = window.scrollY || window.pageYOffset;
                const body = document.body;
                
                // Save original styles
                const originalPosition = body.style.position;
                const originalTop = body.style.top;
                const originalWidth = body.style.width;
                const originalOverflow = body.style.overflow;
                
                // Lock scroll at current position
                body.style.position = 'fixed';
                body.style.top = `-${scrollY}px`;
                body.style.width = '100%';
                body.style.overflow = 'hidden';
                
                // Restore on unmount
                return () => {
                    body.style.position = originalPosition;
                    body.style.top = originalTop;
                    body.style.width = originalWidth;
                    body.style.overflow = originalOverflow;
                    
                    // Restore scroll position
                    window.scrollTo(0, scrollY);
                };
            }, []);
            
            // Handle keyboard appearance for better mobile UX
            React.useEffect(() => {
                // Only run on mobile devices
                if (!window.visualViewport) return;
                
                const handleViewportChange = () => {
                    // Calculate keyboard height (viewport shrinks when keyboard appears)
                    const viewportHeight = window.visualViewport.height;
                    const windowHeight = window.innerHeight;
                    const kbHeight = Math.max(0, windowHeight - viewportHeight);
                    
                    setKeyboardHeight(kbHeight);
                };
                
                window.visualViewport.addEventListener('resize', handleViewportChange);
                window.visualViewport.addEventListener('scroll', handleViewportChange);
                
                return () => {
                    window.visualViewport.removeEventListener('resize', handleViewportChange);
                    window.visualViewport.removeEventListener('scroll', handleViewportChange);
                };
            }, []);
            
            const handleConfirm = async () => {
                if (isProcessing) return;
                setIsProcessing(true);
                try {
                    await onConfirm();
                } catch (error) {
                    console.error('Modal confirm error:', error);
                } finally {
                    setIsProcessing(false);
                }
            };
            
            // Adjust modal position when keyboard is visible
            const modalStyle = keyboardHeight > 0 ? {
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                margin: 0,
                paddingBottom: `${keyboardHeight}px`,
                alignItems: 'flex-start',
                paddingTop: '20px'
            } : {
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                margin: 0
            };
            
            return (
                <div 
                    ref={modalRef}
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4" 
                    style={modalStyle}
                >
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={isProcessing ? undefined : onCancel}></div>
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 overflow-hidden animate-in fade-in zoom-in duration-200" style={{ maxHeight: keyboardHeight > 0 ? `calc(100vh - ${keyboardHeight + 40}px)` : '90vh', overflowY: 'auto' }}>
                        <div className="p-6">
                            <h3 className="text-lg font-black uppercase text-gray-800 mb-4">{title}</h3>
                            {children}
                            {!hideButtons && (
                                <div className="flex gap-3 mt-6">
                                    <button onClick={onCancel} disabled={isProcessing} className={`flex-1 py-4 px-4 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm uppercase tracking-wider ${isProcessing ? 'opacity-50' : 'hover:bg-gray-200 active:scale-95'} transition-all`}>{cancelText}</button>
                                    <button onClick={handleConfirm} disabled={isProcessing} className={`flex-1 py-4 px-4 ${isDanger ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold rounded-xl text-sm uppercase tracking-wider ${isProcessing ? 'opacity-50' : 'active:scale-95'} transition-all`}>
                                        {isProcessing ? '...' : confirmText}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const TriStateButton = ({ status, onToggle }) => {
            const handleClick = (e) => {
                e.stopPropagation();
                if (status === 'pending') onToggle('passed');
                else if (status === 'passed') onToggle('failed');
                else if (status === 'failed') onToggle('n/a');
                else onToggle('pending');
            };
            const baseClass = "w-10 h-10 rounded-xl flex items-center justify-center shadow-sm shrink-0 transition-all active:scale-95";
            if (status === 'passed') return <button onClick={handleClick} className={`${baseClass} bg-green-500 text-white font-bold`}>‚úì</button>;
            if (status === 'failed') return <button onClick={handleClick} className={`${baseClass} bg-red-500 text-white font-bold`}>‚úï</button>;
            if (status === 'n/a') return <button onClick={handleClick} className={`${baseClass} bg-gray-400 text-white font-bold text-[10px]`}>N/A</button>;
            return <button onClick={handleClick} className={`${baseClass} bg-gray-200 text-gray-400`}>‚óã</button>;
        };

        const InspectionRow = ({ item, index, onUpdateMeta, onDelete, isDevice = false, isDeficiencyView = false, onTriggerModal, isDragging, dragHandlers }) => {
            const [localDraft, setLocalDraft] = useState(null);
            const [isEditingNote, setIsEditingNote] = useState(false);
            const fileInputRef = useRef(null);
            const draftTimerRef = useRef(null);

            // Restore draft on component mount
            useEffect(() => {
                try {
                    const drafts = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
                    if (drafts[item.id]) {
                        console.log('üìù Restoring draft for item:', item.label);
                        setLocalDraft(drafts[item.id]);
                    }
                } catch (e) {
                    console.error('Error restoring draft:', e);
                }
            }, []);

            // Auto-save draft to localStorage (debounced)
            useEffect(() => {
                if (localDraft) {
                    // Clear existing timer
                    if (draftTimerRef.current) {
                        clearTimeout(draftTimerRef.current);
                    }

                    // Save draft after 500ms of inactivity
                    draftTimerRef.current = setTimeout(() => {
                        try {
                            const drafts = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
                            drafts[item.id] = localDraft;
                            localStorage.setItem(DRAFT_KEY, JSON.stringify(drafts));
                            console.log('üíæ Auto-saved draft for:', item.label);
                        } catch (e) {
                            console.error('Error saving draft:', e);
                        }
                    }, 500);
                }

                return () => {
                    if (draftTimerRef.current) {
                        clearTimeout(draftTimerRef.current);
                    }
                };
            }, [localDraft]);

            const startEdit = () => setLocalDraft({ ...item });
            
            const saveEdit = () => { 
                onUpdateMeta(localDraft); 
                setLocalDraft(null);
                // Clear draft from localStorage
                try {
                    const drafts = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
                    delete drafts[item.id];
                    localStorage.setItem(DRAFT_KEY, JSON.stringify(drafts));
                    console.log('üóëÔ∏è Cleared draft for:', item.label);
                } catch (e) {
                    console.error('Error clearing draft:', e);
                }
            };
            
            const cancelEdit = () => { 
                onTriggerModal({
                    title: "Discard Changes?",
                    type: 'confirm',
                    onConfirm: () => { 
                        setLocalDraft(null);
                        // Clear draft from localStorage
                        try {
                            const drafts = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
                            delete drafts[item.id];
                            localStorage.setItem(DRAFT_KEY, JSON.stringify(drafts));
                            console.log('üóëÔ∏è Cleared draft for:', item.label);
                        } catch (e) {
                            console.error('Error clearing draft:', e);
                        }
                    }
                });
            };
            const activeItem = localDraft || item;

            return (
                <div 
                    data-drag-id={item.id}
                    {...dragHandlers}
                    className={`bg-white border-b border-gray-100 p-4 draggable-item ${isDragging ? 'is-dragging' : ''} ${item.fixed && isDeficiencyView ? 'bg-green-50/20' : ''}`}
                >
                    <div className="flex items-start justify-between gap-4">
                        <div className="flex-1 space-y-2">
                            <div className="flex items-start gap-2">
                                <span className="text-[10px] font-black text-gray-300 mt-1">{index}.</span>
                                <div className="flex-1 space-y-1">
                                    <input 
                                        value={activeItem.label} 
                                        onFocus={startEdit}
                                        onChange={(e) => setLocalDraft({...activeItem, label: e.target.value})}
                                        className={`w-full text-sm font-bold bg-transparent border-b transition-colors ${localDraft ? 'border-blue-400 bg-blue-50' : 'border-transparent'} ${item.fixed && isDeficiencyView ? 'line-through text-gray-400' : 'text-gray-800'}`}
                                    />
                                    {isDevice && (
                                        <div className="flex gap-2">
                                            <input value={activeItem.deviceNo} onFocus={startEdit} onChange={(e) => setLocalDraft({...activeItem, deviceNo: e.target.value})} className="w-12 bg-gray-100 rounded px-1 text-[10px] font-black" />
                                            <select value={activeItem.type} onFocus={startEdit} onChange={(e) => setLocalDraft({...activeItem, type: e.target.value})} className="text-[10px] font-bold text-gray-400 uppercase bg-gray-50 px-1 rounded">
                                                {DEVICE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                            </select>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {localDraft ? (
                                <div className="flex gap-2 pl-6 items-center">
                                    <button onClick={saveEdit} className="text-[10px] bg-blue-600 text-white px-3 py-1 rounded font-bold uppercase shadow-sm">Save</button>
                                    <button onClick={cancelEdit} className="text-[10px] bg-gray-100 text-gray-400 px-3 py-1 rounded font-bold uppercase">Cancel</button>
                                    <span className="text-[9px] text-gray-400 italic" title="Changes are auto-saved">üíæ Draft saved</span>
                                </div>
                            ) : (
                                <div className="flex flex-wrap gap-4 pl-6 text-[10px] font-bold text-gray-400 uppercase">
                                    <button onClick={() => setIsEditingNote(!isEditingNote)} className="hover:text-blue-500">Note</button>
                                    <button onClick={() => fileInputRef.current.click()} className="hover:text-blue-500">Media</button>
                                    {isDeficiencyView && (
                                        <div className="flex items-center gap-1 ml-2">
                                            <input 
                                                type="checkbox" 
                                                checked={item.fixed || false} 
                                                onChange={(e) => onUpdateMeta({ fixed: e.target.checked, dateFixed: e.target.checked ? new Date().toLocaleDateString() : null })}
                                                className="w-3 h-3 accent-green-600"
                                            />
                                            <span className={item.fixed ? "text-green-600" : "text-orange-500"}>
                                                {item.fixed ? `Fixed: ${item.dateFixed}` : "Fixed?"}
                                            </span>
                                        </div>
                                    )}
                                    {onDelete && <button onClick={() => {
                                        onTriggerModal({
                                            title: "Delete Item?",
                                            type: 'confirm',
                                            isDanger: true,
                                            onConfirm: onDelete
                                        });
                                    }} className="text-red-300 ml-auto">Delete</button>}
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*,video/*" onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onloadend = () => onUpdateMeta({ photo: reader.result, mediaType: file.type.startsWith('video') ? 'video' : 'image' });
                                            reader.readAsDataURL(file);
                                        }
                                    }} />
                                </div>
                            )}
                            {(isEditingNote || item.note) && (
                                <textarea 
                                    value={item.note} 
                                    onChange={(e) => onUpdateMeta({ note: e.target.value })}
                                    className="w-full mt-2 p-2 text-xs bg-gray-50 rounded border border-gray-100"
                                    placeholder="Add notes..."
                                />
                            )}
                            {item.photo && (
                                <div className="mt-2 relative group w-24 h-24">
                                    {item.mediaType === 'video' ? (
                                        <video src={item.photo} className="w-full h-full object-cover rounded-lg border border-gray-200" />
                                    ) : (
                                        <img src={item.photo} className="w-full h-full object-cover rounded-lg border border-gray-200" />
                                    )}
                                    <button onClick={() => onUpdateMeta({ photo: null, mediaType: null })} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold">√ó</button>
                                </div>
                            )}
                        </div>
                        {!isDeficiencyView && <TriStateButton status={item.status} onToggle={(s) => onUpdateMeta({ status: s, fixed: false, dateFixed: null })} />}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('login'); // Start with login
            const [selectedYear, setSelectedYear] = useState(2026);
            const [selectedBuildingId, setSelectedBuildingId] = useState(null);
            const [expandedSections, setExpandedSections] = useState({});
            const [activeModal, setActiveModal] = useState(null);
            const [yearInputValue, setYearInputValue] = useState("");
            const [copyTargetYear, setCopyTargetYear] = useState("");
            const [buildingToCopy, setBuildingToCopy] = useState(null);
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, success, error
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const isUpdatingFromSync = useRef(false); // Track if update is from sync to prevent loop
            const [syncConflicts, setSyncConflicts] = useState(null); // Tracks conflicts during sync for resolution UI
            const [authInitialized, setAuthInitialized] = useState(false);
            const [loginEmail, setLoginEmail] = useState('');
            const [loginPassword, setLoginPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [loginName, setLoginName] = useState('');
            const [isSignup, setIsSignup] = useState(false);
            const [authError, setAuthError] = useState('');
            const [allowedEmails, setAllowedEmails] = useState([]);
            const [adminEmails, setAdminEmails] = useState([]);
            const [newEmail, setNewEmail] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const viewRef = useRef('login');
            const [isLoadingData, setIsLoadingData] = useState(true);
            const [realtimeSyncActive, setRealtimeSyncActive] = useState(false);
            const realtimeUnsubscribe = useRef(null);
            const [showUpdatePrompt, setShowUpdatePrompt] = useState(false);
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem(THEME_KEY);
                return saved ? saved === 'dark' : false;
            });
            
            // Lazy loading state - show 20 buildings initially, load more on demand
            const [buildingsToShow, setBuildingsToShow] = useState(20);
            
            // Pull-to-refresh state
            const [pullDistance, setPullDistance] = useState(0);
            const [isPulling, setIsPulling] = useState(false);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const pullStartY = useRef(0);
            const pullThreshold = 80; // Distance needed to trigger refresh
            
            // Share app state
            const [linkCopied, setLinkCopied] = useState(false);
            
            const [yearData, setYearData] = useState(() => {
                // Version check: Detect if user has old cached code
                const storedVersion = localStorage.getItem(VERSION_CHECK_KEY);
                
                // CRITICAL iOS FIX: Force reload if version mismatch detected
                if (storedVersion && storedVersion !== APP_VERSION) {
                    console.log(`üîÑ App updated from v${storedVersion} to v${APP_VERSION}`);
                    console.log('üîÑ Forcing page reload to clear iOS cache...');
                    localStorage.setItem(VERSION_CHECK_KEY, APP_VERSION);
                    
                    // Force hard reload on iOS
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1000);
                    
                    // Return empty data during transition
                    return { 2025: [], 2026: [] };
                }
                
                // First time or same version - proceed normally
                localStorage.setItem(VERSION_CHECK_KEY, APP_VERSION);
                
                const saved = localStorage.getItem('fire_inspection_v4_data');
                const isFirstLoad = !saved; // Track if this is the very first load
                
                // Default 2026 buildings data
                const default2026Buildings = [
                        {
                            id: "b-2026-bellevue",
                            name: "Bellevue",
                            lastSynced: null,
                            inspectionDetails: {
                                date: "",
                                time: "",
                                inspector: ""
                            },
                            details: {
                                buildingName: "Bellevue",
                                address: "21701 28 ave Bellevue",
                                city: "Bellevue",
                                panelLocation: "Mech rm by gym",
                                manufacturer: "Edwards",
                                panelModel: "2280",
                                serialNumber: "N/A",
                                softwareVersion: "Monitored fire watch 411",
                                dateManufactured: "N/A",
                                lastServiceDate: "N/A"
                            },
                            sections: [
                                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false },
                                { id: 'custom-signal', title: 'Signal Check', color: 'bg-gray-500', isDev: false }
                            ],
                            data: {
                                checklist: [
                                    { id: "ck1-2026-bellevue", label: "Building occupants informed of test", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck2-2026-bellevue", label: "Time established to test signal devices", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck3-2026-bellevue", label: "Access to locked doors", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck4-2026-bellevue", label: "Alternate plan made to alert of actual fire", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck5-2026-bellevue", label: "System placed on test with monitoring", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                control: [
                                    { id: "c1-2026-bellevue", label: "Power on indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c2-2026-bellevue", label: "Common trouble indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c3-2026-bellevue", label: "Common trouble signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c4-2026-bellevue", label: "A/C power failure trouble", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c5-2026-bellevue", label: "Ground detection lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c6-2026-bellevue", label: "Ground detection signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c7-2026-bellevue", label: "General alarm", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c8-2026-bellevue", label: "Alarm silence", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c9-2026-bellevue", label: "Alarm silence lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c10-2026-bellevue", label: "Alarm silence inhibit", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c11-2026-bellevue", label: "Alarm initiation individually circuit tested", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c12-2026-bellevue", label: "Alarm lamp operation", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c13-2026-bellevue", label: "Alarm lamp designation checked", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c14-2026-bellevue", label: "All audible alarm signals operated on A/C", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c15-2026-bellevue", label: "Glass and doors clean", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c16-2026-bellevue", label: "Panel condition and keys", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                devices: [
                                    { id: "d1-2026-bellevue", deviceNo: "1", label: "Mech room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d2-2026-bellevue", deviceNo: "2", label: "South gym", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d3-2026-bellevue", deviceNo: "3", label: "South chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d4-2026-bellevue", deviceNo: "4", label: "North chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d5-2026-bellevue", deviceNo: "5", label: "Sacrament prep", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d6-2026-bellevue", deviceNo: "6", label: "Sound room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d7-2026-bellevue", deviceNo: "7", label: "West door main entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d8-2026-bellevue", deviceNo: "8", label: "East exit", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d9-2026-bellevue", deviceNo: "9", label: "Kitchen", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d10-2026-bellevue", deviceNo: "10", label: "Multi purpose room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d11-2026-bellevue", deviceNo: "11", label: "Member custodial", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d12-2026-bellevue", deviceNo: "12", label: "Storage room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d13-2026-bellevue", deviceNo: "13", label: "Furnace room off storage rm", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d14-2026-bellevue", deviceNo: "14", label: "Gym", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d15-2026-bellevue", deviceNo: "15", label: "Chapel", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d16-2026-bellevue", deviceNo: "16", label: "East hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d17-2026-bellevue", deviceNo: "17", label: "Multi purpose room", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                battery: [
                                    { id: "b1-2026-bellevue", label: "Battery AC on", status: "passed", note: "31.2v dc", photo: null, fixed: false },
                                    { id: "b2-2026-bellevue", label: "Battery AC off", status: "failed", note: "20.2 v dc", photo: null, fixed: false },
                                    { id: "b3-2026-bellevue", label: "Battery under load", status: "failed", note: "V dc", photo: null, fixed: false },
                                    { id: "b4-2026-bellevue", label: "Battery clean tight terminals", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "b5-2026-bellevue", label: "Battery type", status: "passed", note: "12v 7AH", photo: null, fixed: false }
                                ],
                                lights: [
                                    { id: "e1-2026-bellevue", label: "Emergency Light 1", status: "passed", note: "Storage room - Panel B-34\nMain entry double head\nEast hall double head\nMulti purpose double head", photo: null, fixed: false },
                                    { id: "e2-2026-bellevue", label: "Emergency Light 2", status: "failed", note: "North entrance - 1x 6v\nPanel B-10\nDouble head in multi purpose rm", photo: null, fixed: false },
                                    { id: "e3-2026-bellevue", label: "Emergency Light 3", status: "passed", note: "Battery pack - Panel B-34\nDouble head x3 chapel", photo: null, fixed: false },
                                    { id: "e4-2026-bellevue", label: "Exit combo gym south", status: "passed", note: "Panel B-34", photo: null, fixed: false },
                                    { id: "e5-2026-bellevue", label: "Exit signs", status: "passed", note: "Main entrance, East exit, North exit\nMulti north/south\nGym south/north\nChapel south/north west/north south", photo: null, fixed: false }
                                ],
                                "custom-signal": [
                                    { id: "cs1-2026-bellevue", label: "Signal check with salt lake", status: "failed", note: "No account found on SLC monitoring", photo: null, fixed: false }
                                ],
                                customDeficiencies: [
                                    { id: "cd1-2026-bellevue", label: "Battery AC off voltage low", status: "failed", note: "20.2 v dc - requires replacement", photo: null, fixed: false },
                                    { id: "cd2-2026-bellevue", label: "Battery under load not tested", status: "failed", note: "Unable to complete load test", photo: null, fixed: false },
                                    { id: "cd3-2026-bellevue", label: "Emergency Light 2 - North entrance", status: "failed", note: "1x 6v battery needs replacement", photo: null, fixed: false },
                                    { id: "cd4-2026-bellevue", label: "Monitoring signal not established", status: "failed", note: "No account found on SLC monitoring", photo: null, fixed: false }
                                ]
                            }
                        },
                        {
                            id: "b-2026-pincher-creek",
                            name: "Pincher Creek",
                            lastSynced: null,
                            inspectionDetails: {
                                date: "",
                                time: "",
                                inspector: ""
                            },
                            details: {
                                buildingName: "Pincher Creek",
                                address: "1240 Wentworth ave",
                                city: "Pincher Creek",
                                panelLocation: "Front door",
                                manufacturer: "Edwards",
                                panelModel: "Fire shield plus",
                                serialNumber: "N/A",
                                softwareVersion: "Not monitored",
                                dateManufactured: "N/A",
                                lastServiceDate: "N/A"
                            },
                            sections: [
                                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false },
                                { id: 'custom-monitoring', title: 'Signal Test', color: 'bg-gray-500', isDev: false }
                            ],
                            data: {
                                checklist: [
                                    { id: "ck1-2026-pincher", label: "Building occupants informed of test", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck2-2026-pincher", label: "Time established to test signal devices", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck3-2026-pincher", label: "Access to locked doors gained", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck4-2026-pincher", label: "Alternate plan made to alert of actual fire", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck5-2026-pincher", label: "System placed on test with monitoring", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                control: [
                                    { id: "c1-2026-pincher", label: "Power on indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c2-2026-pincher", label: "Common trouble indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c3-2026-pincher", label: "Common trouble signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c4-2026-pincher", label: "A/C power failure trouble", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c5-2026-pincher", label: "Ground fault detection lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c6-2026-pincher", label: "Ground fault detection signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c7-2026-pincher", label: "General alarm", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c8-2026-pincher", label: "Alarm silence", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c9-2026-pincher", label: "Alarm silence lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c10-2026-pincher", label: "Alarm silence inhibit", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c11-2026-pincher", label: "Alarm initiation individually circuit tested", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c12-2026-pincher", label: "Alarm lamp operation", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c13-2026-pincher", label: "Alarm lamp designation checked", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c14-2026-pincher", label: "All audible alarm signals operated on A/C", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c15-2026-pincher", label: "Glass and doors clean", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c16-2026-pincher", label: "Panel condition and keys", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                devices: [
                                    { id: "d1-2026-pincher", deviceNo: "1", label: "NE entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d2-2026-pincher", deviceNo: "2", label: "SE hall", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d3-2026-pincher", deviceNo: "3", label: "SW entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d4-2026-pincher", deviceNo: "4", label: "Gym W", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d5-2026-pincher", deviceNo: "5", label: "Nw entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d6-2026-pincher", deviceNo: "6", label: "NNE entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d7-2026-pincher", deviceNo: "7", label: "N Chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d8-2026-pincher", deviceNo: "8", label: "S chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d9-2026-pincher", deviceNo: "9", label: "Men's bathroom rm D", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d10-2026-pincher", deviceNo: "10", label: "Men's bathroom rmD", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d11-2026-pincher", deviceNo: "11", label: "Kitchen", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d12-2026-pincher", deviceNo: "12", label: "Rm 105", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d13-2026-pincher", deviceNo: "13", label: "S 106", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d14-2026-pincher", deviceNo: "14", label: "S 101", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d15-2026-pincher", deviceNo: "15", label: "South Hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d16-2026-pincher", deviceNo: "16", label: "Gym South", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d17-2026-pincher", deviceNo: "17", label: "North West Hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d18-2026-pincher", deviceNo: "18", label: "North Hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d19-2026-pincher", deviceNo: "19", label: "Chapel North", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                battery: [
                                    { id: "b1-2026-pincher", label: "A/C power on", status: "passed", note: "27.6v dc", photo: null, fixed: false },
                                    { id: "b2-2026-pincher", label: "A/C off", status: "passed", note: "26.6 v dc", photo: null, fixed: false },
                                    { id: "b3-2026-pincher", label: "Full load A/C off", status: "passed", note: "25.1", photo: null, fixed: false },
                                    { id: "b4-2026-pincher", label: "Battery clean tight terminals", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "b5-2026-pincher", label: "Battery type", status: "passed", note: "12v dc 8AH", photo: null, fixed: false }
                                ],
                                lights: [
                                    { id: "e1-2026-pincher", label: "EM 1 mech rm C", status: "failed", note: "Panel C-16 12v 7.2Ah", photo: null, fixed: false },
                                    { id: "e2-2026-pincher", label: "EM 2", status: "passed", note: "Panel C -16", photo: null, fixed: false },
                                    { id: "e3-2026-pincher", label: "EM 3", status: "failed", note: "Panel C -16 6v 5 ah", photo: null, fixed: false },
                                    { id: "e4-2026-pincher", label: "EM 4", status: "passed", note: "Panel R -8", photo: null, fixed: false },
                                    { id: "e5-2026-pincher", label: "EM 5", status: "passed", note: "Panel R -4", photo: null, fixed: false },
                                    { id: "e6-2026-pincher", label: "EM 6 member custodial rm", status: "failed", note: "Panel A -9 1-6v 5 AH", photo: null, fixed: false },
                                    { id: "e7-2026-pincher", label: "EM 7 mech rm A", status: "passed", note: "Panel N -1", photo: null, fixed: false },
                                    { id: "e8-2026-pincher", label: "Exit signs", status: "passed", note: "SW exit, SE exit, S Hall, NE exit, Gym NE, NW exit, N hall, NNE exit, Chapel E, Chapel W, Over flow S", photo: null, fixed: false }
                                ],
                                "custom-monitoring": [
                                    { id: "cm1-2026-pincher", label: "Signal test", status: "passed", note: "SLC monitoring no account", photo: null, fixed: false }
                                ],
                                customDeficiencies: [
                                    { id: "cd1-2026-pincher", label: "EM 1 mech rm C - Battery replacement needed", status: "failed", note: "Panel C-16 12v 7.2Ah", photo: null, fixed: false },
                                    { id: "cd2-2026-pincher", label: "EM 3 - Battery replacement needed", status: "failed", note: "Panel C -16 6v 5 ah", photo: null, fixed: false },
                                    { id: "cd3-2026-pincher", label: "EM 6 member custodial rm - Battery replacement needed", status: "failed", note: "Panel A -9 1-6v 5 AH", photo: null, fixed: false }
                                ]
                            }
                        }
                ];
                
                // CRITICAL: Cloud is source of truth for multi-user sync
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    
                    // Ensure 2026 exists
                    if (!parsedData[2026]) {
                        parsedData[2026] = [];
                    }
                    
                    // MIGRATION: Ensure all buildings have inspectionDetails field (backward compatibility)
                    Object.keys(parsedData).forEach(year => {
                        parsedData[year] = parsedData[year].map(building => {
                            if (!building.inspectionDetails) {
                                return {
                                    ...building,
                                    inspectionDetails: {
                                        date: "",
                                        time: "",
                                        inspector: ""
                                    }
                                };
                            }
                            return building;
                        });
                    });
                    
                    // PROTECTION: Only restore on FIRST load (empty localStorage)
                    // After that, respect cloud data (multi-user collaboration)
                    // Note: isFirstLoad is always false here since saved exists
                    
                    console.log(`‚úÖ Data loaded from localStorage. Buildings in 2026:`, parsedData[2026].map(b => b.name));
                    return parsedData;
                }
                
                // No saved data - FIRST LOAD: Initialize with default buildings
                console.log('üÜï First load detected. Creating fresh data with default buildings.');
                console.log('üìã Protected buildings (Bellevue, Pincher Creek) initialized.');
                return {
                    2025: [],
                    2026: default2026Buildings
                };
            });

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        // Check if Firebase config exists
                        if (typeof window.__firebase_config === 'undefined') {
                            console.warn('‚ö†Ô∏è Firebase not configured. Sync features will be disabled.');
                            console.log('‚ÑπÔ∏è To enable sync, add your Firebase configuration in index.html');
                            return;
                        }

                        const { initializeApp, getFirestore, getAuth, onAuthStateChanged } = window.FirebaseSDK;
                        const config = JSON.parse(window.__firebase_config);
                        
                        // Check if config has placeholder values
                        if (config.apiKey === "YOUR_API_KEY" || !config.apiKey || config.apiKey.length < 10) {
                            console.warn('‚ö†Ô∏è Firebase config contains placeholder values. Please update with your actual Firebase project credentials.');
                            console.log('‚ÑπÔ∏è Get your config from: Firebase Console > Project Settings > Your apps > Web app');
                            return;
                        }
                        
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);
                        window.firebaseAuth = auth; // Make available globally for login
                        
                        // Load allowed emails list
                        const loadAllowedEmails = async () => {
                            try {
                                const { doc, getDoc } = window.FirebaseSDK;
                                const docRef = doc(firestore, `apps/${APP_ID}/settings/allowed_emails`);
                                const docSnap = await getDoc(docRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    setAllowedEmails(data.emails || []);
                                    console.log('üìß Allowed emails loaded:', data.emails?.length || 0);
                                } else {
                                    // First time - set you as admin
                                    console.log('‚ö†Ô∏è No whitelist found. Create one in Settings.');
                                }
                            } catch (error) {
                                console.error('Failed to load allowed emails:', error);
                            }
                        };
                        
                        await loadAllowedEmails();
                        
                        onAuthStateChanged(auth, async (currentUser) => {
                            setUser(currentUser);
                            setAuthInitialized(true);
                            
                            // Sign out anonymous users from old sessions
                            if (currentUser && !currentUser.email) {
                                console.log('‚ö†Ô∏è Anonymous user detected, signing out...');
                                const { signOut } = window.FirebaseSDK;
                                await signOut(auth);
                                return;
                            }
                            
                            // Only allow real users (with email), not anonymous
                            if (currentUser && currentUser.email && firestore) {
                                console.log('‚úÖ Firebase connected successfully');
                                console.log('üë§ User:', currentUser.email || currentUser.displayName);
                                
                                try {
                                    // Check if user is admin (first user or in admin list)
                                    const { doc, getDoc } = window.FirebaseSDK;
                                    const adminDoc = await getDoc(doc(firestore, `apps/${APP_ID}/settings/admins`));
                                    const admins = adminDoc.exists() ? adminDoc.data().emails || [] : [];
                                    
                                    // If no admins exist yet, make this user an admin
                                    if (admins.length === 0) {
                                        console.log('üîß No admins found - making you the first admin');
                                        setIsAdmin(true);
                                    } else {
                                        const userIsAdmin = admins.includes(currentUser.email);
                                        setIsAdmin(userIsAdmin);
                                        console.log(userIsAdmin ? 'üëë You are an admin' : 'üë§ You are a regular user');
                                    }
                                    
                                    // Load cloud data when user is ready
                                    await loadFromCloud(firestore);
                                    
                                    // Data is now loaded
                                    setIsLoadingData(false);
                                    
                                    // Force view change after successful login (fixes iPad white screen)
                                    console.log('‚úÖ Login successful, switching to year-select view');
                                    setView('year-select');
                                    viewRef.current = 'year-select';
                                    
                                    // Force re-render on iPad by triggering a state update
                                    setTimeout(() => {
                                        if (viewRef.current === 'year-select') {
                                            console.log('üì± Confirming view is year-select');
                                        }
                                    }, 100);
                                } catch (error) {
                                    console.error('Error during post-login setup:', error);
                                    // Still show the app even if there's an error
                                    setIsAdmin(true); // Fallback to admin
                                    setView('year-select');
                                    viewRef.current = 'year-select';
                                    setIsLoadingData(false);
                                }
                            } else {
                                // User signed out or anonymous, go back to login
                                if (authInitialized && viewRef.current !== 'login') {
                                    setView('login');
                                    viewRef.current = 'login';
                                }
                                setIsLoadingData(false); // Not loading if no user
                            }
                        });
                    } catch (error) {
                        console.error('‚ùå Firebase initialization failed:', error);
                        console.log('‚ÑπÔ∏è The app will work in local-only mode. Data will be saved to your browser only.');
                    }
                };
                initFirebase();
            }, []);
            
            // Real-time sync with Page Visibility API (battery-friendly)
            useEffect(() => {
                if (!db || !user) return;
                
                const startRealtimeSync = () => {
                    if (realtimeUnsubscribe.current) {
                        console.log('üîÑ Real-time sync already active');
                        return;
                    }
                    
                    try {
                        const { collection, onSnapshot } = window.FirebaseSDK;
                        const buildingsRef = collection(db, `apps/${APP_ID}/buildings`);
                        
                        console.log('üëÇ Real-time sync started (app is visible)');
                        setRealtimeSyncActive(true);
                        
                        realtimeUnsubscribe.current = onSnapshot(buildingsRef, (snapshot) => {
                            // Skip if this is the initial load
                            if (isUpdatingFromSync.current) return;
                            
                            console.log('üîî Real-time update detected from cloud');
                            
                            const cloudBuildings = {};
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                const year = data.year || 2026;
                                if (!cloudBuildings[year]) cloudBuildings[year] = [];
                                cloudBuildings[year].push(data);
                            });
                            
                            // Update local state with cloud changes
                            isUpdatingFromSync.current = true;
                            setYearData(prev => {
                                console.log('üì≤ Applying real-time cloud updates...');
                                const result = { 2025: [], 2026: [], ...cloudBuildings };
                                return result;
                            });
                            
                            // Update sync time
                            const latestSync = snapshot.docs.reduce((latest, doc) => {
                                const syncTime = doc.data().lastSynced;
                                return syncTime && (!latest || syncTime > latest) ? syncTime : latest;
                            }, null);
                            
                            if (latestSync) setLastSyncTime(latestSync);
                            
                            setTimeout(() => {
                                isUpdatingFromSync.current = false;
                            }, 100);
                        }, (error) => {
                            console.error('‚ùå Real-time sync error:', error);
                            setRealtimeSyncActive(false);
                        });
                    } catch (error) {
                        console.error('Failed to start real-time sync:', error);
                        setRealtimeSyncActive(false);
                    }
                };
                
                const stopRealtimeSync = () => {
                    if (realtimeUnsubscribe.current) {
                        console.log('üí§ Real-time sync stopped (app in background)');
                        realtimeUnsubscribe.current();
                        realtimeUnsubscribe.current = null;
                        setRealtimeSyncActive(false);
                    }
                };
                
                // Handle Page Visibility API (battery-friendly)
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        // App went to background - stop listening to save battery
                        stopRealtimeSync();
                    } else {
                        // App came to foreground - start listening
                        startRealtimeSync();
                    }
                };
                
                // Start real-time sync if page is visible
                if (!document.hidden) {
                    startRealtimeSync();
                }
                
                // Listen for visibility changes
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // Cleanup on unmount
                return () => {
                    stopRealtimeSync();
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, [db, user]);
            
            // Version logging and cache detection
            useEffect(() => {
                window.APP_VERSION = APP_VERSION;
                console.log(`üî• Fire Inspection App v${APP_VERSION}`);
                console.log('üì± Device:', navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop');
                console.log('üîÑ Expected log format: emoji-based messages (üîÑ, üóëÔ∏è, ‚ú®, ‚òÅÔ∏è)');
                
                // Check if we have the new sync logic (informational only, no alert)
                const syncFunctionString = syncToCloud.toString();
                const hasNewLogic = syncFunctionString.includes('Starting merge') || syncFunctionString.includes('REMOVING building');
                
                if (!hasNewLogic) {
                    console.warn('‚ö†Ô∏è Old code detection triggered, but this might be a false positive.');
                    console.log('‚úÖ If sync is working properly, you can ignore this warning.');
                } else {
                    console.log('‚úÖ Running latest code with smart deletion sync');
                }

                // Clean up old drafts (older than 7 days)
                try {
                    const drafts = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
                    const draftCount = Object.keys(drafts).length;
                    if (draftCount > 0) {
                        console.log(`üìù Found ${draftCount} draft(s) from previous session`);
                        // Note: Drafts will be restored automatically when editing those items
                        // They'll be cleaned up after 7 days of inactivity (future enhancement)
                    }
                } catch (e) {
                    console.error('Error checking drafts:', e);
                    localStorage.removeItem(DRAFT_KEY); // Clear corrupted draft data
                }
            }, []);

            useEffect(() => {
                // Always save to localStorage for offline capability
                localStorage.setItem('fire_inspection_v4_data', JSON.stringify(yearData));
                
                // Skip auto-sync flag reset (prevents loop)
                if (isUpdatingFromSync.current) {
                    isUpdatingFromSync.current = false;
                    return;
                }
                
                // NO AUTO-SYNC: User must click Save/Back/Sync to push to cloud
                // Data is stored locally and synced only on explicit user action
            }, [yearData]);
            
            // Debug: Monitor view changes
            useEffect(() => {
                console.log('üìç View changed to:', view);
                viewRef.current = view;
            }, [view]);
            
            // Ensure yearData always has required structure
            useEffect(() => {
                if (!yearData || Object.keys(yearData).length === 0) {
                    console.log('‚ö†Ô∏è YearData is empty, initializing with defaults');
                    setYearData({
                        2025: [],
                        2026: []
                    });
                }
            }, []);
            
            // Failsafe: If user is logged in but view is stuck on login, force to year-select
            useEffect(() => {
                if (authInitialized && user && user.email && view === 'login') {
                    console.log('‚ö†Ô∏è User is logged in but view is stuck on login - forcing to year-select');
                    // Immediate fix for iPad white screen issue
                    setView('year-select');
                    viewRef.current = 'year-select';
                    
                    // Double-check after render
                    setTimeout(() => {
                        if (view === 'login' && user && user.email) {
                            console.log('üîÑ Second attempt: Forcing view change');
                            setView('year-select');
                            viewRef.current = 'year-select';
                        }
                    }, 300);
                }
            }, [authInitialized, user, view]);
            
            // Additional failsafe: When data loading completes, ensure view switches
            useEffect(() => {
                if (!isLoadingData && user && user.email && view === 'login') {
                    console.log('üìä Data loaded, switching from login to year-select');
                    setView('year-select');
                    viewRef.current = 'year-select';
                }
            }, [isLoadingData, user, view]);

            // Load admin list when settings view is opened
            useEffect(() => {
                if (view === 'settings' && isAdmin && db) {
                    loadAdminList();
                }
            }, [view, isAdmin, db]);
            
            // Dark mode effect
            useEffect(() => {
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem(THEME_KEY, 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem(THEME_KEY, 'light');
                }
            }, [darkMode]);

            // Reset lazy loading when year changes
            useEffect(() => {
                setBuildingsToShow(20);
            }, [selectedYear]);
            
            // Pull-to-refresh functionality
            useEffect(() => {
                const handleTouchStart = (e) => {
                    // Only enable on year-select and building-select views
                    if (view !== 'year-select' && view !== 'building-select') return;
                    
                    // Check if we're at the top of the scroll container
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    if (scrollTop === 0) {
                        pullStartY.current = e.touches[0].clientY;
                        setIsPulling(true);
                    }
                };
                
                const handleTouchMove = (e) => {
                    if (!isPulling || isRefreshing) return;
                    
                    const currentY = e.touches[0].clientY;
                    const distance = currentY - pullStartY.current;
                    
                    // Only track downward pulls
                    if (distance > 0) {
                        // Prevent native pull-to-refresh in some browsers
                        if (distance > 10) {
                            e.preventDefault();
                        }
                        
                        // Apply diminishing returns for distance (feels more natural)
                        const dampedDistance = Math.min(distance * 0.5, pullThreshold * 1.5);
                        setPullDistance(dampedDistance);
                    }
                };
                
                const handleTouchEnd = async () => {
                    if (!isPulling) return;
                    
                    setIsPulling(false);
                    
                    // Trigger refresh if pulled far enough
                    if (pullDistance >= pullThreshold && !isRefreshing && db && user) {
                        setIsRefreshing(true);
                        console.log('üîÑ Pull-to-refresh triggered');
                        
                        try {
                            // Trigger bidirectional sync
                            await syncBidirectional();
                            console.log('‚úÖ Pull-to-refresh complete');
                        } catch (error) {
                            console.error('‚ùå Pull-to-refresh error:', error);
                        } finally {
                            setTimeout(() => {
                                setIsRefreshing(false);
                                setPullDistance(0);
                            }, 500);
                        }
                    } else {
                        // Reset without refreshing
                        setPullDistance(0);
                    }
                };
                
                // Add event listeners with passive: false to allow preventDefault
                document.addEventListener('touchstart', handleTouchStart, { passive: true });
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd, { passive: true });
                
                return () => {
                    document.removeEventListener('touchstart', handleTouchStart);
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                };
            }, [isPulling, pullDistance, isRefreshing, view, db, user]);

            const activeBuilding = (yearData[selectedYear] || []).find(b => b.id === selectedBuildingId);

            // --- CLOUD SYNC FUNCTIONS ---
            // Manual sync: Bidirectional sync (push local changes, then pull remote changes)
            const syncBidirectional = async () => {
                if (!db || !user) {
                    console.log('Firebase not ready for sync');
                    return;
                }
                
                try {
                    setSyncStatus('syncing');
                    console.log('üîÑ Bidirectional sync started...');
                    
                    // STEP 1: Push local changes to cloud first (so they don't get lost)
                    console.log('üì§ Step 1: Pushing local changes to cloud...');
                    await syncToCloud();
                    
                    // STEP 2: Pull latest from cloud (to get other users' changes)
                    console.log('üì• Step 2: Pulling latest from cloud...');
                    await loadFromCloud(db, true);
                    
                    setSyncStatus('success');
                    console.log('‚úÖ Bidirectional sync complete!');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('error');
                    setTimeout(() => setSyncStatus('idle'), 3000);
                }
            };
            
            // Pull-only sync (for internal use)
            const syncFromCloud = async () => {
                if (!db || !user) {
                    console.log('Firebase not ready for sync');
                    return;
                }
                
                try {
                    setSyncStatus('syncing');
                    console.log('üì• Syncing from cloud...');
                    
                    // Pull from cloud (cloud is source of truth)
                    await loadFromCloud(db, true);
                    
                    setSyncStatus('success');
                    console.log('‚úÖ Sync from cloud complete!');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('error');
                    setTimeout(() => setSyncStatus('idle'), 3000);
                }
            };
            
            // Helper: Save and navigate (triggers immediate sync before navigation)
            const saveAndNavigate = async (targetView) => {
                console.log(`üíæ Navigating to ${targetView} - sync will happen in background...`);
                
                // Navigate immediately for instant UI response
                setView(targetView);
                viewRef.current = targetView;
                
                // Trigger background sync if online (non-blocking - don't await)
                if (db && user) {
                    setSyncStatus('syncing');
                    syncToCloud()
                        .then(() => {
                            console.log(`‚úÖ Background sync complete after navigating to ${targetView}`);
                        })
                        .catch((err) => {
                            console.warn('Background sync failed (changes saved locally):', err);
                            setSyncStatus('error');
                            setTimeout(() => setSyncStatus('idle'), 2000);
                        });
                } else {
                    console.log('üì¥ Offline - changes saved locally only');
                }
            };
            
            // Manual sync: Push local changes to cloud with conflict detection
            const syncToCloud = async () => {
                if (!db || !user) {
                    console.log('Firebase not ready for sync');
                    return;
                }
                
                try {
                    console.log('üì§ Manual sync: Checking for conflicts before pushing...');
                    
                    // STEP 1: Pull latest from cloud
                    const { collection, getDocs, setDoc, doc } = window.FirebaseSDK;
                    const buildingsRef = collection(db, `apps/${APP_ID}/buildings`);
                    const snapshot = await getDocs(buildingsRef);
                    
                    const cloudBuildings = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        cloudBuildings[data.id] = data;
                    });
                    
                    console.log(`üì• Cloud has ${Object.keys(cloudBuildings).length} building(s)`);
                    
                    // STEP 2: Detect conflicts at field level
                    const conflicts = [];
                    const updatedYearData = { ...yearData };
                    
                    for (const year in updatedYearData) {
                        const localBuildings = updatedYearData[year] || [];
                        
                        for (const localBuilding of localBuildings) {
                            const cloudVersion = cloudBuildings[localBuilding.id];
                            
                            // Skip new buildings (no cloud version exists)
                            if (!cloudVersion || !localBuilding.lastSynced) {
                                continue;
                            }
                            
                            // Compare field modifications
                            const localMods = localBuilding.fieldModifications || {};
                            const cloudMods = cloudVersion.fieldModifications || {};
                            
                            // Check each local modification
                            for (const fieldPath in localMods) {
                                const localMod = localMods[fieldPath];
                                const cloudMod = cloudMods[fieldPath];
                                
                                // Conflict: Both local and cloud modified same field
                                if (cloudMod && cloudMod.timestamp > localBuilding.lastSynced) {
                                    // Different values = conflict
                                    const localValue = JSON.stringify(localMod.value || localMod.changes);
                                    const cloudValue = JSON.stringify(cloudMod.value || cloudMod.changes);
                                    
                                    if (localValue !== cloudValue) {
                                        conflicts.push({
                                            buildingId: localBuilding.id,
                                            buildingName: localBuilding.name,
                                            fieldPath,
                                            localValue: localMod.value || localMod.changes,
                                            cloudValue: cloudMod.value || cloudMod.changes,
                                            localUser: localMod.user,
                                            cloudUser: cloudMod.user,
                                            localTime: localMod.timestamp,
                                            cloudTime: cloudMod.timestamp
                                        });
                                    }
                                }
                            }
                        }
                    }
                    
                    // STEP 3: If conflicts exist, show modal and halt sync
                    if (conflicts.length > 0) {
                        console.warn(`‚ö†Ô∏è Found ${conflicts.length} conflict(s) - showing resolution modal`);
                        setSyncConflicts(conflicts);
                        setSyncStatus('error');
                        setTimeout(() => setSyncStatus('idle'), 2000);
                        return; // Don't proceed with sync until conflicts resolved
                    }
                    
                    // STEP 4: No conflicts - merge and push
                    console.log('‚úÖ No conflicts detected - proceeding with sync');
                    
                    // Merge: Keep deletions from cloud, add new from local
                    for (const year in updatedYearData) {
                        const localBuildings = updatedYearData[year] || [];
                        const mergedBuildings = [];
                        
                        for (const localBuilding of localBuildings) {
                            const cloudVersion = cloudBuildings[localBuilding.id];
                            
                            if (cloudVersion) {
                                // Building exists in cloud - use local version (we checked for conflicts)
                                mergedBuildings.push(localBuilding);
                                delete cloudBuildings[localBuilding.id];
                            } else if (!localBuilding.lastSynced) {
                                // New local building - keep it
                                mergedBuildings.push(localBuilding);
                            }
                            // else: was deleted from cloud - don't add
                        }
                        
                        updatedYearData[year] = mergedBuildings;
                    }
                    
                    // Add remaining cloud buildings
                    for (const cloudBuilding of Object.values(cloudBuildings)) {
                        const year = cloudBuilding.year || 2026;
                        if (!updatedYearData[year]) updatedYearData[year] = [];
                        updatedYearData[year].push(cloudBuilding);
                    }
                    
                    // STEP 5: Push to cloud
                    const syncTime = new Date().toISOString();
                    const syncPromises = [];
                    
                    for (const [year, buildings] of Object.entries(updatedYearData)) {
                        for (const building of buildings) {
                            const buildingWithSync = {
                                ...building,
                                lastSynced: syncTime,
                                lastSyncedBy: user?.email || user?.displayName || 'Unknown',
                                lastSyncedById: user?.uid,
                                year: parseInt(year)
                            };
                            const docRef = doc(db, `apps/${APP_ID}/buildings/${building.id}`);
                            syncPromises.push(setDoc(docRef, buildingWithSync));
                        }
                    }
                    
                    await Promise.all(syncPromises);
                    
                    await logChange('sync', { 
                        message: 'Synced changes to cloud', 
                        buildingCount: Object.values(updatedYearData).reduce((sum, buildings) => sum + buildings.length, 0)
                    });
                    
                    setLastSyncTime(syncTime);
                    
                    // Update local state
                    isUpdatingFromSync.current = true;
                    setYearData(updatedYearData);
                    
                    setSyncStatus('success');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                    
                    console.log('‚úÖ Manual sync complete!');
                } catch (error) {
                    console.error('‚ùå Sync error:', error);
                    setSyncStatus('error');
                    setTimeout(() => setSyncStatus('idle'), 3000);
                    throw error;
                }
            };
            const loadFromCloud = async (firestore = db, isDuringSync = false) => {
                if (!firestore) {
                    setIsLoadingData(false);
                    return;
                }
                
                try {
                    const { collection, getDocs } = window.FirebaseSDK;
                    const buildingsRef = collection(firestore, `apps/${APP_ID}/buildings`);
                    const snapshot = await getDocs(buildingsRef);
                    
                    if (snapshot.empty) {
                        console.log('‚òÅÔ∏è No cloud data found. Using local data.');
                        setIsLoadingData(false);
                        return;
                    }
                    
                    const cloudBuildings = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const year = data.year || 2026;
                        
                        // MIGRATION: Ensure building has inspectionDetails field (backward compatibility)
                        const building = !data.inspectionDetails ? {
                            ...data,
                            inspectionDetails: {
                                date: "",
                                time: "",
                                inspector: ""
                            }
                        } : data;
                        
                        if (!cloudBuildings[year]) cloudBuildings[year] = [];
                        cloudBuildings[year].push(building);
                    });
                    
                    console.log(`‚òÅÔ∏è Loaded ${snapshot.size} building(s) from cloud`);
                    Object.entries(cloudBuildings).forEach(([year, buildings]) => {
                        console.log(`  Year ${year}: ${buildings.map(b => `${b.name} (${b.id})`).join(', ')}`);
                    });
                    
                    // ‚òÅÔ∏è CLOUD IS SOURCE OF TRUTH
                    // Manual sync only - conflicts detected before pushing, not when pulling
                    isUpdatingFromSync.current = true;
                    setYearData(prev => {
                        console.log('‚òÅÔ∏è Syncing from cloud (cloud is source of truth)...');
                        console.log(`‚òÅÔ∏è Cloud has ${Object.values(cloudBuildings).flat().length} building(s)`);
                        
                        // Ensure all years exist in structure
                        const result = { 2025: [], 2026: [], ...cloudBuildings };
                        
                        console.log(`‚úÖ Cloud sync complete.`);
                        return result;
                    });
                    
                    const latestSync = snapshot.docs.reduce((latest, doc) => {
                        const syncTime = doc.data().lastSynced;
                        return syncTime && (!latest || syncTime > latest) ? syncTime : latest;
                    }, null);
                    
                    if (latestSync) setLastSyncTime(latestSync);
                    console.log('Loaded from cloud:', cloudBuildings);
                    setIsLoadingData(false);
                } catch (error) {
                    console.error('Load from cloud error:', error);
                    setIsLoadingData(false);
                }
            };

            const deleteFromCloud = async (buildingId) => {
                if (!db || !user) {
                    console.error('‚ùå Firebase not ready for delete - db:', !!db, 'user:', !!user);
                    throw new Error('Firebase not initialized');
                }
                
                try {
                    console.log(`üóëÔ∏è Deleting building ${buildingId} from cloud...`);
                    const { doc: docFn, deleteDoc } = window.FirebaseSDK;
                    const buildingRef = docFn(db, `apps/${APP_ID}/buildings/${buildingId}`);
                    await deleteDoc(buildingRef);
                    console.log(`‚úÖ Building ${buildingId} successfully deleted from cloud`);
                    
                    // Verify deletion by trying to get the document
                    const { getDoc } = window.FirebaseSDK;
                    const verifyDoc = await getDoc(buildingRef);
                    if (verifyDoc.exists()) {
                        console.error(`‚ö†Ô∏è WARNING: Building ${buildingId} still exists in cloud after deletion!`);
                    } else {
                        console.log(`‚úì Verified: Building ${buildingId} no longer exists in cloud`);
                    }
                } catch (error) {
                    console.error(`‚ùå Failed to delete building ${buildingId} from cloud:`, error);
                    throw error;
                }
            };

            // --- CONFLICT RESOLUTION ---
            const resolveConflicts = async (resolutions) => {
                // resolutions is an object: { conflictIndex: 'local' | 'cloud' }
                console.log('üîÄ Resolving conflicts with user choices...');
                
                // Apply conflict resolutions by merging chosen values into yearData
                const updatedYearData = { ...yearData };
                
                syncConflicts.forEach((conflict, index) => {
                    const choice = resolutions[index]; // 'local' or 'cloud'
                    const building = Object.values(updatedYearData).flat().find(b => b.id === conflict.buildingId);
                    
                    if (building && choice) {
                        const chosenValue = choice === 'local' ? conflict.localValue : conflict.cloudValue;
                        
                        // Apply the chosen value to the building
                        // Parse field path (e.g., "details.city" or "data.Exit Lights.item123")
                        const parts = conflict.fieldPath.split('.');
                        if (parts[0] === 'details') {
                            building.details[parts[1]] = chosenValue;
                        } else if (parts[0] === 'name') {
                            building.name = chosenValue;
                        }
                        // For data fields, it's more complex - would need to parse the path
                    }
                });
                
                // Clear conflicts
                setSyncConflicts(null);
                
                // Update local state
                setYearData(updatedYearData);
                
                // Retry sync (will push resolved changes)
                await syncToCloud();
            };

            // --- REORDER LOGIC ---
            const moveSection = (fromIndex, toIndex) => {
                setYearData(prev => {
                    const currentYearBuildings = prev[selectedYear];
                    const bIdx = currentYearBuildings.findIndex(b => b.id === selectedBuildingId);
                    const building = currentYearBuildings[bIdx];
                    const newSections = [...building.sections];
                    const [removed] = newSections.splice(fromIndex, 1);
                    newSections.splice(toIndex, 0, removed);
                    
                    const updatedBuildings = [...currentYearBuildings];
                    updatedBuildings[bIdx] = { ...building, sections: newSections };
                    return { ...prev, [selectedYear]: updatedBuildings };
                });
            };

            const sectionDrag = useDragAndDrop(activeBuilding?.sections || [], moveSection);

            const getBuildingStatus = (building) => {
                if (!building || !building.data) {
                    return { text: 'No Data', class: 'text-gray-400', deficiencyText: '', deficiencyClass: '' };
                }
                let pending = 0;
                let unfixed = 0;
                let totalDefs = 0;
                Object.keys(building.data).forEach(key => {
                    if (Array.isArray(building.data[key])) {
                        building.data[key].forEach(item => {
                            if (item.status === 'pending') pending++;
                            if (item.status === 'failed') {
                                totalDefs++;
                                if (!item.fixed) unfixed++;
                            }
                        });
                    }
                });
                
                // Inspection status (based on whether all items are checked)
                if (pending > 0) {
                    return { 
                        text: 'In Progress', 
                        class: 'text-orange-400',
                        deficiencyText: unfixed > 0 ? `${unfixed} to fix` : '',
                        deficiencyClass: 'text-red-500'
                    };
                }
                
                // All items checked - inspection complete
                if (unfixed === 0) {
                    return { 
                        text: 'Inspection Complete', 
                        class: 'text-green-500',
                        deficiencyText: 'All Clear',
                        deficiencyClass: 'text-green-500'
                    };
                }
                
                // Inspection complete but has deficiencies to fix
                return { 
                    text: 'Inspection Complete', 
                    class: 'text-blue-500',
                    deficiencyText: `${unfixed} Deficiencies to Fix`,
                    deficiencyClass: 'text-red-500'
                };
            };

            const handleExport = async () => {
                if (!activeBuilding) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const statusInfo = getBuildingStatus(activeBuilding);

                let currentY = 20;
                const margin = 14;
                const pageHeight = doc.internal.pageSize.height;

                const checkNewPage = (neededHeight) => {
                    if (currentY + neededHeight > pageHeight - 20) {
                        doc.addPage();
                        currentY = 20;
                        return true;
                    }
                    return false;
                };

                doc.setFontSize(20).setFont("helvetica", "bold").text("FIRE INSPECTION REPORT", 105, currentY, { align: "center" });
                currentY += 10;
                doc.setFontSize(10).setFont("helvetica", "normal").text(`Year: ${selectedYear} | Status: ${statusInfo.text}`, 105, currentY, { align: "center" });
                currentY += 5;
                doc.text(`Building: ${activeBuilding.name}`, 105, currentY, { align: "center" });
                currentY += 15;

                // Section 0: Inspection Details
                doc.setFontSize(14).setFont("helvetica", "bold").text("0. INSPECTION DETAILS", margin, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: [['FIELD', 'INFORMATION']],
                    body: [
                        ['INSPECTION DATE', activeBuilding.inspectionDetails?.date || 'N/A'],
                        ['INSPECTION TIME', activeBuilding.inspectionDetails?.time || 'N/A'],
                        ['INSPECTOR NAME', activeBuilding.inspectionDetails?.inspector || 'N/A']
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [34, 197, 94] }, // Green color
                    styles: { fontSize: 10 },
                    margin: { left: margin, right: margin }
                });

                currentY = doc.lastAutoTable.finalY + 10;
                checkNewPage(20);

                // Section 1: Building Details
                doc.setFontSize(14).setFont("helvetica", "bold").text("1. BUILDING DETAILS", margin, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: [['FIELD', 'INFORMATION']],
                    body: ['buildingName', 'address', 'city', 'panelLocation', 'manufacturer', 'panelModel', 'serialNumber', 'softwareVersion', 'dateManufactured', 'lastServiceDate'].map(k => [k.replace(/([A-Z])/g, ' $1').toUpperCase(), activeBuilding.details[k] || 'N/A']),
                    theme: 'striped',
                    headStyles: { fillColor: [37, 99, 235] },
                    didDrawPage: (data) => { currentY = data.cursor.y + 15; }
                });

                activeBuilding.sections.forEach((s, idx) => {
                    checkNewPage(10);
                    doc.setFontSize(14).setFont("helvetica", "bold").text(`${idx + 2}. ${s.title.toUpperCase()}`, margin, currentY);
                    currentY += 5;

                    const items = activeBuilding.data[s.id];
                    doc.autoTable({
                        startY: currentY,
                        head: [['#', 'DEV #', 'ITEM NAME', 'STATUS', 'NOTES']],
                        body: items.map((item, i) => [i + 1, s.isDev ? item.deviceNo : '-', item.label, item.status.toUpperCase(), item.note || '-']),
                        theme: 'grid',
                        headStyles: { fillColor: [30, 41, 54] },
                        didDrawPage: (data) => { currentY = data.cursor.y + 10; }
                    });
                });

                // Export Deficiencies Section
                const allDeficienciesForExport = [];
                activeBuilding.sections.forEach(s => {
                    activeBuilding.data[s.id].forEach(i => { 
                        if (i.status === 'failed') {
                            allDeficienciesForExport.push({ ...i, section: s.title, deviceNo: s.isDev ? i.deviceNo : '-' }); 
                        }
                    });
                });
                const customDefs = activeBuilding.data.customDeficiencies || [];
                
                if (allDeficienciesForExport.length > 0 || customDefs.length > 0) {
                    checkNewPage(10);
                    doc.setFontSize(14).setFont("helvetica", "bold").text(`${activeBuilding.sections.length + 2}. DEFICIENCIES`, margin, currentY);
                    currentY += 5;

                    const allDeficiencyItems = [
                        ...allDeficienciesForExport.map(item => ({
                            section: item.section,
                            deviceNo: item.deviceNo,
                            label: item.label,
                            note: item.note || '-',
                            fixed: item.fixed ? 'YES' : 'NO'
                        })),
                        ...customDefs.map(item => ({
                            section: 'Custom',
                            deviceNo: '-',
                            label: item.label,
                            note: item.note || '-',
                            fixed: item.fixed ? 'YES' : 'NO'
                        }))
                    ];

                    doc.autoTable({
                        startY: currentY,
                        head: [['#', 'SECTION', 'DEV #', 'ITEM NAME', 'NOTES', 'FIXED']],
                        body: allDeficiencyItems.map((item, i) => [i + 1, item.section.toUpperCase(), item.deviceNo, item.label, item.note, item.fixed]),
                        theme: 'grid',
                        headStyles: { fillColor: [220, 38, 38] },
                        didDrawPage: (data) => { currentY = data.cursor.y + 10; }
                    });
                }

                doc.save(`${activeBuilding.name}_Report_${selectedYear}.pdf`);
            };

            const updateItem = (sect, id, meta) => {
                // Track field modification for conflict detection
                const timestamp = new Date().toISOString();
                const userName = user?.email || user?.displayName || 'Unknown';
                
                // Log the change
                const item = activeBuilding?.data[sect]?.find(i => i.id === id);
                if (item) {
                    logChange('update_item', { 
                        section: sect, 
                        itemLabel: item.label,
                        changes: meta,
                        building: activeBuilding?.name
                    });
                }
                
                setYearData(prev => ({
                    ...prev,
                    [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? {
                        ...b, 
                        data: { ...b.data, [sect]: b.data[sect].map(i => i.id === id ? { ...i, ...meta } : i) },
                        // Track when this field was modified and by whom
                        fieldModifications: {
                            ...(b.fieldModifications || {}),
                            [`data.${sect}.${id}`]: { timestamp, user: userName, changes: meta }
                        }
                    } : b)
                }));
            };

            const updateBuildingDetail = (key, value) => {
                // Track field modification for conflict detection
                const timestamp = new Date().toISOString();
                const userName = user?.email || user?.displayName || 'Unknown';
                
                // Log the change
                logChange('update_building_detail', { 
                    field: key, 
                    newValue: value,
                    building: activeBuilding?.name
                });
                
                setYearData(prev => ({
                    ...prev,
                    [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? {
                        ...(key === 'buildingName' ? { ...b, name: value, details: { ...b.details, [key]: value } } : { ...b, details: { ...b.details, [key]: value } }),
                        // Track when this field was modified and by whom
                        fieldModifications: {
                            ...(b.fieldModifications || {}),
                            [key === 'buildingName' ? 'name' : `details.${key}`]: { timestamp, user: userName, value }
                        }
                    } : b)
                }));
            };

            // --- COPY BUILDING FUNCTION ---
            const copyBuildingToYear = (building, targetYear) => {
                // Create a deep copy of the building with reset statuses
                const resetData = {};
                Object.keys(building.data).forEach(sectionKey => {
                    if (sectionKey === 'customDeficiencies') {
                        // Copy custom deficiencies but mark them as pending/not fixed
                        resetData[sectionKey] = building.data[sectionKey].map(def => ({
                            ...def,
                            status: def.status === 'n/a' ? 'n/a' : 'pending', // Preserve N/A status
                            fixed: false,
                            photo: null // Reset photos for new year
                        }));
                    } else {
                        // Reset all inspection items to pending, but preserve N/A status
                        resetData[sectionKey] = building.data[sectionKey].map(item => ({
                            ...item,
                            status: item.status === 'n/a' ? 'n/a' : 'pending', // Preserve N/A status
                            fixed: false,
                            note: '', // Clear notes for new inspection
                            photo: null // Clear photos
                        }));
                    }
                });

                const copiedBuilding = {
                    ...building,
                    id: `b-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    lastSynced: null,
                    data: resetData
                };

                // Ensure target year exists in yearData
                setYearData(prev => {
                    const updatedData = { ...prev };
                    if (!updatedData[targetYear]) {
                        updatedData[targetYear] = [];
                    }
                    updatedData[targetYear] = [...updatedData[targetYear], copiedBuilding];
                    return updatedData;
                });

                console.log(`‚úÖ Copied "${building.name}" from ${selectedYear} to ${targetYear}`);
                
                // Log the change
                logChange('copy_building', {
                    buildingName: building.name,
                    fromYear: selectedYear,
                    toYear: targetYear
                });
            };

            // --- AUTHENTICATION FUNCTIONS ---
            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    const emailLower = loginEmail.toLowerCase().trim();
                    
                    // Check if email is allowed
                    if (allowedEmails.length > 0 && !allowedEmails.includes(emailLower)) {
                        console.error('‚ùå Access denied for:', emailLower);
                        console.log('Allowed emails:', allowedEmails);
                        setAuthError('üö´ Access Denied: Your email is not authorized. Contact your administrator.');
                        return;
                    }
                    
                    const { signInWithEmailAndPassword } = window.FirebaseSDK;
                    await signInWithEmailAndPassword(window.firebaseAuth, emailLower, loginPassword);
                    console.log('‚úÖ Login successful');
                } catch (error) {
                    console.error('‚ùå Login error:', error.code, error.message);
                    if (error.code === 'auth/user-not-found') {
                        setAuthError('‚ùå PROBLEM: EMAIL ‚Äî This email is not registered. The account does not exist.');
                    } else if (error.code === 'auth/wrong-password') {
                        setAuthError('‚ùå PROBLEM: PASSWORD ‚Äî The password is incorrect. The email is correct, but password is wrong.');
                    } else if (error.code === 'auth/invalid-credential') {
                        setAuthError('‚ùå PROBLEM: PASSWORD ‚Äî The password is incorrect for this email. Try "Forgot Password" to reset it.');
                    } else if (error.code === 'auth/too-many-requests') {
                        setAuthError('‚ùå PROBLEM: TOO MANY ATTEMPTS ‚Äî Account temporarily locked. Use "Forgot Password" to reset.');
                    } else if (error.code === 'auth/invalid-email') {
                        setAuthError('‚ùå PROBLEM: EMAIL FORMAT ‚Äî The email format is invalid.');
                    } else {
                        setAuthError(`‚ùå Login Failed: ${error.message}`);
                    }
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setAuthError('');

                if (loginPassword !== confirmPassword) {
                    setAuthError('‚ùå Password Mismatch: Password and confirmation must match.');
                    return;
                }

                try {
                    const emailLower = loginEmail.toLowerCase().trim();
                    
                    // Check if email is allowed
                    if (allowedEmails.length > 0 && !allowedEmails.includes(emailLower)) {
                        console.error('‚ùå Access denied for signup:', emailLower);
                        console.log('Allowed emails:', allowedEmails);
                        setAuthError('üö´ Access Denied: Your email is not authorized. Contact your administrator to request access.');
                        return;
                    }
                    
                    const { createUserWithEmailAndPassword, updateProfile } = window.FirebaseSDK;
                    const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, emailLower, loginPassword);
                    await updateProfile(userCredential.user, { displayName: loginName });
                    console.log('‚úÖ Signup successful');
                } catch (error) {
                    console.error('‚ùå Signup error:', error.code, error.message);
                    if (error.code === 'auth/email-already-in-use') {
                        setAuthError('‚ö†Ô∏è Account Exists: An account with this email already exists. Please sign in instead.');
                    } else if (error.code === 'auth/weak-password') {
                        setAuthError('‚ö†Ô∏è Weak Password: Password must be at least 6 characters long.');
                    } else if (error.code === 'auth/invalid-email') {
                        setAuthError('‚ùå Invalid Email: Please enter a valid email address.');
                    } else {
                        setAuthError(`‚ùå Signup Failed: ${error.message}`);
                    }
                }
            };

            const handlePasswordReset = async () => {
                const emailLower = loginEmail.toLowerCase().trim();
                if (!emailLower || !emailLower.includes('@')) {
                    setAuthError('‚ö†Ô∏è Enter Email: Please enter your email address first, then try forgot password.');
                    return;
                }
                
                try {
                    const { sendPasswordResetEmail } = window.FirebaseSDK;
                    await sendPasswordResetEmail(window.firebaseAuth, emailLower);
                    setAuthError('‚úÖ Password Reset Email Sent: Check your inbox for instructions to reset your password.');
                    console.log('‚úÖ Password reset email sent to:', emailLower);
                } catch (error) {
                    console.error('‚ùå Password reset error:', error.code, error.message);
                    if (error.code === 'auth/user-not-found') {
                        setAuthError('‚ùå No Account: This email is not registered. The account does not exist.');
                    } else if (error.code === 'auth/invalid-email') {
                        setAuthError('‚ùå Invalid Email: Please enter a valid email address.');
                    } else {
                        setAuthError(`‚ùå Password Reset Failed: ${error.message}`);
                    }
                }
            };

            const handleLogout = async () => {
                try {
                    const { signOut } = window.FirebaseSDK;
                    await signOut(window.firebaseAuth);
                    setView('login');
                    viewRef.current = 'login';
                    console.log('‚úÖ Logged out');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };
            
            const addAllowedEmail = async () => {
                if (!newEmail || !newEmail.includes('@')) {
                    alert('Please enter a valid email address');
                    return;
                }
                try {
                    const { doc, setDoc } = window.FirebaseSDK;
                    const updatedEmails = [...allowedEmails, newEmail.toLowerCase()];
                    await setDoc(doc(db, `apps/${APP_ID}/settings/allowed_emails`), {
                        emails: updatedEmails,
                        updatedBy: user.email,
                        updatedAt: new Date().toISOString()
                    });
                    setAllowedEmails(updatedEmails);
                    setNewEmail('');
                    console.log('‚úÖ Email added to whitelist:', newEmail);
                } catch (error) {
                    console.error('Failed to add email:', error);
                    alert('Failed to add email: ' + error.message);
                }
            };
            
            const removeAllowedEmail = async (email) => {
                try {
                    const { doc, setDoc } = window.FirebaseSDK;
                    const updatedEmails = allowedEmails.filter(e => e !== email);
                    await setDoc(doc(db, `apps/${APP_ID}/settings/allowed_emails`), {
                        emails: updatedEmails,
                        updatedBy: user.email,
                        updatedAt: new Date().toISOString()
                    });
                    setAllowedEmails(updatedEmails);
                    console.log('‚úÖ Email removed from whitelist:', email);
                } catch (error) {
                    console.error('Failed to remove email:', error);
                    alert('Failed to remove email: ' + error.message);
                }
            };
            
            const loadAdminList = async () => {
                try {
                    const { doc, getDoc } = window.FirebaseSDK;
                    const adminDocRef = doc(db, `apps/${APP_ID}/settings/admins`);
                    const adminDoc = await getDoc(adminDocRef);
                    const admins = adminDoc.exists() ? adminDoc.data().emails || [] : [];
                    setAdminEmails(admins);
                    console.log('üëë Admin list loaded:', admins.length);
                } catch (error) {
                    console.error('Failed to load admin list:', error);
                }
            };

            const makeAdmin = async (email) => {
                try {
                    const { doc, setDoc, getDoc } = window.FirebaseSDK;
                    const adminDocRef = doc(db, `apps/${APP_ID}/settings/admins`);
                    const adminDoc = await getDoc(adminDocRef);
                    const currentAdmins = adminDoc.exists() ? adminDoc.data().emails || [] : [];
                    
                    if (!currentAdmins.includes(email)) {
                        currentAdmins.push(email);
                        await setDoc(adminDocRef, {
                            emails: currentAdmins,
                            updatedBy: user.email,
                            updatedAt: new Date().toISOString()
                        });
                        setAdminEmails(currentAdmins);
                        console.log('‚úÖ Made admin:', email);
                        alert(`${email} is now an admin`);
                    } else {
                        alert(`${email} is already an admin`);
                    }
                } catch (error) {
                    console.error('Failed to make admin:', error);
                    alert('Failed to update admin: ' + error.message);
                }
            };

            const removeAdmin = async (email) => {
                if (adminEmails.length === 1) {
                    alert('‚ö†Ô∏è Cannot remove the last admin. Add another admin first.');
                    return;
                }
                if (email === user.email) {
                    if (!confirm('‚ö†Ô∏è You are removing yourself as admin. You will lose access to settings. Continue?')) {
                        return;
                    }
                }
                try {
                    const { doc, setDoc } = window.FirebaseSDK;
                    const updatedAdmins = adminEmails.filter(e => e !== email);
                    await setDoc(doc(db, `apps/${APP_ID}/settings/admins`), {
                        emails: updatedAdmins,
                        updatedBy: user.email,
                        updatedAt: new Date().toISOString()
                    });
                    setAdminEmails(updatedAdmins);
                    console.log('‚úÖ Admin removed:', email);
                    alert(`${email} removed from admins`);
                    
                    if (email === user.email) {
                        setIsAdmin(false);
                        setView('year-select');
                        viewRef.current = 'year-select';
                    }
                } catch (error) {
                    console.error('Failed to remove admin:', error);
                    alert('Failed to remove admin: ' + error.message);
                }
            };

            // Log changes to Firestore
            const logChange = async (action, details) => {
                if (!db || !user) return;
                try {
                    const { addDoc, collection, serverTimestamp } = window.FirebaseSDK;
                    await addDoc(collection(db, `apps/${APP_ID}/audit_log`), {
                        timestamp: serverTimestamp(),
                        user: user.email || user.displayName || 'Unknown',
                        userId: user.uid,
                        action,
                        details,
                        year: selectedYear,
                        buildingId: selectedBuildingId
                    });
                } catch (error) {
                    console.error('Failed to log change:', error);
                }
            };

            // --- LOGIN VIEW ---
            if (!authInitialized) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Initializing...</p>
                        </div>
                    </div>
                );
            }
            
            // Show loading while data loads from cloud
            if (isLoadingData && user && user.email) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading data...</p>
                            <p className="text-xs text-gray-400 mt-2">{user.email}</p>
                        </div>
                    </div>
                );
            }

            if (view === 'login') {
                // If user is already logged in, redirect to year-select
                if (user && user.email) {
                    console.log('‚ö†Ô∏è Already logged in, redirecting to year-select');
                    setView('year-select');
                    viewRef.current = 'year-select';
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gray-100">
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="text-gray-600">Redirecting...</p>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                        <div className="bg-white rounded-3xl shadow-xl p-8 w-full max-w-md">
                            <h1 className="text-3xl font-black text-center mb-2 text-gray-800">üî• Fire Inspection</h1>
                            <p className="text-center text-gray-500 text-sm mb-8">Team Collaboration Portal</p>
                            
                            <form onSubmit={isSignup ? handleSignup : handleLogin} className="space-y-4">
                                {isSignup && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Full Name</label>
                                        <input 
                                            type="text"
                                            value={loginName}
                                            onChange={(e) => setLoginName(e.target.value)}
                                            placeholder="John Doe"
                                            required
                                            className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                )}
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Email</label>
                                    <input 
                                        type="email"
                                        value={loginEmail}
                                        onChange={(e) => setLoginEmail(e.target.value)}
                                        placeholder="inspector@example.com"
                                        required
                                        className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Password</label>
                                    <input 
                                        type="password"
                                        value={loginPassword}
                                        onChange={(e) => setLoginPassword(e.target.value)}
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        required={isSignup}
                                        className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    {!isSignup && (
                                        <button 
                                            type="button"
                                            onClick={handlePasswordReset}
                                            className="text-blue-600 text-xs font-semibold hover:underline mt-2"
                                        >
                                            üîë Forgot Password?
                                        </button>
                                    )}
                                </div>
                                {isSignup && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Confirm Password</label>
                                        <input
                                            type="password"
                                            value={confirmPassword}
                                            onChange={(e) => setConfirmPassword(e.target.value)}
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            required
                                            className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                )}
                                
                                {authError && (
                                    <div className={`border-2 p-4 rounded-xl text-sm font-semibold shadow-lg ${authError.startsWith('‚úÖ') ? 'bg-green-100 border-green-400 text-green-800' : 'bg-red-100 border-red-400 text-red-800'}`}>
                                        {authError}
                                    </div>
                                )}
                                
                                <button 
                                    type="submit"
                                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold uppercase tracking-wide hover:bg-blue-700 active:scale-95 transition-transform"
                                >
                                    {isSignup ? 'Create Account' : 'Sign In'}
                                </button>
                            </form>
                            
                            <div className="mt-6 text-center">
                                <button 
                                    onClick={() => { setIsSignup(!isSignup); setAuthError(''); setConfirmPassword(''); }}
                                    className="text-blue-600 text-sm font-semibold hover:underline"
                                >
                                    {isSignup ? 'Already have an account? Sign in' : 'Need an account? Sign up'}
                                </button>
                            </div>
                            
                            {/* Version Display */}
                            <div className="mt-8 pt-6 border-t text-center">
                                <p className="text-[10px] text-gray-400 font-semibold">v{APP_VERSION}</p>
                                <p className="text-[8px] text-gray-300 mt-1">Cloud sync enabled</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'settings' && isAdmin) return (
                <div className="p-4 space-y-4 max-w-4xl mx-auto overflow-x-hidden">
                    <div className="flex flex-wrap items-center justify-between gap-2 mb-4">
                        <button onClick={() => { setView('year-select'); viewRef.current = 'year-select'; }} className="text-blue-600 font-bold p-1">‚Üê Back</button>
                        <h1 className="text-lg sm:text-xl font-black uppercase tracking-tighter text-gray-800">Settings</h1>
                        <div className="flex items-center gap-1 sm:gap-2">
                            <button 
                                onClick={() => setDarkMode(!darkMode)}
                                className="text-xl sm:text-2xl p-1 hover:scale-110 transition-transform"
                                title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                            >
                                {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                            </button>
                            <div className="text-right">
                                <p className="text-[10px] sm:text-xs font-semibold text-gray-700 truncate max-w-[80px] sm:max-w-none">{user?.displayName || 'User'}</p>
                                <p className="text-[8px] sm:text-[9px] text-gray-500 font-medium hidden sm:block">{user?.email}</p>
                                <button onClick={handleLogout} className="text-[9px] sm:text-[10px] text-red-500 font-bold uppercase mt-0.5">Logout</button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-2xl p-6 shadow-sm space-y-4">
                        <h2 className="text-lg font-bold text-gray-800">Allowed Emails</h2>
                        <p className="text-sm text-gray-600">Only these emails can sign up and access the app.</p>
                        
                        <div className="flex gap-2">
                            <input 
                                type="email"
                                value={newEmail}
                                onChange={(e) => setNewEmail(e.target.value)}
                                placeholder="email@example.com"
                                className="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-xl"
                            />
                            <button 
                                onClick={addAllowedEmail}
                                className="px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 active:scale-95 transition-transform"
                            >
                                Add
                            </button>
                        </div>
                        
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {allowedEmails.length === 0 && (
                                <div className="text-center py-8 text-gray-400">
                                    <p className="font-semibold">No emails added yet</p>
                                    <p className="text-xs mt-2">Add emails above to control who can access the app</p>
                                </div>
                            )}
                            {allowedEmails.map(email => (
                                <div key={email} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                    <div className="flex items-center gap-2">
                                        <span className="font-medium text-gray-700">{email}</span>
                                        {adminEmails.includes(email) && (
                                            <span className="text-[10px] px-2 py-0.5 bg-purple-100 text-purple-600 rounded-full font-bold">ADMIN</span>
                                        )}
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => makeAdmin(email)}
                                            disabled={adminEmails.includes(email)}
                                            className={`text-xs px-3 py-1 rounded-lg font-bold ${
                                                adminEmails.includes(email) 
                                                ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                                                : 'bg-purple-100 text-purple-600 hover:bg-purple-200'
                                            }`}
                                        >
                                            {adminEmails.includes(email) ? '‚úì Admin' : 'Make Admin'}
                                        </button>
                                        <button 
                                            onClick={() => {
                                                if (confirm(`Remove ${email} from allowed list?`)) {
                                                    removeAllowedEmail(email);
                                                }
                                            }}
                                            className="text-red-500 font-bold px-2 hover:bg-red-50 rounded"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="pt-4 border-t">
                            <p className="text-xs text-gray-500">
                                üí° <strong>Tip:</strong> Users must be on this list to sign up or log in. Remove users to revoke access.
                            </p>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-2xl p-6 shadow-sm space-y-4">
                        <div className="flex items-center justify-between">
                            <div>
                                <h2 className="text-lg font-bold text-gray-800">üëë Admin Users</h2>
                                <p className="text-sm text-gray-600">Admins can manage settings and user access.</p>
                            </div>
                            <button 
                                onClick={loadAdminList}
                                className="text-xs px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200"
                            >
                                üîÑ Refresh
                            </button>
                        </div>
                        
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {adminEmails.length === 0 && (
                                <div className="text-center py-8 text-gray-400">
                                    <p className="font-semibold">No admins found</p>
                                    <p className="text-xs mt-2">Click Refresh to load admin list</p>
                                </div>
                            )}
                            {adminEmails.map(email => (
                                <div key={email} className="flex items-center justify-between p-3 bg-purple-50 rounded-xl border-2 border-purple-200">
                                    <div className="flex items-center gap-2">
                                        <span className="text-purple-600 font-bold">üëë</span>
                                        <span className="font-semibold text-gray-800">{email}</span>
                                        {email === user?.email && (
                                            <span className="text-[10px] px-2 py-0.5 bg-purple-200 text-purple-700 rounded-full font-bold">YOU</span>
                                        )}
                                    </div>
                                    <button 
                                        onClick={() => {
                                            if (confirm(`Remove ${email} from admins?`)) {
                                                removeAdmin(email);
                                            }
                                        }}
                                        className="text-red-500 font-bold px-2 hover:bg-red-50 rounded text-sm"
                                    >
                                        Remove
                                    </button>
                                </div>
                            ))}
                        </div>
                        
                        <div className="pt-4 border-t">
                            <p className="text-xs text-gray-500">
                                ‚ö†Ô∏è <strong>Warning:</strong> At least one admin must exist. Removing yourself will revoke your admin access.
                            </p>
                        </div>
                    </div>
                    
                    <div className="bg-blue-50 rounded-2xl p-6 border-2 border-blue-200">
                        <h3 className="text-sm font-bold text-blue-800 mb-2">üìã User Management Tips</h3>
                        <ul className="text-xs text-blue-700 space-y-2">
                            <li>‚Ä¢ <strong>Allowed Emails:</strong> Users must be on this list to create accounts</li>
                            <li>‚Ä¢ <strong>Make Admin:</strong> Click on any allowed email to promote them to admin</li>
                            <li>‚Ä¢ <strong>Delete Users in Firebase:</strong> Go to Firebase Console ‚Üí Authentication ‚Üí Users to delete accounts</li>
                            <li>‚Ä¢ <strong>Anonymous Users:</strong> Can be safely deleted from Firebase - app only uses email/password</li>
                        </ul>
                    </div>
                    
                    {/* Share App Section */}
                    <div className="bg-white rounded-2xl p-6 shadow-sm space-y-6">
                        <div>
                            <h2 className="text-lg font-bold text-gray-800 mb-2">üì± Share App</h2>
                            <p className="text-sm text-gray-600">Invite team members and show them how to install.</p>
                        </div>
                        
                        {/* App URL */}
                        <div className="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                            <label className="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">üîó App Link</label>
                            <div className="flex flex-col sm:flex-row gap-2">
                                <input 
                                    type="text"
                                    value={window.location.href.split('?')[0]}
                                    readOnly
                                    className="flex-1 p-3 bg-white border border-gray-300 rounded-lg text-xs sm:text-sm font-mono text-blue-600 select-all overflow-x-auto"
                                    onClick={(e) => e.target.select()}
                                />
                                <button 
                                    onClick={() => {
                                        const url = window.location.href.split('?')[0];
                                        navigator.clipboard.writeText(url).then(() => {
                                            setLinkCopied(true);
                                            setTimeout(() => setLinkCopied(false), 2000);
                                        });
                                    }}
                                    className={`px-4 py-3 rounded-lg font-bold text-sm transition-all whitespace-nowrap ${
                                        linkCopied 
                                        ? 'bg-green-500 text-white' 
                                        : 'bg-blue-600 text-white hover:bg-blue-700 active:scale-95'
                                    }`}
                                >
                                    {linkCopied ? '‚úì Copied' : 'Copy'}
                                </button>
                            </div>
                        </div>
                        
                        {/* Sign Up Instructions */}
                        <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                            <h3 className="text-sm font-bold text-blue-800 mb-3">üë• How to Sign Up</h3>
                            <ol className="text-xs text-blue-900 space-y-2 list-decimal list-inside leading-relaxed">
                                <li>Open the app link (above) on your device</li>
                                <li>Click <strong>"Need an account? Sign up"</strong></li>
                                <li>Enter your name, email, and password</li>
                                <li className="break-words"><strong>Note:</strong> Your email must be added to the "Allowed Emails" list first</li>
                                <li>Once signed up, you can log in on any device</li>
                            </ol>
                        </div>
                        
                        {/* iOS Installation */}
                        <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border-2 border-gray-200">
                            <div className="flex items-center gap-2 mb-3">
                                <span className="text-2xl">üçé</span>
                                <h3 className="text-sm font-bold text-gray-800">iPhone/iPad Installation</h3>
                            </div>
                            <ol className="text-xs text-gray-700 space-y-2 list-decimal list-inside leading-relaxed">
                                <li>Open the app link in <strong>Safari</strong> (not Chrome)</li>
                                <li className="break-words">Tap the <strong>Share</strong> button (üì§) at the bottom of Safari</li>
                                <li className="break-words">Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                                <li>Tap <strong>"Add"</strong> in the top right corner</li>
                                <li className="break-words">The app icon will appear on your home screen üéâ</li>
                            </ol>
                            <div className="mt-3 p-3 bg-yellow-50 border-2 border-yellow-200 rounded-lg">
                                <p className="text-xs text-yellow-800 break-words">
                                    <strong>üí° Tip:</strong> Once installed, the app works offline and feels like a native app!
                                </p>
                            </div>
                        </div>
                        
                        {/* Android Installation */}
                        <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border-2 border-green-200">
                            <div className="flex items-center gap-2 mb-3">
                                <span className="text-2xl">ü§ñ</span>
                                <h3 className="text-sm font-bold text-gray-800">Android Installation</h3>
                            </div>
                            <ol className="text-xs text-gray-700 space-y-2 list-decimal list-inside leading-relaxed">
                                <li>Open the app link in <strong>Chrome</strong></li>
                                <li className="break-words">Tap the <strong>three dots menu</strong> (‚ãÆ) in the top right</li>
                                <li className="break-words">Tap <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></li>
                                <li>Tap <strong>"Add"</strong> or <strong>"Install"</strong> to confirm</li>
                                <li className="break-words">The app icon will appear on your home screen üéâ</li>
                            </ol>
                            <div className="mt-3 p-3 bg-green-50 border-2 border-green-300 rounded-lg">
                                <p className="text-xs text-green-800 break-words">
                                    <strong>‚úÖ Note:</strong> Some Android devices may show an automatic "Install" banner at the bottom of the screen.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'year-select') return (
                <>
                    {/* Pull-to-Refresh Indicator */}
                    <div 
                        className={`pull-to-refresh-indicator ${pullDistance > 0 || isRefreshing ? 'visible' : ''}`}
                        style={{ 
                            opacity: Math.min(pullDistance / pullThreshold, 1),
                            background: 'linear-gradient(to bottom, rgba(255,255,255,0.95), transparent)'
                        }}
                    >
                        {isRefreshing ? (
                            <div className="pull-spinner"></div>
                        ) : pullDistance >= pullThreshold ? (
                            <div className="text-blue-600 font-semibold text-sm">Release to refresh</div>
                        ) : pullDistance > 0 ? (
                            <div className="text-gray-400 text-sm">Pull down to refresh</div>
                        ) : null}
                    </div>
                    
                    <div 
                        className="p-4 space-y-4"
                        style={{
                            transform: `translateY(${pullDistance}px)`,
                            transition: isPulling ? 'none' : 'transform 0.3s ease'
                        }}
                    >
                    <div className="flex flex-wrap items-center justify-between gap-2 mb-4">
                        <h1 className="text-lg sm:text-xl font-black uppercase tracking-tighter text-gray-800">Annual Inspections</h1>
                        <div className="flex items-center gap-1 sm:gap-2">
                            <button 
                                onClick={() => setDarkMode(!darkMode)}
                                className="text-xl sm:text-2xl p-1 hover:scale-110 transition-transform"
                                title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                            >
                                {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                            </button>
                            {isAdmin && (
                                <button 
                                    onClick={() => { setView('settings'); viewRef.current = 'settings'; }}
                                    className="text-[10px] sm:text-xs px-2 sm:px-3 py-1 sm:py-1.5 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200"
                                >
                                    ‚öôÔ∏è
                                </button>
                            )}
                            <div className="text-right">
                                <p className="text-[10px] sm:text-xs font-semibold text-gray-700 truncate max-w-[80px] sm:max-w-none">{user?.displayName || 'User'}</p>
                                <button onClick={handleLogout} className="text-[9px] sm:text-[10px] text-red-500 font-bold uppercase">Logout</button>
                            </div>
                        </div>
                    </div>
                    {Object.keys(yearData).sort().reverse().map(year => (
                        <div key={year} onClick={() => { setSelectedYear(year); setView('building-select'); viewRef.current = 'building-select'; }} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:bg-gray-50">
                            <span className="font-bold text-lg text-gray-700">Year {year}</span>
                            <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">{(yearData[year] || []).length} Buildings</span>
                        </div>
                    ))}
                    <button onClick={() => setActiveModal({ type: 'input', title: 'Add New Year', onConfirm: (val) => { if(val && !yearData[val]) setYearData(prev => ({ ...prev, [val]: [] })); setActiveModal(null); } })} className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add Year</button>
                    
                    {/* Version Footer */}
                    <div className="text-center mt-8 pt-4 border-t">
                        <p className="text-[10px] text-gray-400 font-semibold">Fire Inspection App v{APP_VERSION}</p>
                        <p className="text-[8px] text-gray-300 mt-1">Cloud sync ‚Ä¢ Multi-user collaboration</p>
                    </div>
                    
                    {activeModal?.type === 'input' && (
                        <Modal title={activeModal.title} onCancel={() => setActiveModal(null)} onConfirm={() => activeModal.onConfirm(yearInputValue)}>
                            <input type="number" autoFocus value={yearInputValue} onChange={(e) => setYearInputValue(e.target.value)} placeholder="e.g. 2026" className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl text-center text-xl font-bold" />
                        </Modal>
                    )}
                    </div>
                </>
            );

            if (view === 'building-select') return (
                <>
                    {/* Pull-to-Refresh Indicator */}
                    <div 
                        className={`pull-to-refresh-indicator ${pullDistance > 0 || isRefreshing ? 'visible' : ''}`}
                        style={{ 
                            opacity: Math.min(pullDistance / pullThreshold, 1),
                            background: 'linear-gradient(to bottom, rgba(255,255,255,0.95), transparent)'
                        }}
                    >
                        {isRefreshing ? (
                            <div className="pull-spinner"></div>
                        ) : pullDistance >= pullThreshold ? (
                            <div className="text-blue-600 font-semibold text-sm">Release to refresh</div>
                        ) : pullDistance > 0 ? (
                            <div className="text-gray-400 text-sm">Pull down to refresh</div>
                        ) : null}
                    </div>
                    
                    <div 
                        className="p-4 space-y-4"
                        style={{
                            transform: `translateY(${pullDistance}px)`,
                            transition: isPulling ? 'none' : 'transform 0.3s ease'
                        }}
                    >
                    <div className="flex flex-wrap items-center justify-between gap-2">
                        <div className="flex items-center gap-1 sm:gap-2">
                            <button onClick={() => saveAndNavigate('year-select')} className="text-blue-600 font-bold p-1">‚Üê</button>
                            <h1 className="text-base sm:text-xl font-black uppercase">Buildings {selectedYear}</h1>
                        </div>
                        <div className="flex flex-wrap items-center gap-1 sm:gap-2">
                            <button 
                                onClick={() => setDarkMode(!darkMode)}
                                className="text-xl sm:text-2xl p-1 hover:scale-110 transition-transform"
                                title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                            >
                                {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                            </button>
                            <button 
                                onClick={() => syncBidirectional()} 
                                disabled={syncStatus === 'syncing'}
                                className={`px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg text-[9px] sm:text-[10px] font-black uppercase tracking-wider transition-all ${
                                    syncStatus === 'syncing' ? 'bg-blue-100 text-blue-400' :
                                    syncStatus === 'success' ? 'bg-green-500 text-white' :
                                    syncStatus === 'error' ? 'bg-red-500 text-white' :
                                    'bg-blue-600 text-white active:scale-95'
                                }`}
                            >
                                {syncStatus === 'syncing' ? '‚ü≥' :
                                 syncStatus === 'success' ? '‚úì' :
                                 syncStatus === 'error' ? '‚úï' :
                                 '‚òÅ'}
                            </button>
                            <button onClick={handleLogout} className="text-[9px] sm:text-[10px] text-red-500 font-bold uppercase whitespace-nowrap">Logout</button>
                        </div>
                    </div>
                    {lastSyncTime && (
                        <div className="text-[10px] text-gray-400 text-center font-semibold">
                            Last synced: {new Date(lastSyncTime).toLocaleString('en-US', { 
                                timeZone: 'America/Denver',
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true
                            })} MST
                            {realtimeSyncActive && (
                                <span className="ml-2 text-green-500" title="Real-time sync active">‚óè Live</span>
                            )}
                        </div>
                    )}
                    {!lastSyncTime && realtimeSyncActive && (
                        <div className="text-[10px] text-green-500 text-center font-semibold">
                            <span title="Real-time sync active">‚óè Real-time sync active</span>
                        </div>
                    )}
                    {(!yearData[selectedYear] || yearData[selectedYear].length === 0) && (
                        <div className="text-center py-12 text-gray-400">
                            <p className="font-semibold">No buildings for {selectedYear}</p>
                            <p className="text-xs mt-2">Add a building below to get started</p>
                        </div>
                    )}
                    {(yearData[selectedYear] || []).slice(0, buildingsToShow).map(b => {
                        if (!b || !b.id) return null; // Safety check
                        const status = getBuildingStatus(b);
                        return (
                            <div key={b.id} onClick={() => { setSelectedBuildingId(b.id); setView('form'); viewRef.current = 'form'; }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer">
                                <div>
                                    <h3 className="font-bold text-gray-800">{b.name || 'Unnamed Building'}</h3>
                                    <div className="flex flex-col gap-0.5">
                                        <span className={`text-[10px] font-black uppercase tracking-wide ${status.class}`}>{status.text}</span>
                                        {status.deficiencyText && (
                                            <span className={`text-[9px] font-bold ${status.deficiencyClass}`}>{status.deficiencyText}</span>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-1">
                                    <button 
                                        onClick={(e) => { 
                                            e.stopPropagation(); 
                                            setBuildingToCopy(b);
                                            setCopyTargetYear('');
                                            setActiveModal({ type: 'copy-building', title: `Copy "${b.name}" to Year` }); 
                                        }} 
                                        className="text-blue-400 p-2 text-lg hover:text-blue-600 transition-colors"
                                        title="Copy to another year"
                                    >üìã</button>
                                    <button onClick={(e) => { 
                                    e.stopPropagation(); 
                                    const buildingIdToDelete = b.id;
                                    setActiveModal({ 
                                        type: 'confirm', 
                                        title: 'Delete Building?', 
                                        isDanger: true, 
                                        onConfirm: async () => { 
                                            try {
                                                console.log(`üóëÔ∏è Deleting building ${buildingIdToDelete}...`);
                                                
                                                // Step 1: Delete from cloud first
                                                await deleteFromCloud(buildingIdToDelete);
                                                
                                                // Step 2: Mark as sync update to prevent auto-sync from running
                                                isUpdatingFromSync.current = true;
                                                
                                                // Step 3: Update local state
                                                setYearData(prev => ({ 
                                                    ...prev, 
                                                    [selectedYear]: prev[selectedYear].filter(x => x.id !== buildingIdToDelete) 
                                                }));
                                                
                                                console.log(`‚úÖ Building ${buildingIdToDelete} deleted successfully`);
                                                setActiveModal(null);
                                            } catch (error) {
                                                alert('Failed to delete building from cloud. Please try again.');
                                                console.error('Delete error:', error);
                                                isUpdatingFromSync.current = false; // Reset on error
                                            }
                                        } 
                                    }); 
                                }} className="text-red-200 p-2 text-xl">‚úï</button>
                                </div>
                            </div>
                        );
                    })}
                    
                    {/* Load More Button - Progressive Loading */}
                    {(yearData[selectedYear] || []).length > buildingsToShow && (
                        <button 
                            onClick={() => setBuildingsToShow(prev => prev + 20)} 
                            className="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl text-blue-600 font-semibold text-sm hover:bg-blue-100 transition-colors"
                        >
                            Load More ({(yearData[selectedYear] || []).length - buildingsToShow} remaining)
                        </button>
                    )}
                    
                    <button onClick={() => setYearData(prev => ({ ...prev, [selectedYear]: [...(prev[selectedYear] || []), getNewBuildingTemplate(`New Building ${(yearData[selectedYear] || []).length + 1}`)] }))} className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add Building</button>
                    {activeModal?.type === 'confirm' && <Modal title={activeModal.title} isDanger={activeModal.isDanger} onCancel={() => setActiveModal(null)} onConfirm={activeModal.onConfirm} />}
                    {activeModal?.type === 'copy-building' && (
                        <Modal 
                            title={activeModal.title} 
                            onCancel={() => { 
                                setActiveModal(null); 
                                setBuildingToCopy(null); 
                                setCopyTargetYear(''); 
                            }} 
                            onConfirm={() => {
                                if (copyTargetYear && buildingToCopy) {
                                    copyBuildingToYear(buildingToCopy, copyTargetYear);
                                    setActiveModal(null);
                                    setBuildingToCopy(null);
                                    setCopyTargetYear('');
                                }
                            }}
                            confirmText="Copy Building"
                        >
                            <div className="space-y-3">
                                <div className="pt-1">
                                    <label className="block text-xs font-semibold text-gray-700 mb-2">Copy "{buildingToCopy?.name}" to year:</label>
                                    <input 
                                        type="number" 
                                        autoFocus 
                                        value={copyTargetYear} 
                                        onChange={(e) => setCopyTargetYear(e.target.value)} 
                                        placeholder={`e.g. ${parseInt(selectedYear) + 1}`}
                                        className="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <details className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <summary className="text-[10px] text-blue-800 font-semibold cursor-pointer">‚úì What gets copied</summary>
                                    <ul className="text-[10px] text-blue-700 space-y-0.5 ml-4 list-disc mt-2">
                                        <li>Building name and details</li>
                                        <li>Panel information</li>
                                        <li>Device inventory structure</li>
                                        <li>N/A status preservation</li>
                                    </ul>
                                </details>
                                <details className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                    <summary className="text-[10px] text-orange-800 font-semibold cursor-pointer">‚Üª What gets reset</summary>
                                    <ul className="text-[10px] text-orange-700 space-y-0.5 ml-4 list-disc mt-2">
                                        <li>Inspection checkmarks (‚Üí pending, except N/A)</li>
                                        <li>Notes and photos</li>
                                        <li>Deficiency status</li>
                                    </ul>
                                </details>
                            </div>
                        </Modal>
                    )}
                    </div>
                </>
            );

            const allDeficiencies = [];
            if (activeBuilding) {
                activeBuilding.sections.forEach(s => {
                    activeBuilding.data[s.id].forEach(i => { if (i.status === 'failed') allDeficiencies.push({ ...i, section: s.id }); });
                });
            }
            
            // If in form view but no active building, go back
            if (view === 'form' && !activeBuilding) {
                console.warn('No active building found, returning to building select');
                setView('building-select');
                viewRef.current = 'building-select';
                return null;
            }

            return (
                <div className="pb-44">
                    <div className="bg-white p-3 sm:p-4 sticky top-0 border-b z-50">
                        <div className="flex flex-wrap justify-between items-center gap-2 mb-2">
                            <button onClick={() => saveAndNavigate('building-select')} className="text-blue-600 font-bold px-1 sm:px-2 py-1 text-sm sm:text-base">‚Üê Save</button>
                            <h2 className="font-black uppercase text-[10px] sm:text-xs tracking-tight text-gray-600 truncate max-w-[120px] sm:max-w-[40%]">{activeBuilding.name}</h2>
                            <div className="flex items-center gap-1 sm:gap-2">
                                <button 
                                    onClick={() => setDarkMode(!darkMode)}
                                    className="text-lg sm:text-xl hover:scale-110 transition-transform p-0.5 sm:p-1"
                                    title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                                >
                                    {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                                </button>
                                <button onClick={handleExport} className="bg-gray-50 p-1.5 sm:p-2 rounded-lg text-blue-600 font-black text-[9px] sm:text-[10px] uppercase border shadow-sm whitespace-nowrap">PDF</button>
                            </div>
                        </div>
                        {syncStatus !== 'idle' && (
                            <div className={`text-[9px] font-bold text-center py-1 rounded ${
                                syncStatus === 'syncing' ? 'bg-blue-50 text-blue-600' :
                                syncStatus === 'success' ? 'bg-green-50 text-green-600' :
                                'bg-red-50 text-red-600'
                            }`}>
                                {syncStatus === 'syncing' ? '‚òÅ Syncing to cloud...' :
                                 syncStatus === 'success' ? `‚úì Synced ${lastSyncTime ? new Date(lastSyncTime).toLocaleString('en-US', { timeZone: 'America/Denver', hour: 'numeric', minute: '2-digit', hour12: true }) + ' MST' : 'successfully'}` :
                                 '‚úï Sync failed - will retry'}
                            </div>
                        )}
                    </div>

                    <div className="p-4 space-y-3">
                        {/* Section 0: Inspection Details */}
                        <div className="rounded-xl border overflow-hidden shadow-sm">
                            <button onClick={() => setExpandedSections(p => ({...p, inspectionDetails: !p.inspectionDetails}))} className="w-full bg-green-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
                                <span>0. Inspection Details</span>
                                <span className="text-lg opacity-50">{expandedSections['inspectionDetails'] ? '‚àí' : '+'}</span>
                            </button>
                            {expandedSections['inspectionDetails'] && (
                                <div className="bg-white p-4 grid grid-cols-1 gap-4">
                                    <div className="space-y-1">
                                        <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest">Inspection Date</label>
                                        <input 
                                            type="date" 
                                            value={activeBuilding.inspectionDetails?.date || ''} 
                                            onChange={(e) => setYearData(prev => ({
                                                ...prev,
                                                [selectedYear]: prev[selectedYear].map(b => 
                                                    b.id === selectedBuildingId 
                                                    ? { ...b, inspectionDetails: { ...b.inspectionDetails, date: e.target.value } } 
                                                    : b
                                                )
                                            }))} 
                                            className="w-full border-b border-gray-100 py-1 font-semibold text-gray-700 focus:border-blue-500" 
                                        />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest">Inspection Time</label>
                                        <input 
                                            type="time" 
                                            value={activeBuilding.inspectionDetails?.time || ''} 
                                            onChange={(e) => setYearData(prev => ({
                                                ...prev,
                                                [selectedYear]: prev[selectedYear].map(b => 
                                                    b.id === selectedBuildingId 
                                                    ? { ...b, inspectionDetails: { ...b.inspectionDetails, time: e.target.value } } 
                                                    : b
                                                )
                                            }))} 
                                            className="w-full border-b border-gray-100 py-1 font-semibold text-gray-700 focus:border-blue-500" 
                                        />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest">Inspector Name</label>
                                        <input 
                                            type="text" 
                                            value={activeBuilding.inspectionDetails?.inspector || ''} 
                                            onChange={(e) => setYearData(prev => ({
                                                ...prev,
                                                [selectedYear]: prev[selectedYear].map(b => 
                                                    b.id === selectedBuildingId 
                                                    ? { ...b, inspectionDetails: { ...b.inspectionDetails, inspector: e.target.value } } 
                                                    : b
                                                )
                                            }))} 
                                            placeholder="Enter inspector name"
                                            className="w-full border-b border-gray-100 py-1 font-semibold text-gray-700 focus:border-blue-500" 
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Permanent Section 1: Building Details */}
                        <div className="rounded-xl border overflow-hidden shadow-sm">
                            <button onClick={() => setExpandedSections(p => ({...p, details: !p.details}))} className="w-full bg-blue-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
                                <span>1. Building Details</span>
                                <span className="text-lg opacity-50">{expandedSections['details'] ? '‚àí' : '+'}</span>
                            </button>
                            {expandedSections['details'] && (
                                <div className="bg-white p-4 grid grid-cols-1 gap-4">
                                    {['buildingName', 'address', 'city', 'panelLocation', 'manufacturer', 'panelModel', 'serialNumber', 'softwareVersion', 'dateManufactured', 'lastServiceDate'].map(k => (
                                        <div key={k} className="space-y-1">
                                            <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest">{k.replace(/([A-Z])/g, ' $1')}</label>
                                            <input value={activeBuilding.details[k] || ''} onChange={(e) => updateBuildingDetail(k, e.target.value)} className="w-full border-b border-gray-100 py-1 font-semibold text-gray-700 focus:border-blue-500" />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Reorderable Sections 2..N */}
                        {activeBuilding.sections.map((s, idx) => {
                            const isSectionDragging = sectionDrag.draggingId === s.id;
                            const isProtected = PROTECTED_SECTIONS.includes(s.id);

                            return (
                                <div 
                                    key={s.id} 
                                    data-drag-id={s.id}
                                    onTouchStart={sectionDrag.onTouchStart(s.id)}
                                    onTouchMove={sectionDrag.onTouchMove(s.id)}
                                    onTouchEnd={sectionDrag.onTouchEnd}
                                    className={`rounded-xl border overflow-hidden shadow-sm draggable-item ${isSectionDragging ? 'is-dragging' : ''}`}
                                >
                                    <div className={`w-full ${s.color} text-white p-3 flex justify-between items-center`}>
                                        <button 
                                            onClick={() => setExpandedSections(p => ({...p, [s.id]: !p[s.id]}))} 
                                            className="flex-1 text-left font-bold text-xs uppercase"
                                        >
                                            <span>{idx + 2}. {s.title}</span>
                                        </button>
                                        <div className="flex items-center gap-4">
                                            {!isProtected && (
                                                <button onClick={(e) => {
                                                    e.stopPropagation();
                                                    setActiveModal({
                                                        title: "Delete Section?",
                                                        isDanger: true,
                                                        onConfirm: () => {
                                                            setYearData(prev => ({
                                                                ...prev,
                                                                [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? {
                                                                    ...b,
                                                                    sections: b.sections.filter(x => x.id !== s.id)
                                                                } : b)
                                                            }));
                                                            setActiveModal(null);
                                                        }
                                                    });
                                                }} className="text-white/40 hover:text-white text-lg">‚úï</button>
                                            )}
                                            <button onClick={() => setExpandedSections(p => ({...p, [s.id]: !p[s.id]}))} className="text-lg opacity-50">
                                                {expandedSections[s.id] ? '‚àí' : '+'}
                                            </button>
                                        </div>
                                    </div>
                                    {expandedSections[s.id] && (
                                        <div className="bg-white">
                                            {activeBuilding.data[s.id]?.map((item, i) => (
                                                <InspectionRow 
                                                    key={item.id} index={i+1} item={item} isDevice={s.isDev} 
                                                    onUpdateMeta={(m) => updateItem(s.id, item.id, m)}
                                                    onTriggerModal={setActiveModal}
                                                    onDelete={() => {
                                                        setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, [s.id]: b.data[s.id].filter(x => x.id !== item.id) } } : b) }));
                                                        setActiveModal(null);
                                                    }}
                                                />
                                            ))}
                                            <button onClick={() => setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, [s.id]: [...(b.data[s.id] || []), { id: Date.now(), label: "New Item", status: "pending", note: "", photo: null, fixed: false }] } } : b) }))} className="w-full p-3 text-[10px] font-black text-gray-300 uppercase tracking-widest">+ Add Item</button>
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        <button onClick={() => {
                            const newId = `sect-${Date.now()}`;
                            setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, sections: [...b.sections, { id: newId, title: 'Custom Section', color: 'bg-gray-500', isDev: false }], data: { ...b.data, [newId]: [] } } : b) }));
                        }} className="w-full p-3 border-2 border-dashed rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add New Section</button>

                        {/* Deficiencies Section (Permanent Last Item) */}
                        <div className="rounded-xl border border-red-200 overflow-hidden shadow-sm">
                            <button onClick={() => setExpandedSections(p => ({...p, defs: !p.defs}))} className="w-full bg-red-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
                                <span>{activeBuilding.sections.length + 2}. Deficiencies</span>
                                <div className="flex items-center gap-3">
                                    <span className="bg-white/20 px-2 rounded-md text-[10px]">{allDeficiencies.length + (activeBuilding.data.customDeficiencies?.length || 0)}</span>
                                    <span className="text-lg opacity-50">{expandedSections['defs'] ? '‚àí' : '+'}</span>
                                </div>
                            </button>
                            {expandedSections['defs'] && (
                                <div className="bg-white">
                                    {allDeficiencies.map((item, i) => (
                                        <InspectionRow key={item.id} index={i+1} item={item} isDeficiencyView onUpdateMeta={(m) => updateItem(item.section, item.id, m)} onTriggerModal={setActiveModal} />
                                    ))}
                                    {(activeBuilding.data.customDeficiencies || []).map((item, i) => (
                                        <InspectionRow 
                                            key={item.id} index={allDeficiencies.length + i + 1} item={item} isDeficiencyView 
                                            onTriggerModal={setActiveModal}
                                            onUpdateMeta={(m) => setYearData(p => ({ ...p, [selectedYear]: p[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, customDeficiencies: b.data.customDeficiencies.map(x => x.id === item.id ? {...x, ...m} : x) } } : b) }))}
                                            onDelete={() => { setYearData(p => ({ ...p, [selectedYear]: p[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, customDeficiencies: b.data.customDeficiencies.filter(x => x.id !== item.id) } } : b) })); setActiveModal(null); }}
                                        />
                                    ))}
                                    <button onClick={() => setYearData(p => ({ ...p, [selectedYear]: p[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, customDeficiencies: [...(b.data.customDeficiencies || []), { id: Date.now(), label: "Deficiency", status: "failed", note: "", photo: null, fixed: false }] } } : b) }))} className="w-full p-3 text-[10px] font-black text-red-200 uppercase tracking-widest">+ Add Deficiency</button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t flex flex-col gap-2 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] z-50">
                        <button onClick={() => saveAndNavigate('building-select')} className="w-full bg-green-500 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
                            Save & Exit
                        </button>
                    </div>

                    {activeModal && <Modal title={activeModal.title} isDanger={activeModal.isDanger} onCancel={() => setActiveModal(null)} onConfirm={activeModal.onConfirm} />}
                    
                    {/* Conflict Resolution Modal */}
                    {syncConflicts && syncConflicts.length > 0 && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
                            <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl relative z-10 max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="p-6 border-b">
                                    <h2 className="text-2xl font-black uppercase text-gray-800">‚ö†Ô∏è Sync Conflicts Detected</h2>
                                    <p className="text-sm text-gray-600 mt-2">
                                        Someone else modified the same fields you changed. Choose which version to keep for each conflict.
                                    </p>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6 space-y-4">
                                    {syncConflicts.map((conflict, index) => {
                                        const [selectedResolution, setSelectedResolution] = React.useState('local');
                                        
                                        return (
                                            <div key={index} className="bg-gray-50 rounded-2xl p-4 border-2 border-orange-200">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div>
                                                        <h3 className="font-bold text-gray-800">{conflict.buildingName}</h3>
                                                        <p className="text-xs text-gray-500">Field: {conflict.fieldPath}</p>
                                                    </div>
                                                    <span className="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold">
                                                        Conflict #{index + 1}
                                                    </span>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-3">
                                                    {/* Local Version */}
                                                    <button
                                                        onClick={() => {
                                                            const resolutions = {};
                                                            resolutions[index] = 'local';
                                                            setSelectedResolution('local');
                                                        }}
                                                        className={`p-3 rounded-xl border-2 transition-all text-left ${
                                                            selectedResolution === 'local'
                                                                ? 'border-blue-500 bg-blue-50'
                                                                : 'border-gray-200 bg-white'
                                                        }`}
                                                    >
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center ${
                                                                selectedResolution === 'local' ? 'border-blue-500 bg-blue-500' : 'border-gray-300'
                                                            }`}>
                                                                {selectedResolution === 'local' && (
                                                                    <div className="w-2 h-2 bg-white rounded-full"></div>
                                                                )}
                                                            </div>
                                                            <span className="font-bold text-sm text-gray-800">Your Changes</span>
                                                        </div>
                                                        <p className="text-xs text-gray-600 mb-1">
                                                            <strong>By:</strong> {conflict.localUser}
                                                        </p>
                                                        <p className="text-xs text-gray-600 mb-2">
                                                            <strong>When:</strong> {new Date(conflict.localTime).toLocaleString()}
                                                        </p>
                                                        <div className="bg-white p-2 rounded border text-xs font-mono text-gray-800">
                                                            {JSON.stringify(conflict.localValue, null, 2)}
                                                        </div>
                                                    </button>
                                                    
                                                    {/* Cloud Version */}
                                                    <button
                                                        onClick={() => {
                                                            const resolutions = {};
                                                            resolutions[index] = 'cloud';
                                                            setSelectedResolution('cloud');
                                                        }}
                                                        className={`p-3 rounded-xl border-2 transition-all text-left ${
                                                            selectedResolution === 'cloud'
                                                                ? 'border-purple-500 bg-purple-50'
                                                                : 'border-gray-200 bg-white'
                                                        }`}
                                                    >
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center ${
                                                                selectedResolution === 'cloud' ? 'border-purple-500 bg-purple-500' : 'border-gray-300'
                                                            }`}>
                                                                {selectedResolution === 'cloud' && (
                                                                    <div className="w-2 h-2 bg-white rounded-full"></div>
                                                                )}
                                                            </div>
                                                            <span className="font-bold text-sm text-gray-800">Other User's Changes</span>
                                                        </div>
                                                        <p className="text-xs text-gray-600 mb-1">
                                                            <strong>By:</strong> {conflict.cloudUser}
                                                        </p>
                                                        <p className="text-xs text-gray-600 mb-2">
                                                            <strong>When:</strong> {new Date(conflict.cloudTime).toLocaleString()}
                                                        </p>
                                                        <div className="bg-white p-2 rounded border text-xs font-mono text-gray-800">
                                                            {JSON.stringify(conflict.cloudValue, null, 2)}
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                <div className="p-6 border-t bg-gray-50 flex gap-3">
                                    <button
                                        onClick={() => setSyncConflicts(null)}
                                        className="flex-1 py-3 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl text-sm uppercase tracking-wider"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => {
                                            const resolutions = {};
                                            syncConflicts.forEach((_, index) => {
                                                resolutions[index] = 'local'; // Default to local
                                            });
                                            resolveConflicts(resolutions);
                                        }}
                                        className="flex-1 py-3 px-4 bg-blue-600 text-white font-bold rounded-xl text-sm uppercase tracking-wider"
                                    >
                                        Keep My Changes
                                    </button>
                                    <button
                                        onClick={() => {
                                            const resolutions = {};
                                            syncConflicts.forEach((_, index) => {
                                                resolutions[index] = 'cloud'; // Use cloud version
                                            });
                                            resolveConflicts(resolutions);
                                        }}
                                        className="flex-1 py-3 px-4 bg-purple-600 text-white font-bold rounded-xl text-sm uppercase tracking-wider"
                                    >
                                        Use Their Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // üõ°Ô∏è GLOBAL HELPER: Force restore default buildings (call from console if needed)
        window.forceRestoreBuildings = () => {
            console.log('üîß Force restoring default buildings...');
            localStorage.removeItem('fire_inspection_v4_data');
            console.log('‚úÖ LocalStorage cleared. Refreshing page...');
            location.reload();
        };
        
        // üîç GLOBAL HELPER: Check current data
        window.checkBuildings = () => {
            const data = JSON.parse(localStorage.getItem('fire_inspection_v4_data') || '{}');
            console.log('üìä Buildings in 2026:', data[2026]?.map(b => ({ id: b.id, name: b.name })) || 'None');
            return data;
        };
        
        console.log('üõ†Ô∏è Developer Tools Available:');
        console.log('  ‚Ä¢ window.checkBuildings() - See what buildings are stored');
        console.log('  ‚Ä¢ window.forceRestoreBuildings() - Reset to default buildings');

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('üîÑ New version available! Reload to update.');
                                    // Auto-reload after 3 seconds
                                    setTimeout(() => {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }, 3000);
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.warn('‚ö†Ô∏è Service Worker registration failed:', error);
                    });
                
                // Reload page when new service worker takes control
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }
    </script>
</body>
</html>