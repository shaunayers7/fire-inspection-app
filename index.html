<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fire Inspection App</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        
        window.FirebaseSDK = { initializeApp, getFirestore, doc, setDoc, collection, getDocs, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
    </script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F2F2F7; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            user-select: none;
            /* iOS smooth scrolling */
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            /* Fixed positioning for iOS */
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #root {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* iOS momentum scrolling for all scrollable areas */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        input, select, textarea { 
            font-size: 16px !important; 
            user-select: text;
            -webkit-user-select: text;
        }
        @media (min-width: 640px) {
            input, select, textarea { font-size: 14px !important; }
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            background-color: #F9FAFB;
        }
        
        /* Long-press Drag Animations - only block touch when actively dragging */
        .draggable-item {
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: pan-y; /* Allow vertical scrolling */
        }
        .is-dragging {
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            z-index: 99;
            opacity: 0.9;
            touch-action: none; /* Only block touch when actively dragging */
        }
        .drag-placeholder {
            border: 2px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        const DEVICE_TYPES = ["Manual Pull", "Heat Detector", "Smoke Detector", "Horn/Strobe", "Bell", "Flow Switch", "Tamper"];
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'fire-inspect-default';

        // Permanent Core Sections IDs
        const PROTECTED_SECTIONS = ['checklist', 'control', 'devices', 'battery', 'lights'];

        const getNewBuildingTemplate = (name = "New Building") => ({
            id: `b-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: name,
            lastSynced: null,
            details: {
                buildingName: name, address: "", city: "", panelLocation: "",
                manufacturer: "", panelModel: "", serialNumber: "", softwareVersion: "",
                dateManufactured: "", lastServiceDate: ""
            },
            sections: [
                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false }
            ],
            data: {
                checklist: Array(5).fill(0).map((_, i) => ({ id: `ck${i}-${Date.now()}`, label: `Checklist Item ${i+1}`, status: 'pending', note: '', photo: null, fixed: false })),
                control: Array(7).fill(0).map((_, i) => ({ id: `c${i}-${Date.now()}`, label: `Control Point ${i+1}`, status: 'pending', note: '', photo: null, fixed: false })),
                devices: Array(28).fill(0).map((_, i) => ({ id: `d${i}-${Date.now()}`, deviceNo: (i+1).toString(), label: `Device ${i+1}`, type: 'Smoke Detector', status: 'pending', note: '', photo: null, fixed: false })),
                battery: Array(7).fill(0).map((_, i) => ({ id: `b${i}-${Date.now()}`, label: `Battery Metric ${i+1}`, status: 'pending', note: '', photo: null, fixed: false })),
                lights: Array(5).fill(0).map((_, i) => ({ id: `e${i}-${Date.now()}`, label: `Emergency Light ${i+1}`, status: 'pending', note: '', photo: null, fixed: false })),
                customDeficiencies: []
            }
        });

        // --- HOOK: Long Press Drag & Drop ---
        const useDragAndDrop = (items, onReorder) => {
            const [draggingId, setDraggingId] = useState(null);
            const timerRef = useRef(null);
            const touchStartPos = useRef({ x: 0, y: 0 });
            const hasMoved = useRef(false);
            
            const onTouchStart = (id) => (e) => {
                // Record start position
                touchStartPos.current = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY
                };
                hasMoved.current = false;
                
                // Start long-press timer (1.5 seconds)
                timerRef.current = setTimeout(() => {
                    // Only activate drag if user hasn't scrolled
                    if (!hasMoved.current) {
                        setDraggingId(id);
                        if (window.navigator.vibrate) window.navigator.vibrate(50);
                    }
                }, 1500);
            };

            const onTouchMove = (id) => (e) => {
                // Check if user is scrolling (moved more than 10px)
                if (!draggingId && timerRef.current) {
                    const deltaX = Math.abs(e.touches[0].clientX - touchStartPos.current.x);
                    const deltaY = Math.abs(e.touches[0].clientY - touchStartPos.current.y);
                    
                    if (deltaY > 10 || deltaX > 10) {
                        // User is scrolling, cancel drag
                        hasMoved.current = true;
                        clearTimeout(timerRef.current);
                        timerRef.current = null;
                        return;
                    }
                }
                
                // If actively dragging, handle reorder
                if (draggingId) {
                    e.preventDefault(); // Only prevent default when actively dragging
                    const touch = e.touches[0];
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    const targetId = element?.closest('[data-drag-id]')?.getAttribute('data-drag-id');
                    
                    if (targetId && targetId !== draggingId) {
                        const fromIndex = items.findIndex(i => i.id === draggingId);
                        const toIndex = items.findIndex(i => i.id === targetId);
                        if (fromIndex !== -1 && toIndex !== -1) {
                            onReorder(fromIndex, toIndex);
                        }
                    }
                }
            };

            const onTouchEnd = () => {
                if (timerRef.current) clearTimeout(timerRef.current);
                timerRef.current = null;
                setDraggingId(null);
                hasMoved.current = false;
            };

            return { draggingId, onTouchStart, onTouchEnd, onTouchMove };
        };

        const Modal = ({ title, children, onConfirm, onCancel, confirmText = "Confirm", cancelText = "Cancel", isDanger = false, hideButtons = false }) => (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-6">
                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onCancel}></div>
                <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 overflow-hidden animate-in fade-in zoom-in duration-200">
                    <div className="p-6">
                        <h3 className="text-lg font-black uppercase text-gray-800 mb-4">{title}</h3>
                        {children}
                        {!hideButtons && (
                            <div className="flex gap-3 mt-6">
                                <button onClick={onCancel} className="flex-1 py-3 px-4 bg-gray-100 text-gray-500 font-bold rounded-xl text-xs uppercase tracking-widest">{cancelText}</button>
                                <button onClick={onConfirm} className={`flex-1 py-3 px-4 ${isDanger ? 'bg-red-500' : 'bg-blue-600'} text-white font-bold rounded-xl text-xs uppercase tracking-widest`}>{confirmText}</button>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        const TriStateButton = ({ status, onToggle }) => {
            const handleClick = (e) => {
                e.stopPropagation();
                if (status === 'pending') onToggle('passed');
                else if (status === 'passed') onToggle('failed');
                else onToggle('pending');
            };
            const baseClass = "w-10 h-10 rounded-xl flex items-center justify-center shadow-sm shrink-0 transition-all active:scale-95";
            if (status === 'passed') return <button onClick={handleClick} className={`${baseClass} bg-green-500 text-white font-bold`}>âœ“</button>;
            if (status === 'failed') return <button onClick={handleClick} className={`${baseClass} bg-red-500 text-white font-bold`}>âœ•</button>;
            return <button onClick={handleClick} className={`${baseClass} bg-gray-200 text-gray-400`}>â—‹</button>;
        };

        const InspectionRow = ({ item, index, onUpdateMeta, onDelete, isDevice = false, isDeficiencyView = false, onTriggerModal, isDragging, dragHandlers }) => {
            const [localDraft, setLocalDraft] = useState(null);
            const [isEditingNote, setIsEditingNote] = useState(false);
            const fileInputRef = useRef(null);

            const startEdit = () => setLocalDraft({ ...item });
            const saveEdit = () => { onUpdateMeta(localDraft); setLocalDraft(null); };
            const cancelEdit = () => { 
                onTriggerModal({
                    title: "Discard Changes?",
                    type: 'confirm',
                    onConfirm: () => { setLocalDraft(null); }
                });
            };
            const activeItem = localDraft || item;

            return (
                <div 
                    data-drag-id={item.id}
                    {...dragHandlers}
                    className={`bg-white border-b border-gray-100 p-4 draggable-item ${isDragging ? 'is-dragging' : ''} ${item.fixed && isDeficiencyView ? 'bg-green-50/20' : ''}`}
                >
                    <div className="flex items-start justify-between gap-4">
                        <div className="flex-1 space-y-2">
                            <div className="flex items-start gap-2">
                                <span className="text-[10px] font-black text-gray-300 mt-1">{index}.</span>
                                <div className="flex-1 space-y-1">
                                    <input 
                                        value={activeItem.label} 
                                        onFocus={startEdit}
                                        onChange={(e) => setLocalDraft({...activeItem, label: e.target.value})}
                                        className={`w-full text-sm font-bold bg-transparent border-b transition-colors ${localDraft ? 'border-blue-400 bg-blue-50' : 'border-transparent'} ${item.fixed && isDeficiencyView ? 'line-through text-gray-400' : 'text-gray-800'}`}
                                    />
                                    {isDevice && (
                                        <div className="flex gap-2">
                                            <input value={activeItem.deviceNo} onFocus={startEdit} onChange={(e) => setLocalDraft({...activeItem, deviceNo: e.target.value})} className="w-12 bg-gray-100 rounded px-1 text-[10px] font-black" />
                                            <select value={activeItem.type} onFocus={startEdit} onChange={(e) => setLocalDraft({...activeItem, type: e.target.value})} className="text-[10px] font-bold text-gray-400 uppercase bg-gray-50 px-1 rounded">
                                                {DEVICE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                            </select>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {localDraft ? (
                                <div className="flex gap-2 pl-6">
                                    <button onClick={saveEdit} className="text-[10px] bg-blue-600 text-white px-3 py-1 rounded font-bold uppercase shadow-sm">Save</button>
                                    <button onClick={cancelEdit} className="text-[10px] bg-gray-100 text-gray-400 px-3 py-1 rounded font-bold uppercase">Cancel</button>
                                </div>
                            ) : (
                                <div className="flex flex-wrap gap-4 pl-6 text-[10px] font-bold text-gray-400 uppercase">
                                    <button onClick={() => setIsEditingNote(!isEditingNote)} className="hover:text-blue-500">Note</button>
                                    <button onClick={() => fileInputRef.current.click()} className="hover:text-blue-500">Media</button>
                                    {isDeficiencyView && (
                                        <div className="flex items-center gap-1 ml-2">
                                            <input 
                                                type="checkbox" 
                                                checked={item.fixed || false} 
                                                onChange={(e) => onUpdateMeta({ fixed: e.target.checked, dateFixed: e.target.checked ? new Date().toLocaleDateString() : null })}
                                                className="w-3 h-3 accent-green-600"
                                            />
                                            <span className={item.fixed ? "text-green-600" : "text-orange-500"}>
                                                {item.fixed ? `Fixed: ${item.dateFixed}` : "Fixed?"}
                                            </span>
                                        </div>
                                    )}
                                    {onDelete && <button onClick={() => {
                                        onTriggerModal({
                                            title: "Delete Item?",
                                            type: 'confirm',
                                            isDanger: true,
                                            onConfirm: onDelete
                                        });
                                    }} className="text-red-300 ml-auto">Delete</button>}
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*,video/*" onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onloadend = () => onUpdateMeta({ photo: reader.result, mediaType: file.type.startsWith('video') ? 'video' : 'image' });
                                            reader.readAsDataURL(file);
                                        }
                                    }} />
                                </div>
                            )}
                            {(isEditingNote || item.note) && (
                                <textarea 
                                    value={item.note} 
                                    onChange={(e) => onUpdateMeta({ note: e.target.value })}
                                    className="w-full mt-2 p-2 text-xs bg-gray-50 rounded border border-gray-100"
                                    placeholder="Add notes..."
                                />
                            )}
                            {item.photo && (
                                <div className="mt-2 relative group w-24 h-24">
                                    {item.mediaType === 'video' ? (
                                        <video src={item.photo} className="w-full h-full object-cover rounded-lg border border-gray-200" />
                                    ) : (
                                        <img src={item.photo} className="w-full h-full object-cover rounded-lg border border-gray-200" />
                                    )}
                                    <button onClick={() => onUpdateMeta({ photo: null, mediaType: null })} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold">Ã—</button>
                                </div>
                            )}
                        </div>
                        {!isDeficiencyView && <TriStateButton status={item.status} onToggle={(s) => onUpdateMeta({ status: s, fixed: false, dateFixed: null })} />}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('year-select');
            const [selectedYear, setSelectedYear] = useState(2026);
            const [selectedBuildingId, setSelectedBuildingId] = useState(null);
            const [expandedSections, setExpandedSections] = useState({});
            const [activeModal, setActiveModal] = useState(null);
            const [yearInputValue, setYearInputValue] = useState("");
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, success, error
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const syncTimeoutRef = useRef(null);
            
            const [yearData, setYearData] = useState(() => {
                const saved = localStorage.getItem('fire_inspection_v4_data');
                
                // Default 2026 buildings data
                const default2026Buildings = [
                        {
                            id: "b-2026-bellevue",
                            name: "Bellevue",
                            lastSynced: null,
                            details: {
                                buildingName: "Bellevue",
                                address: "21701 28 ave Bellevue",
                                city: "Bellevue",
                                panelLocation: "Mech rm by gym",
                                manufacturer: "Edwards",
                                panelModel: "2280",
                                serialNumber: "N/A",
                                softwareVersion: "Monitored fire watch 411",
                                dateManufactured: "N/A",
                                lastServiceDate: "N/A"
                            },
                            sections: [
                                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false },
                                { id: 'custom-signal', title: 'Signal Check', color: 'bg-gray-500', isDev: false }
                            ],
                            data: {
                                checklist: [
                                    { id: "ck1-2026-bellevue", label: "Building occupants informed of test", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck2-2026-bellevue", label: "Time established to test signal devices", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck3-2026-bellevue", label: "Access to locked doors", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck4-2026-bellevue", label: "Alternate plan made to alert of actual fire", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck5-2026-bellevue", label: "System placed on test with monitoring", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                control: [
                                    { id: "c1-2026-bellevue", label: "Power on indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c2-2026-bellevue", label: "Common trouble indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c3-2026-bellevue", label: "Common trouble signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c4-2026-bellevue", label: "A/C power failure trouble", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c5-2026-bellevue", label: "Ground detection lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c6-2026-bellevue", label: "Ground detection signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c7-2026-bellevue", label: "General alarm", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c8-2026-bellevue", label: "Alarm silence", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c9-2026-bellevue", label: "Alarm silence lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c10-2026-bellevue", label: "Alarm silence inhibit", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c11-2026-bellevue", label: "Alarm initiation individually circuit tested", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c12-2026-bellevue", label: "Alarm lamp operation", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c13-2026-bellevue", label: "Alarm lamp designation checked", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c14-2026-bellevue", label: "All audible alarm signals operated on A/C", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c15-2026-bellevue", label: "Glass and doors clean", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c16-2026-bellevue", label: "Panel condition and keys", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                devices: [
                                    { id: "d1-2026-bellevue", deviceNo: "1", label: "Mech room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d2-2026-bellevue", deviceNo: "2", label: "South gym", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d3-2026-bellevue", deviceNo: "3", label: "South chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d4-2026-bellevue", deviceNo: "4", label: "North chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d5-2026-bellevue", deviceNo: "5", label: "Sacrament prep", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d6-2026-bellevue", deviceNo: "6", label: "Sound room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d7-2026-bellevue", deviceNo: "7", label: "West door main entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d8-2026-bellevue", deviceNo: "8", label: "East exit", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d9-2026-bellevue", deviceNo: "9", label: "Kitchen", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d10-2026-bellevue", deviceNo: "10", label: "Multi purpose room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d11-2026-bellevue", deviceNo: "11", label: "Member custodial", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d12-2026-bellevue", deviceNo: "12", label: "Storage room", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d13-2026-bellevue", deviceNo: "13", label: "Furnace room off storage rm", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d14-2026-bellevue", deviceNo: "14", label: "Gym", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d15-2026-bellevue", deviceNo: "15", label: "Chapel", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d16-2026-bellevue", deviceNo: "16", label: "East hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d17-2026-bellevue", deviceNo: "17", label: "Multi purpose room", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                battery: [
                                    { id: "b1-2026-bellevue", label: "Battery AC on", status: "passed", note: "31.2v dc", photo: null, fixed: false },
                                    { id: "b2-2026-bellevue", label: "Battery AC off", status: "failed", note: "20.2 v dc", photo: null, fixed: false },
                                    { id: "b3-2026-bellevue", label: "Battery under load", status: "failed", note: "V dc", photo: null, fixed: false },
                                    { id: "b4-2026-bellevue", label: "Battery clean tight terminals", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "b5-2026-bellevue", label: "Battery type", status: "passed", note: "12v 7AH", photo: null, fixed: false }
                                ],
                                lights: [
                                    { id: "e1-2026-bellevue", label: "Emergency Light 1", status: "passed", note: "Storage room - Panel B-34\nMain entry double head\nEast hall double head\nMulti purpose double head", photo: null, fixed: false },
                                    { id: "e2-2026-bellevue", label: "Emergency Light 2", status: "failed", note: "North entrance - 1x 6v\nPanel B-10\nDouble head in multi purpose rm", photo: null, fixed: false },
                                    { id: "e3-2026-bellevue", label: "Emergency Light 3", status: "passed", note: "Battery pack - Panel B-34\nDouble head x3 chapel", photo: null, fixed: false },
                                    { id: "e4-2026-bellevue", label: "Exit combo gym south", status: "passed", note: "Panel B-34", photo: null, fixed: false },
                                    { id: "e5-2026-bellevue", label: "Exit signs", status: "passed", note: "Main entrance, East exit, North exit\nMulti north/south\nGym south/north\nChapel south/north west/north south", photo: null, fixed: false }
                                ],
                                "custom-signal": [
                                    { id: "cs1-2026-bellevue", label: "Signal check with salt lake", status: "failed", note: "No account found on SLC monitoring", photo: null, fixed: false }
                                ],
                                customDeficiencies: [
                                    { id: "cd1-2026-bellevue", label: "Battery AC off voltage low", status: "failed", note: "20.2 v dc - requires replacement", photo: null, fixed: false },
                                    { id: "cd2-2026-bellevue", label: "Battery under load not tested", status: "failed", note: "Unable to complete load test", photo: null, fixed: false },
                                    { id: "cd3-2026-bellevue", label: "Emergency Light 2 - North entrance", status: "failed", note: "1x 6v battery needs replacement", photo: null, fixed: false },
                                    { id: "cd4-2026-bellevue", label: "Monitoring signal not established", status: "failed", note: "No account found on SLC monitoring", photo: null, fixed: false }
                                ]
                            }
                        },
                        {
                            id: "b-2026-pincher-creek",
                            name: "Pincher Creek",
                            lastSynced: null,
                            details: {
                                buildingName: "Pincher Creek",
                                address: "1240 Wentworth ave",
                                city: "Pincher Creek",
                                panelLocation: "Front door",
                                manufacturer: "Edwards",
                                panelModel: "Fire shield plus",
                                serialNumber: "N/A",
                                softwareVersion: "Not monitored",
                                dateManufactured: "N/A",
                                lastServiceDate: "N/A"
                            },
                            sections: [
                                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false },
                                { id: 'custom-monitoring', title: 'Signal Test', color: 'bg-gray-500', isDev: false }
                            ],
                            data: {
                                checklist: [
                                    { id: "ck1-2026-pincher", label: "Building occupants informed of test", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck2-2026-pincher", label: "Time established to test signal devices", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck3-2026-pincher", label: "Access to locked doors gained", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck4-2026-pincher", label: "Alternate plan made to alert of actual fire", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "ck5-2026-pincher", label: "System placed on test with monitoring", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                control: [
                                    { id: "c1-2026-pincher", label: "Power on indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c2-2026-pincher", label: "Common trouble indicator", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c3-2026-pincher", label: "Common trouble signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c4-2026-pincher", label: "A/C power failure trouble", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c5-2026-pincher", label: "Ground fault detection lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c6-2026-pincher", label: "Ground fault detection signal", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c7-2026-pincher", label: "General alarm", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c8-2026-pincher", label: "Alarm silence", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c9-2026-pincher", label: "Alarm silence lamp", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c10-2026-pincher", label: "Alarm silence inhibit", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c11-2026-pincher", label: "Alarm initiation individually circuit tested", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c12-2026-pincher", label: "Alarm lamp operation", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c13-2026-pincher", label: "Alarm lamp designation checked", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c14-2026-pincher", label: "All audible alarm signals operated on A/C", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c15-2026-pincher", label: "Glass and doors clean", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "c16-2026-pincher", label: "Panel condition and keys", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                devices: [
                                    { id: "d1-2026-pincher", deviceNo: "1", label: "NE entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d2-2026-pincher", deviceNo: "2", label: "SE hall", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d3-2026-pincher", deviceNo: "3", label: "SW entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d4-2026-pincher", deviceNo: "4", label: "Gym W", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d5-2026-pincher", deviceNo: "5", label: "Nw entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d6-2026-pincher", deviceNo: "6", label: "NNE entrance", type: "Manual Pull", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d7-2026-pincher", deviceNo: "7", label: "N Chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d8-2026-pincher", deviceNo: "8", label: "S chapel", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d9-2026-pincher", deviceNo: "9", label: "Men's bathroom rm D", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d10-2026-pincher", deviceNo: "10", label: "Men's bathroom rmD", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d11-2026-pincher", deviceNo: "11", label: "Kitchen", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d12-2026-pincher", deviceNo: "12", label: "Rm 105", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d13-2026-pincher", deviceNo: "13", label: "S 106", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d14-2026-pincher", deviceNo: "14", label: "S 101", type: "Smoke Detector", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d15-2026-pincher", deviceNo: "15", label: "South Hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d16-2026-pincher", deviceNo: "16", label: "Gym South", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d17-2026-pincher", deviceNo: "17", label: "North West Hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d18-2026-pincher", deviceNo: "18", label: "North Hall", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "d19-2026-pincher", deviceNo: "19", label: "Chapel North", type: "Horn/Strobe", status: "passed", note: "", photo: null, fixed: false }
                                ],
                                battery: [
                                    { id: "b1-2026-pincher", label: "A/C power on", status: "passed", note: "27.6v dc", photo: null, fixed: false },
                                    { id: "b2-2026-pincher", label: "A/C off", status: "passed", note: "26.6 v dc", photo: null, fixed: false },
                                    { id: "b3-2026-pincher", label: "Full load A/C off", status: "passed", note: "25.1", photo: null, fixed: false },
                                    { id: "b4-2026-pincher", label: "Battery clean tight terminals", status: "passed", note: "", photo: null, fixed: false },
                                    { id: "b5-2026-pincher", label: "Battery type", status: "passed", note: "12v dc 8AH", photo: null, fixed: false }
                                ],
                                lights: [
                                    { id: "e1-2026-pincher", label: "EM 1 mech rm C", status: "failed", note: "Panel C-16 12v 7.2Ah", photo: null, fixed: false },
                                    { id: "e2-2026-pincher", label: "EM 2", status: "passed", note: "Panel C -16", photo: null, fixed: false },
                                    { id: "e3-2026-pincher", label: "EM 3", status: "failed", note: "Panel C -16 6v 5 ah", photo: null, fixed: false },
                                    { id: "e4-2026-pincher", label: "EM 4", status: "passed", note: "Panel R -8", photo: null, fixed: false },
                                    { id: "e5-2026-pincher", label: "EM 5", status: "passed", note: "Panel R -4", photo: null, fixed: false },
                                    { id: "e6-2026-pincher", label: "EM 6 member custodial rm", status: "failed", note: "Panel A -9 1-6v 5 AH", photo: null, fixed: false },
                                    { id: "e7-2026-pincher", label: "EM 7 mech rm A", status: "passed", note: "Panel N -1", photo: null, fixed: false },
                                    { id: "e8-2026-pincher", label: "Exit signs", status: "passed", note: "SW exit, SE exit, S Hall, NE exit, Gym NE, NW exit, N hall, NNE exit, Chapel E, Chapel W, Over flow S", photo: null, fixed: false }
                                ],
                                "custom-monitoring": [
                                    { id: "cm1-2026-pincher", label: "Signal test", status: "passed", note: "SLC monitoring no account", photo: null, fixed: false }
                                ],
                                customDeficiencies: [
                                    { id: "cd1-2026-pincher", label: "EM 1 mech rm C - Battery replacement needed", status: "failed", note: "Panel C-16 12v 7.2Ah", photo: null, fixed: false },
                                    { id: "cd2-2026-pincher", label: "EM 3 - Battery replacement needed", status: "failed", note: "Panel C -16 6v 5 ah", photo: null, fixed: false },
                                    { id: "cd3-2026-pincher", label: "EM 6 member custodial rm - Battery replacement needed", status: "failed", note: "Panel A -9 1-6v 5 AH", photo: null, fixed: false }
                                ]
                            }
                        }
                ];
                
                // CRITICAL: Merge logic per PRD - never overwrite, always merge
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    
                    // Ensure 2026 exists
                    if (!parsedData[2026]) {
                        parsedData[2026] = [];
                    }
                    
                    // PROTECTION: Always ensure default buildings exist (merge, don't replace)
                    for (const defaultBuilding of default2026Buildings) {
                        const exists = parsedData[2026].some(b => b.id === defaultBuilding.id);
                        if (!exists) {
                            console.warn(`ðŸ›¡ï¸ PROTECTION: Restoring missing building: ${defaultBuilding.name}`);
                            parsedData[2026].push(defaultBuilding);
                        }
                    }
                    
                    console.log(`âœ… Data loaded. Buildings in 2026:`, parsedData[2026].map(b => b.name));
                    return parsedData;
                }
                
                // No saved data - return fresh structure
                console.log('ðŸ†• No saved data found. Creating fresh data with default buildings.');
                return {
                    2025: [],
                    2026: default2026Buildings
                };
            });

            useEffect(() => {
                const initFirebase = async () => {
                    const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                    const config = JSON.parse(__firebase_config);
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const firestore = getFirestore(app);
                    setDb(firestore);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    onAuthStateChanged(auth, async (currentUser) => {
                        setUser(currentUser);
                        if (currentUser && firestore) {
                            // Load cloud data when user is ready
                            await loadFromCloud(firestore);
                        }
                    });
                };
                initFirebase();
            }, []);

            useEffect(() => {
                localStorage.setItem('fire_inspection_v4_data', JSON.stringify(yearData));
                
                // Auto-sync with debounce (5 seconds after last change)
                if (db && user) {
                    if (syncTimeoutRef.current) clearTimeout(syncTimeoutRef.current);
                    syncTimeoutRef.current = setTimeout(() => {
                        syncToCloud();
                    }, 5000);
                }
            }, [yearData]);

            const activeBuilding = (yearData[selectedYear] || []).find(b => b.id === selectedBuildingId);

            // --- CLOUD SYNC FUNCTIONS ---
            const syncToCloud = async () => {
                if (!db || !user) {
                    console.log('Firebase not ready for sync');
                    return;
                }
                
                try {
                    setSyncStatus('syncing');
                    const { setDoc, doc } = window.FirebaseSDK;
                    const syncTime = new Date().toISOString();
                    
                    // Sync all buildings from all years
                    const syncPromises = [];
                    for (const [year, buildings] of Object.entries(yearData)) {
                        for (const building of buildings) {
                            const buildingWithSync = {
                                ...building,
                                lastSynced: syncTime,
                                year: parseInt(year)
                            };
                            const docRef = doc(db, `apps/${APP_ID}/buildings/${building.id}`);
                            syncPromises.push(setDoc(docRef, buildingWithSync));
                        }
                    }
                    
                    await Promise.all(syncPromises);
                    setLastSyncTime(syncTime);
                    setSyncStatus('success');
                    
                    // Update local data with sync time
                    setYearData(prev => {
                        const updated = { ...prev };
                        for (const year in updated) {
                            updated[year] = updated[year].map(b => ({ ...b, lastSynced: syncTime }));
                        }
                        return updated;
                    });
                    
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('error');
                    setTimeout(() => setSyncStatus('idle'), 3000);
                }
            };
            
            const loadFromCloud = async (firestore = db) => {
                if (!firestore) return;
                
                try {
                    const { collection, getDocs } = window.FirebaseSDK;
                    const buildingsRef = collection(firestore, `apps/${APP_ID}/buildings`);
                    const snapshot = await getDocs(buildingsRef);
                    
                    if (snapshot.empty) {
                        console.log('No cloud data found, using local data');
                        return;
                    }
                    
                    const cloudBuildings = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const year = data.year || 2026;
                        if (!cloudBuildings[year]) cloudBuildings[year] = [];
                        cloudBuildings[year].push(data);
                    });
                    
                    // Merge cloud and local data (cloud wins if newer)
                    setYearData(prev => {
                        const merged = { ...prev };
                        
                        for (const [year, cloudBuildingsInYear] of Object.entries(cloudBuildings)) {
                            const localBuildingsInYear = merged[year] || [];
                            const mergedBuildings = [...cloudBuildingsInYear];
                            
                            // Add local buildings that don't exist in cloud
                            for (const localBuilding of localBuildingsInYear) {
                                const existsInCloud = cloudBuildingsInYear.some(cb => cb.id === localBuilding.id);
                                if (!existsInCloud) {
                                    console.log(`ðŸ“¥ Keeping local building: ${localBuilding.name}`);
                                    mergedBuildings.push(localBuilding);
                                } else {
                                    // If exists in both, check which is newer
                                    const cloudVersion = cloudBuildingsInYear.find(cb => cb.id === localBuilding.id);
                                    const cloudTime = new Date(cloudVersion.lastSynced || 0);
                                    const localTime = new Date(localBuilding.lastSynced || 0);
                                    
                                    if (localTime > cloudTime) {
                                        // Replace cloud version with local
                                        const idx = mergedBuildings.findIndex(b => b.id === localBuilding.id);
                                        mergedBuildings[idx] = localBuilding;
                                        console.log(`ðŸ”„ Local version newer for: ${localBuilding.name}`);
                                    } else {
                                        console.log(`â˜ï¸ Cloud version newer for: ${localBuilding.name}`);
                                    }
                                }
                            }
                            
                            merged[year] = mergedBuildings;
                        }
                        
                        // ðŸ›¡ï¸ CRITICAL PROTECTION: Even after cloud sync, ensure default buildings exist
                        // This prevents cloud data from deleting Bellevue or Pincher Creek
                        if (!merged[2026]) merged[2026] = [];
                        
                        const default2026Buildings = [
                            getNewBuildingTemplate("Bellevue"),  // Will be replaced below with actual data
                            getNewBuildingTemplate("Pincher Creek")
                        ];
                        
                        // Get the actual default buildings from the initialization
                        const actualDefaults = [
                            { id: "b-2026-bellevue", name: "Bellevue" },
                            { id: "b-2026-pincher-creek", name: "Pincher Creek" }
                        ];
                        
                        for (const checkBuilding of actualDefaults) {
                            const exists = merged[2026].some(b => b.id === checkBuilding.id);
                            if (!exists) {
                                console.error(`ðŸš¨ ALERT: ${checkBuilding.name} missing after cloud sync! This should not happen. Check Firebase data.`);
                                console.log(`âš ï¸ Building ${checkBuilding.name} will be restored on next page reload.`);
                            }
                        }
                        
                        console.log(`â˜ï¸ Cloud sync complete. Buildings in 2026:`, merged[2026].map(b => b.name));
                        return merged;
                    });
                    
                    const latestSync = snapshot.docs.reduce((latest, doc) => {
                        const syncTime = doc.data().lastSynced;
                        return syncTime && (!latest || syncTime > latest) ? syncTime : latest;
                    }, null);
                    
                    if (latestSync) setLastSyncTime(latestSync);
                    console.log('Loaded from cloud:', cloudBuildings);
                } catch (error) {
                    console.error('Load from cloud error:', error);
                }
            };

            // --- REORDER LOGIC ---
            const moveSection = (fromIndex, toIndex) => {
                setYearData(prev => {
                    const currentYearBuildings = prev[selectedYear];
                    const bIdx = currentYearBuildings.findIndex(b => b.id === selectedBuildingId);
                    const building = currentYearBuildings[bIdx];
                    const newSections = [...building.sections];
                    const [removed] = newSections.splice(fromIndex, 1);
                    newSections.splice(toIndex, 0, removed);
                    
                    const updatedBuildings = [...currentYearBuildings];
                    updatedBuildings[bIdx] = { ...building, sections: newSections };
                    return { ...prev, [selectedYear]: updatedBuildings };
                });
            };

            const sectionDrag = useDragAndDrop(activeBuilding?.sections || [], moveSection);

            const getBuildingStatus = (building) => {
                let pending = 0;
                let unfixed = 0;
                let totalDefs = 0;
                Object.keys(building.data).forEach(key => {
                    if (Array.isArray(building.data[key])) {
                        building.data[key].forEach(item => {
                            if (item.status === 'pending') pending++;
                            if (item.status === 'failed') {
                                totalDefs++;
                                if (!item.fixed) unfixed++;
                            }
                        });
                    }
                });
                if (pending === 0 && unfixed === 0) return { text: 'Complete', class: 'text-green-500' };
                if (pending === 0) return { text: `Inspected ${totalDefs}`, class: 'text-blue-500' };
                return { text: 'In Progress', class: 'text-orange-400' };
            };

            const handleExport = async () => {
                if (!activeBuilding) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const statusInfo = getBuildingStatus(activeBuilding);

                let currentY = 20;
                const margin = 14;
                const pageHeight = doc.internal.pageSize.height;

                const checkNewPage = (neededHeight) => {
                    if (currentY + neededHeight > pageHeight - 20) {
                        doc.addPage();
                        currentY = 20;
                        return true;
                    }
                    return false;
                };

                doc.setFontSize(20).setFont("helvetica", "bold").text("FIRE INSPECTION REPORT", 105, currentY, { align: "center" });
                currentY += 10;
                doc.setFontSize(10).setFont("helvetica", "normal").text(`Year: ${selectedYear} | Status: ${statusInfo.text}`, 105, currentY, { align: "center" });
                currentY += 5;
                doc.text(`Building: ${activeBuilding.name}`, 105, currentY, { align: "center" });
                currentY += 15;

                doc.setFontSize(14).setFont("helvetica", "bold").text("1. BUILDING DETAILS", margin, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: [['FIELD', 'INFORMATION']],
                    body: Object.entries(activeBuilding.details).map(([k, v]) => [k.replace(/([A-Z])/g, ' $1').toUpperCase(), v || 'N/A']),
                    theme: 'striped',
                    headStyles: { fillColor: [37, 99, 235] },
                    didDrawPage: (data) => { currentY = data.cursor.y + 15; }
                });

                activeBuilding.sections.forEach((s, idx) => {
                    checkNewPage(10);
                    doc.setFontSize(14).setFont("helvetica", "bold").text(`${idx + 2}. ${s.title.toUpperCase()}`, margin, currentY);
                    currentY += 5;

                    const items = activeBuilding.data[s.id];
                    doc.autoTable({
                        startY: currentY,
                        head: [['#', 'DEV #', 'ITEM NAME', 'STATUS', 'NOTES']],
                        body: items.map((item, i) => [i + 1, s.isDev ? item.deviceNo : '-', item.label, item.status.toUpperCase(), item.note || '-']),
                        theme: 'grid',
                        headStyles: { fillColor: [30, 41, 54] },
                        didDrawPage: (data) => { currentY = data.cursor.y + 10; }
                    });
                });

                // Export Deficiencies Section
                const allDeficienciesForExport = [];
                activeBuilding.sections.forEach(s => {
                    activeBuilding.data[s.id].forEach(i => { 
                        if (i.status === 'failed') {
                            allDeficienciesForExport.push({ ...i, section: s.title, deviceNo: s.isDev ? i.deviceNo : '-' }); 
                        }
                    });
                });
                const customDefs = activeBuilding.data.customDeficiencies || [];
                
                if (allDeficienciesForExport.length > 0 || customDefs.length > 0) {
                    checkNewPage(10);
                    doc.setFontSize(14).setFont("helvetica", "bold").text(`${activeBuilding.sections.length + 2}. DEFICIENCIES`, margin, currentY);
                    currentY += 5;

                    const allDeficiencyItems = [
                        ...allDeficienciesForExport.map(item => ({
                            section: item.section,
                            deviceNo: item.deviceNo,
                            label: item.label,
                            note: item.note || '-',
                            fixed: item.fixed ? 'YES' : 'NO'
                        })),
                        ...customDefs.map(item => ({
                            section: 'Custom',
                            deviceNo: '-',
                            label: item.label,
                            note: item.note || '-',
                            fixed: item.fixed ? 'YES' : 'NO'
                        }))
                    ];

                    doc.autoTable({
                        startY: currentY,
                        head: [['#', 'SECTION', 'DEV #', 'ITEM NAME', 'NOTES', 'FIXED']],
                        body: allDeficiencyItems.map((item, i) => [i + 1, item.section.toUpperCase(), item.deviceNo, item.label, item.note, item.fixed]),
                        theme: 'grid',
                        headStyles: { fillColor: [220, 38, 38] },
                        didDrawPage: (data) => { currentY = data.cursor.y + 10; }
                    });
                }

                doc.save(`${activeBuilding.name}_Report_${selectedYear}.pdf`);
            };

            const updateItem = (sect, id, meta) => {
                setYearData(prev => ({
                    ...prev,
                    [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? {
                        ...b, data: { ...b.data, [sect]: b.data[sect].map(i => i.id === id ? { ...i, ...meta } : i) }
                    } : b)
                }));
            };

            const updateBuildingDetail = (key, value) => {
                setYearData(prev => ({
                    ...prev,
                    [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? (key === 'buildingName' ? { ...b, name: value, details: { ...b.details, [key]: value } } : { ...b, details: { ...b.details, [key]: value } }) : b)
                }));
            };

            if (view === 'year-select') return (
                <div className="p-4 space-y-4">
                    <h1 className="text-xl font-black uppercase tracking-tighter text-gray-800">Annual Inspections</h1>
                    {Object.keys(yearData).sort().reverse().map(year => (
                        <div key={year} onClick={() => { setSelectedYear(year); setView('building-select'); }} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:bg-gray-50">
                            <span className="font-bold text-lg text-gray-700">Year {year}</span>
                            <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">{yearData[year].length} Buildings</span>
                        </div>
                    ))}
                    <button onClick={() => setActiveModal({ type: 'input', title: 'Add New Year', onConfirm: (val) => { if(val && !yearData[val]) setYearData(prev => ({ ...prev, [val]: [] })); setActiveModal(null); } })} className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add Year</button>
                    {activeModal?.type === 'input' && (
                        <Modal title={activeModal.title} onCancel={() => setActiveModal(null)} onConfirm={() => activeModal.onConfirm(yearInputValue)}>
                            <input type="number" autoFocus value={yearInputValue} onChange={(e) => setYearInputValue(e.target.value)} placeholder="e.g. 2026" className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl text-center text-xl font-bold" />
                        </Modal>
                    )}
                </div>
            );

            if (view === 'building-select') return (
                <div className="p-4 space-y-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <button onClick={() => setView('year-select')} className="text-blue-600 font-bold p-1">â†</button>
                            <h1 className="text-xl font-black uppercase">Buildings {selectedYear}</h1>
                        </div>
                        <button 
                            onClick={() => syncToCloud()} 
                            disabled={syncStatus === 'syncing'}
                            className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${
                                syncStatus === 'syncing' ? 'bg-blue-100 text-blue-400' :
                                syncStatus === 'success' ? 'bg-green-500 text-white' :
                                syncStatus === 'error' ? 'bg-red-500 text-white' :
                                'bg-blue-600 text-white active:scale-95'
                            }`}
                        >
                            {syncStatus === 'syncing' ? 'âŸ³ Syncing...' :
                             syncStatus === 'success' ? 'âœ“ Synced' :
                             syncStatus === 'error' ? 'âœ• Error' :
                             'â˜ Sync'}
                        </button>
                    </div>
                    {lastSyncTime && (
                        <div className="text-[10px] text-gray-400 text-center font-semibold">
                            Last synced: {new Date(lastSyncTime).toLocaleString()}
                        </div>
                    )}
                    {yearData[selectedYear].map(b => {
                        const status = getBuildingStatus(b);
                        return (
                            <div key={b.id} onClick={() => { setSelectedBuildingId(b.id); setView('form'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer">
                                <div>
                                    <h3 className="font-bold text-gray-800">{b.name}</h3>
                                    <span className={`text-[10px] font-black uppercase tracking-wide ${status.class}`}>{status.text}</span>
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); setActiveModal({ type: 'confirm', title: 'Delete Building?', isDanger: true, onConfirm: () => { setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].filter(x => x.id !== b.id) })); setActiveModal(null); } }); }} className="text-red-200 p-2 text-xl">âœ•</button>
                            </div>
                        );
                    })}
                    <button onClick={() => setYearData(prev => ({ ...prev, [selectedYear]: [...prev[selectedYear], getNewBuildingTemplate(`New Building ${yearData[selectedYear].length + 1}`)] }))} className="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add Building</button>
                    {activeModal?.type === 'confirm' && <Modal title={activeModal.title} isDanger={activeModal.isDanger} onCancel={() => setActiveModal(null)} onConfirm={activeModal.onConfirm} />}
                </div>
            );

            const allDeficiencies = [];
            if (activeBuilding) {
                activeBuilding.sections.forEach(s => {
                    activeBuilding.data[s.id].forEach(i => { if (i.status === 'failed') allDeficiencies.push({ ...i, section: s.id }); });
                });
            }

            return (
                <div className="pb-44">
                    <div className="bg-white p-4 sticky top-0 border-b z-50">
                        <div className="flex justify-between items-center mb-2">
                            <button onClick={() => setView('building-select')} className="text-blue-600 font-bold px-2 py-1">â† Save</button>
                            <h2 className="font-black uppercase text-xs tracking-tight text-gray-600 truncate max-w-[40%]">{activeBuilding.name}</h2>
                            <button onClick={handleExport} className="bg-gray-50 p-2 rounded-lg text-blue-600 font-black text-[10px] uppercase border shadow-sm">Export PDF</button>
                        </div>
                        {syncStatus !== 'idle' && (
                            <div className={`text-[9px] font-bold text-center py-1 rounded ${
                                syncStatus === 'syncing' ? 'bg-blue-50 text-blue-600' :
                                syncStatus === 'success' ? 'bg-green-50 text-green-600' :
                                'bg-red-50 text-red-600'
                            }`}>
                                {syncStatus === 'syncing' ? 'â˜ Syncing to cloud...' :
                                 syncStatus === 'success' ? 'âœ“ Synced successfully' :
                                 'âœ• Sync failed - will retry'}
                            </div>
                        )}
                    </div>

                    <div className="p-4 space-y-3">
                        {/* Permanent Section 1: Details */}
                        <div className="rounded-xl border overflow-hidden shadow-sm">
                            <button onClick={() => setExpandedSections(p => ({...p, details: !p.details}))} className="w-full bg-blue-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
                                <span>1. Building Details</span>
                                <span className="text-lg opacity-50">{expandedSections['details'] ? 'âˆ’' : '+'}</span>
                            </button>
                            {expandedSections['details'] && (
                                <div className="bg-white p-4 grid grid-cols-1 gap-4">
                                    {Object.keys(activeBuilding.details).map(k => (
                                        <div key={k} className="space-y-1">
                                            <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest">{k.replace(/([A-Z])/g, ' $1')}</label>
                                            <input value={activeBuilding.details[k]} onChange={(e) => updateBuildingDetail(k, e.target.value)} className="w-full border-b border-gray-100 py-1 font-semibold text-gray-700 focus:border-blue-500" />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Reorderable Sections 2..N */}
                        {activeBuilding.sections.map((s, idx) => {
                            const isSectionDragging = sectionDrag.draggingId === s.id;
                            const isProtected = PROTECTED_SECTIONS.includes(s.id);

                            return (
                                <div 
                                    key={s.id} 
                                    data-drag-id={s.id}
                                    onTouchStart={sectionDrag.onTouchStart(s.id)}
                                    onTouchMove={sectionDrag.onTouchMove(s.id)}
                                    onTouchEnd={sectionDrag.onTouchEnd}
                                    className={`rounded-xl border overflow-hidden shadow-sm draggable-item ${isSectionDragging ? 'is-dragging' : ''}`}
                                >
                                    <div className={`w-full ${s.color} text-white p-3 flex justify-between items-center`}>
                                        <button 
                                            onClick={() => setExpandedSections(p => ({...p, [s.id]: !p[s.id]}))} 
                                            className="flex-1 text-left font-bold text-xs uppercase"
                                        >
                                            <span>{idx + 2}. {s.title}</span>
                                        </button>
                                        <div className="flex items-center gap-4">
                                            {!isProtected && (
                                                <button onClick={(e) => {
                                                    e.stopPropagation();
                                                    setActiveModal({
                                                        title: "Delete Section?",
                                                        isDanger: true,
                                                        onConfirm: () => {
                                                            setYearData(prev => ({
                                                                ...prev,
                                                                [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? {
                                                                    ...b,
                                                                    sections: b.sections.filter(x => x.id !== s.id)
                                                                } : b)
                                                            }));
                                                            setActiveModal(null);
                                                        }
                                                    });
                                                }} className="text-white/40 hover:text-white text-lg">âœ•</button>
                                            )}
                                            <button onClick={() => setExpandedSections(p => ({...p, [s.id]: !p[s.id]}))} className="text-lg opacity-50">
                                                {expandedSections[s.id] ? 'âˆ’' : '+'}
                                            </button>
                                        </div>
                                    </div>
                                    {expandedSections[s.id] && (
                                        <div className="bg-white">
                                            {activeBuilding.data[s.id]?.map((item, i) => (
                                                <InspectionRow 
                                                    key={item.id} index={i+1} item={item} isDevice={s.isDev} 
                                                    onUpdateMeta={(m) => updateItem(s.id, item.id, m)}
                                                    onTriggerModal={setActiveModal}
                                                    onDelete={() => {
                                                        setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, [s.id]: b.data[s.id].filter(x => x.id !== item.id) } } : b) }));
                                                        setActiveModal(null);
                                                    }}
                                                />
                                            ))}
                                            <button onClick={() => setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, [s.id]: [...(b.data[s.id] || []), { id: Date.now(), label: "New Item", status: "pending", note: "", photo: null, fixed: false }] } } : b) }))} className="w-full p-3 text-[10px] font-black text-gray-300 uppercase tracking-widest">+ Add Item</button>
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        <button onClick={() => {
                            const newId = `sect-${Date.now()}`;
                            setYearData(prev => ({ ...prev, [selectedYear]: prev[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, sections: [...b.sections, { id: newId, title: 'Custom Section', color: 'bg-gray-500', isDev: false }], data: { ...b.data, [newId]: [] } } : b) }));
                        }} className="w-full p-3 border-2 border-dashed rounded-xl text-gray-400 font-bold uppercase text-[10px]">+ Add New Section</button>

                        {/* Deficiencies Section (Permanent Last Item) */}
                        <div className="rounded-xl border border-red-200 overflow-hidden shadow-sm">
                            <button onClick={() => setExpandedSections(p => ({...p, defs: !p.defs}))} className="w-full bg-red-600 text-white p-3 text-left font-bold text-xs uppercase flex justify-between items-center">
                                <span>{activeBuilding.sections.length + 2}. Deficiencies</span>
                                <div className="flex items-center gap-3">
                                    <span className="bg-white/20 px-2 rounded-md text-[10px]">{allDeficiencies.length + (activeBuilding.data.customDeficiencies?.length || 0)}</span>
                                    <span className="text-lg opacity-50">{expandedSections['defs'] ? 'âˆ’' : '+'}</span>
                                </div>
                            </button>
                            {expandedSections['defs'] && (
                                <div className="bg-white">
                                    {allDeficiencies.map((item, i) => (
                                        <InspectionRow key={item.id} index={i+1} item={item} isDeficiencyView onUpdateMeta={(m) => updateItem(item.section, item.id, m)} onTriggerModal={setActiveModal} />
                                    ))}
                                    {(activeBuilding.data.customDeficiencies || []).map((item, i) => (
                                        <InspectionRow 
                                            key={item.id} index={allDeficiencies.length + i + 1} item={item} isDeficiencyView 
                                            onTriggerModal={setActiveModal}
                                            onUpdateMeta={(m) => setYearData(p => ({ ...p, [selectedYear]: p[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, customDeficiencies: b.data.customDeficiencies.map(x => x.id === item.id ? {...x, ...m} : x) } } : b) }))}
                                            onDelete={() => { setYearData(p => ({ ...p, [selectedYear]: p[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, customDeficiencies: b.data.customDeficiencies.filter(x => x.id !== item.id) } } : b) })); setActiveModal(null); }}
                                        />
                                    ))}
                                    <button onClick={() => setYearData(p => ({ ...p, [selectedYear]: p[selectedYear].map(b => b.id === selectedBuildingId ? { ...b, data: { ...b.data, customDeficiencies: [...(b.data.customDeficiencies || []), { id: Date.now(), label: "Deficiency", status: "failed", note: "", photo: null, fixed: false }] } } : b) }))} className="w-full p-3 text-[10px] font-black text-red-200 uppercase tracking-widest">+ Add Deficiency</button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t flex flex-col gap-2 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] z-50">
                        <button onClick={() => setView('building-select')} className="w-full bg-green-500 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
                            Save & Exit
                        </button>
                    </div>

                    {activeModal && <Modal title={activeModal.title} isDanger={activeModal.isDanger} onCancel={() => setActiveModal(null)} onConfirm={activeModal.onConfirm} />}
                </div>
            );
        };

        // ðŸ›¡ï¸ GLOBAL HELPER: Force restore default buildings (call from console if needed)
        window.forceRestoreBuildings = () => {
            console.log('ðŸ”§ Force restoring default buildings...');
            localStorage.removeItem('fire_inspection_v4_data');
            console.log('âœ… LocalStorage cleared. Refreshing page...');
            location.reload();
        };
        
        // ðŸ” GLOBAL HELPER: Check current data
        window.checkBuildings = () => {
            const data = JSON.parse(localStorage.getItem('fire_inspection_v4_data') || '{}');
            console.log('ðŸ“Š Buildings in 2026:', data[2026]?.map(b => ({ id: b.id, name: b.name })) || 'None');
            return data;
        };
        
        console.log('ðŸ› ï¸ Developer Tools Available:');
        console.log('  â€¢ window.checkBuildings() - See what buildings are stored');
        console.log('  â€¢ window.forceRestoreBuildings() - Reset to default buildings');

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
