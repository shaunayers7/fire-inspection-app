<!DOCTYPE html>
<html>
<head>
    <title>Auto-Import 2025 Buildings</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-top: 0;
            font-size: 32px;
        }
        .status {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        .loading { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        .success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .building-list {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .building-item {
            padding: 10px;
            margin: 6px 0;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .building-item strong { color: #667eea; font-size: 14px; }
        .building-item .panel { color: #666; font-size: 12px; }
        .building-item .status { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .building-item .status.success { background: #d4edda; color: #155724; }
        .building-item .status.failed { background: #f8d7da; color: #721c24; }
        .button {
            margin-top: 20px;
            padding: 14px 28px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover { background: #5568d3; }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì• Import All 2025 Inspection Reports</h1>
        <div id="status" class="status loading">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="spinner"></div>
                <div>Initializing...</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress" style="width: 0%">0%</div>
            </div>
        </div>
        <div id="buildings" class="building-list" style="display: none;"></div>
        <div id="actions" style="display: none;">
            <a href="index.html" class="button">üöÄ Open App & View 2025 Buildings</a>
        </div>
    </div>

    <script>
        // Building template function
        const getNewBuildingTemplate = (name = 'New Building', address = '', city = '', initialStatus = 'not-started') => ({
            id: `b-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name,
            lastSynced: null,
            details: {
                buildingName: name,
                address: address,
                city: city,
                panelLocation: '',
                manufacturer: '',
                panelModel: '',
                serialNumber: 'N/A',
                softwareVersion: 'N/A',
                dateManufactured: 'N/A',
                lastServiceDate: 'N/A'
            },
            sections: [
                { id: 'checklist', title: 'Pre-job checklist', color: 'bg-orange-500', isDev: false },
                { id: 'control', title: 'control equipment', color: 'bg-purple-600', isDev: false },
                { id: 'devices', title: 'Device inventory', color: 'bg-[#1C252E]', isDev: true },
                { id: 'battery', title: 'Battery health', color: 'bg-blue-500', isDev: false },
                { id: 'lights', title: 'Emergency lights', color: 'bg-[#EAB308]', isDev: false }
            ],
            data: {
                checklist: Array(5).fill(0).map((_, i) => ({ id: `ck${i}-${Date.now()}`, label: `Checklist Item ${i+1}`, status: initialStatus, note: '', photo: null, fixed: false })),
                control: Array(16).fill(0).map((_, i) => ({ id: `c${i}-${Date.now()}`, label: `Control Equipment ${i+1}`, status: initialStatus, note: '', photo: null, fixed: false })),
                devices: Array(10).fill(0).map((_, i) => ({ id: `d${i}-${Date.now()}`, deviceNo: `${i+1}`, label: `Device ${i+1}`, type: 'Smoke Detector', status: initialStatus, note: '', photo: null, fixed: false })),
                battery: [
                    { id: `b1-${Date.now()}`, label: 'Battery voltage AC on', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b2-${Date.now()}`, label: 'Battery under load', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b3-${Date.now()}`, label: 'Battery clean tight terminals', status: initialStatus, note: '', photo: null, fixed: false },
                    { id: `b4-${Date.now()}`, label: 'Battery type', status: initialStatus, note: '', photo: null, fixed: false }
                ],
                lights: Array(5).fill(0).map((_, i) => ({ id: `e${i}-${Date.now()}`, label: `Emergency Light ${i+1}`, status: initialStatus, note: '', photo: null, fixed: false })),
                customDeficiencies: []
            }
        });

        // Parse import text function (enhanced version from index.html)
        const parseImportText = (text) => {
            const fullText = text.trim();
            if (!fullText) return [];
            
            const lines = fullText.split('\\n').map(l => l.trim());
            const buildings = [];
            
            const isDetailedReport = fullText.includes('Fire Alarm panel') || 
                                    fullText.includes('Annual Fire Alarm Inspection Report') ||
                                    fullText.includes('FIRE INSPECTION REPORT') ||
                                    (fullText.includes('Client:') && fullText.includes('Building:')) ||
                                    fullText.includes('Manufacturer:') ||
                                    fullText.includes('MANUFACTURER');
            
            if (isDetailedReport) {
                let buildingName = '', address = '', city = '', manufacturer = '', panelModel = '', panelLocation = '';
                let serialNumber = '', softwareVersion = '', dateManufactured = '', lastServiceDate = '';
                
                const getNextLineValue = (idx) => {
                    if (idx + 1 < lines.length) {
                        const nextLine = lines[idx + 1].trim();
                        if (!nextLine.match(/^(BUILDING NAME|ADDRESS|CITY|PANEL LOCATION|MANUFACTURER|PANEL MODEL|SERIAL NUMBER|SOFTWARE VERSION|DATE MANUFACTURED|LAST SERVICE DATE)$/i)) {
                            return nextLine;
                        }
                    }
                    return '';
                };
                
                lines.forEach((line, idx) => {
                    if (line.length === 0) return;
                    
                    if (line.match(/^BUILDING NAME$/i)) {
                        const value = getNextLineValue(idx);
                        if (value && !buildingName) buildingName = value;
                    }
                    if (line.match(/^ADDRESS$/i)) {
                        const value = getNextLineValue(idx);
                        if (value && !address) address = value;
                    }
                    if (line.match(/^CITY$/i)) {
                        const value = getNextLineValue(idx);
                        if (value && !city) city = value;
                    }
                    if (line.match(/^PANEL LOCATION$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) panelLocation = value;
                    }
                    if (line.match(/^MANUFACTURER$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) manufacturer = value;
                    }
                    if (line.match(/^PANEL MODEL$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) panelModel = value;
                    }
                    if (line.match(/^SERIAL NUMBER$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) serialNumber = value;
                    }
                    if (line.match(/^SOFTWARE VERSION$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) softwareVersion = value;
                    }
                    if (line.match(/^DATE MANUFACTURED$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) dateManufactured = value;
                    }
                    if (line.match(/^LAST SERVICE DATE$/i)) {
                        const value = getNextLineValue(idx);
                        if (value) lastServiceDate = value;
                    }
                    
                    if (line.includes('Manufacturer:')) {
                        const mfgMatch = line.match(/Manufacturer:\\s*([A-Za-z0-9]+)/i);
                        if (mfgMatch && !manufacturer) manufacturer = mfgMatch[1];
                        const modelMatch = line.match(/Model\\s*#?:\\s*(.+?)(?=\\s*Panel\\s+Located|\\s*$)/i);
                        if (modelMatch && !panelModel) {
                            panelModel = modelMatch[1].trim();
                        }
                    }
                    
                    if (line.match(/^Panel\\s+Located/i)) {
                        const locValue = line.replace(/^Panel\\s+Located\\s*/i, '').trim();
                        if (locValue && !panelLocation) panelLocation = locValue;
                    }
                    
                    if (/^(Client:|Building:|Date:|Comments?:?|Address:)(\\s+(Client:|Building:|Date:|Comments?:?|Address:))*\\s*$/i.test(line)) {
                        return;
                    }
                    
                    if (idx > 0 && !buildingName && !line.includes('Manufacturer:') && !line.includes('Panel Located')) {
                        const prevLine = lines[idx - 1];
                        if (/^(Client:|Building:|Date:|Comments?:?|Address:)/i.test(prevLine)) {
                            let cleanText = line.trim();
                            cleanText = cleanText.replace(/^LDS Church\\s*[-‚Äì‚Äî]\\s*/i, '').trim();
                            const words = cleanText.split(/\\s+/).filter(w => w.length > 0);
                            
                            if (words.length >= 1) {
                                let streetIdx = -1;
                                for (let i = 0; i < words.length; i++) {
                                    if (/^(St\\.?|Ave\\.?|Avenue|Street|Rd\\.?|Road|Dr\\.?|Drive|Blvd\\.?|Boulevard|Lane|Way|Parkway|Court|Ct\\.?)$/i.test(words[i])) {
                                        streetIdx = i;
                                        break;
                                    }
                                }
                                
                                if (streetIdx > 0) {
                                    city = words[words.length - 1];
                                    let addressStart = streetIdx - 1;
                                    for (let i = streetIdx - 1; i >= 0; i--) {
                                        if (/^\\d/.test(words[i])) {
                                            addressStart = i;
                                            break;
                                        }
                                    }
                                    buildingName = words.slice(0, addressStart).join(' ');
                                    address = words.slice(addressStart, streetIdx + 1).join(' ');
                                } else {
                                    city = words[words.length - 1];
                                    buildingName = words.slice(0, -1).join(' ');
                                }
                            }
                        }
                    }
                });
                
                if (buildingName) {
                    const building = getNewBuildingTemplate(buildingName, address, city, 'passed');
                    if (manufacturer) building.details.manufacturer = manufacturer;
                    if (panelModel) building.details.panelModel = panelModel;
                    if (panelLocation) building.details.panelLocation = panelLocation;
                    if (serialNumber && serialNumber !== 'N/A') building.details.serialNumber = serialNumber;
                    if (softwareVersion && softwareVersion !== 'N/A') building.details.softwareVersion = softwareVersion;
                    if (dateManufactured && dateManufactured !== 'N/A') building.details.dateManufactured = dateManufactured;
                    if (lastServiceDate && lastServiceDate !== 'N/A') building.details.lastServiceDate = lastServiceDate;
                    buildings.push(building);
                    console.log(`üì• Parsed: ${buildingName} | Panel: ${manufacturer} ${panelModel} @ ${panelLocation}`);
                }
            } else {
                lines.filter(line => line.length > 0).forEach(line => {
                    const parts = line.includes('\\t') ? line.split('\\t') : line.split(',');
                    const name = parts[0]?.trim() || '';
                    const address = parts[1]?.trim() || '';
                    const city = parts[2]?.trim() || '';
                    if (name && name.length > 0) {
                        buildings.push(getNewBuildingTemplate(name, address, city));
                    }
                });
            }
            
            return buildings;
        };

        // List of all inspection report files in 2025 folder
        const files = [
            '2020_11_5034876_Cardston Temple_Fire Alarm System Test and Inspection Report. copy.txt',
            '2020_14_5035236_Waterton_Annual Emergency Lights Test.txt',
            '2020_20_5036828_Magrath SC_Fire Alarm System Test and Inspection Report..txt',
            '2020_32_5427320_Raymond Tay_Fire Alarm System Test and Inspection Report..txt',
            '2020_40_5036550_Fort Macleod SC_Fire Alarm System Test and Inspection Report..txt',
            '2020_42_5233208_Champion_Fire Alarm System Test and Inspection Report..txt',
            '2020_43_5035600_Claresholm_Fire Alarm System Test and Inspection Report..txt',
            '2020_44_5255112_Park Lake_Fire Alarm System Test and Inspection Report..txt',
            '2021_1_5255430_Cardston ESC_Fire Alarm System Test and Inspection Report..txt',
            '2021_2_5115485_Cardston S.Hill_Fire Alarm System Test and Inspection Report..txt',
            '2021_31_5232864_Raymond Kni_Fire Alarm System Test and Inspection Report. copy.txt',
            '2023 spring coulee.txt',
            'Alpine stables Waterton.txt',
            'Cardston west st.txt',
            'Hill spring.txt',
            'Leavitt.txt',
            'Open 2020_21_5370221_Magrath GP_Fire Alarm System Test and Inspection Report.txt',
            'Raymond seminary 3.txt',
            'Raymond stake center 2024.txt',
            'Seminary  cardston .txt',
            'Seminary magrath 2024.txt',
            'waterton opps bld fire alarm copy copy.txt'
        ];

        // Extract clean building name from filename
        const getBuildingName = (filename) => {
            return filename
                .replace(/^\\d+_\\d+_\\d+_/, '')
                .replace(/_Fire Alarm System.*\\.txt$/, '')
                .replace(/_Annual Emergency.*\\.txt$/, '')
                .replace(/\\.txt$/, '')
                .replace(/_/g, ' ')
                .trim();
        };

        // Main import function
        async function importAllBuildings() {
            const statusDiv = document.getElementById('status');
            const buildingsList = document.getElementById('buildings');
            const progressBar = document.getElementById('progress');
            const buildings = [];
            let successCount = 0;
            let failCount = 0;

            console.log(`üöÄ Starting import of ${files.length} inspection reports...`);

            for (let i = 0; i < files.length; i++) {
                const filename = files[i];
                const buildingName = getBuildingName(filename);
                const progress = Math.round(((i + 1) / files.length) * 100);
                
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
                
                statusDiv.querySelector('div:last-child').textContent = `Processing ${i + 1}/${files.length}: ${buildingName}...`;

                try {
                    const response = await fetch(`inspection-reports/2025/${encodeURIComponent(filename)}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const text = await response.text();
                    const parsed = parseImportText(text);
                    
                    if (parsed.length > 0) {
                        const building = parsed[0];
                        building.name = buildingName;
                        building.details.buildingName = buildingName;
                        buildings.push(building);
                        successCount++;
                        
                        const item = document.createElement('div');
                        item.className = 'building-item';
                        item.innerHTML = `
                            <div>
                                <strong>${i + 1}. ${buildingName}</strong>
                                <div class="panel">${building.details.manufacturer || 'No panel'} ${building.details.panelModel || ''}</div>
                            </div>
                            <span class="status success">‚úì Imported</span>
                        `;
                        buildingsList.appendChild(item);
                        
                        console.log(`‚úÖ [${i + 1}/${files.length}] ${buildingName}: ${building.details.manufacturer} ${building.details.panelModel}`);
                    } else {
                        failCount++;
                        const item = document.createElement('div');
                        item.className = 'building-item';
                        item.innerHTML = `
                            <div><strong>${i + 1}. ${buildingName}</strong></div>
                            <span class="status failed">‚úó Parse failed</span>
                        `;
                        buildingsList.appendChild(item);
                        console.warn(`‚ö†Ô∏è  [${i + 1}/${files.length}] Failed to parse: ${filename}`);
                    }
                } catch (error) {
                    failCount++;
                    const item = document.createElement('div');
                    item.className = 'building-item';
                    item.innerHTML = `
                        <div><strong>${i + 1}. ${buildingName}</strong></div>
                        <span class="status failed">‚úó Load error</span>
                    `;
                    buildingsList.appendChild(item);
                    console.error(`‚ùå [${i + 1}/${files.length}] Error loading ${filename}:`, error);
                }

                // Small delay to prevent UI freeze
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // Save to localStorage
            const saved = localStorage.getItem('fire_inspection_v4_data');
            let yearData = saved ? JSON.parse(saved) : {};
            yearData['2025'] = buildings;
            localStorage.setItem('fire_inspection_v4_data', JSON.stringify(yearData));

            // Update UI
            statusDiv.className = 'status success';
            statusDiv.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 10px;">üéâ Import Complete!</div>
                <div><strong>${successCount} buildings</strong> imported successfully</div>
                ${failCount > 0 ? `<div style="color: #dc3545; margin-top: 5px;">${failCount} files failed to import</div>` : ''}
                <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;">
                    All buildings saved to year <strong>2025</strong>. Open the app to view them!
                </div>
            `;

            buildingsList.style.display = 'block';
            document.getElementById('actions').style.display = 'block';

            console.log(`\\nüéâ Import complete: ${successCount} success, ${failCount} failed`);
        }

        // Start import after a brief delay
        setTimeout(() => {
            buildingsList.style.display = 'block';
            importAllBuildings();
        }, 500);
    </script>
</body>
</html>
